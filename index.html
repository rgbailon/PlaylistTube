<!doctype html>
<html lang="en" data-theme="light">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=5.0"
        />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>
            PlaylistTube - Free YouTube Playlist Player | Watch Ad-Free
            Playlists
        </title>

        <!-- Primary SEO Meta Tags -->
        <meta
            name="description"
            content="PlaylistTube is the ultimate free YouTube playlist player. Watch your favorite YouTube playlists ad-free, search millions of playlists, and enjoy seamless viewing across all devices. No registration, no ads, 100% free."
        />
        <meta
            name="keywords"
            content="YouTube playlist player, watch YouTube playlists, free playlist player, YouTube viewer, playlist manager, ad-free YouTube, video player, music playlist, YouTube API player, online video player, playlist organizer, YouTube alternative player, watch playlists online"
        />
        <meta name="author" content="PlaylistTube Team" />
        <meta name="creator" content="npx PlaylistTube" />
        <meta name="publisher" content="PlaylistTube" />
        <meta
            name="copyright"
            content="Â© 2024 PlaylistTube. All rights reserved."
        />

        <!-- Robots & Crawling Control -->
        <meta
            name="robots"
            content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1"
        />
        <meta name="googlebot" content="index, follow" />
        <meta name="bingbot" content="index, follow" />
        <meta name="google" content="nositelinkssearchbox, notranslate" />

        <!-- Language & Locale -->
        <meta name="language" content="English" />
        <meta http-equiv="content-language" content="en" />
        <meta name="geo.region" content="US" />
        <meta name="geo.placename" content="United States" />
        <meta name="ICBM" content="37.0902, -95.7129" />

        <!-- Document Information -->
        <meta
            name="subject"
            content="YouTube Playlist Player Web Application"
        />
        <meta
            name="classification"
            content="Multimedia, Entertainment, Technology"
        />
        <meta name="rating" content="general" />
        <meta name="target" content="all" />
        <meta name="audience" content="all" />
        <meta name="revisit-after" content="3 days" />
        <meta name="expires" content="never" />

        <!-- Mobile & App -->
        <meta
            name="theme-color"
            content="#3b82f6"
            media="(prefers-color-scheme: light)"
        />
        <meta
            name="theme-color"
            content="#1e3a5f"
            media="(prefers-color-scheme: dark)"
        />
        <meta name="msapplication-TileColor" content="#3b82f6" />
        <meta name="msapplication-TileImage" content="/ms-icon-144x144.png" />
        <meta name="msapplication-config" content="/browserconfig.xml" />
        <meta name="mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-title" content="PlaylistTube" />
        <meta
            name="apple-mobile-web-app-status-bar-style"
            content="black-translucent"
        />
        <meta name="format-detection" content="telephone=no" />

        <!-- Favicon & Icons -->
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
        <link
            rel="icon"
            type="image/png"
            sizes="16x16"
            href="/favicon-16x16.png"
        />
        <link
            rel="icon"
            type="image/png"
            sizes="32x32"
            href="/favicon-32x32.png"
        />
        <link
            rel="icon"
            type="image/png"
            sizes="96x96"
            href="/favicon-96x96.png"
        />
        <link
            rel="apple-touch-icon"
            sizes="57x57"
            href="/apple-icon-57x57.png"
        />
        <link
            rel="apple-touch-icon"
            sizes="60x60"
            href="/apple-icon-60x60.png"
        />
        <link
            rel="apple-touch-icon"
            sizes="72x72"
            href="/apple-icon-72x72.png"
        />
        <link
            rel="apple-touch-icon"
            sizes="76x76"
            href="/apple-icon-76x76.png"
        />
        <link
            rel="apple-touch-icon"
            sizes="114x114"
            href="/apple-icon-114x114.png"
        />
        <link
            rel="apple-touch-icon"
            sizes="120x120"
            href="/apple-icon-120x120.png"
        />
        <link
            rel="apple-touch-icon"
            sizes="144x144"
            href="/apple-icon-144x144.png"
        />
        <link
            rel="apple-touch-icon"
            sizes="152x152"
            href="/apple-icon-152x152.png"
        />
        <link
            rel="apple-touch-icon"
            sizes="180x180"
            href="/apple-icon-180x180.png"
        />
        <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#3b82f6" />

        <!-- Manifest -->
        <link rel="manifest" href="/manifest.json" />

        <!-- Open Graph / Facebook -->
        <meta property="og:type" content="website" />
        <meta property="og:locale" content="en_US" />
        <meta
            property="og:title"
            content="PlaylistTube - Free YouTube Playlist Player"
        />
        <meta
            property="og:description"
            content="Watch YouTube playlists ad-free. Search millions of playlists, enjoy seamless viewing on all devices. No registration required. 100% free."
        />
        <meta property="og:site_name" content="PlaylistTube" />
        <meta property="og:determiner" content="the" />

        <!-- Twitter Card -->
        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:site" content="@playlisttube" />
        <meta name="twitter:creator" content="@playlisttube" />
        <meta
            name="twitter:title"
            content="PlaylistTube - Free YouTube Playlist Player"
        />
        <meta
            name="twitter:description"
            content="Watch YouTube playlists ad-free. Search millions of playlists, enjoy seamless viewing. No registration required."
        />
        <meta name="twitter:app:name:iphone" content="PlaylistTube" />
        <meta name="twitter:app:name:ipad" content="PlaylistTube" />
        <meta name="twitter:app:name:googleplay" content="PlaylistTube" />

        <!-- Performance & Security -->
        <meta name="referrer" content="strict-origin-when-cross-origin" />
        <meta http-equiv="x-dns-prefetch-control" content="on" />
        <meta
            http-equiv="Permissions-Policy"
            content="geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), gyroscope=(), speaker=(self)"
        />

        <!-- Prefetch & Preconnect -->
        <link rel="dns-prefetch" href="https://www.youtube.com" />
        <link rel="dns-prefetch" href="https://img.youtube.com" />
        <link rel="dns-prefetch" href="https://fonts.googleapis.com" />
        <link rel="dns-prefetch" href="https://fonts.gstatic.com" />
        <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com" />
        <link
            rel="preconnect"
            href="https://fonts.googleapis.com"
            crossorigin
        />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            rel="preconnect"
            href="https://cdnjs.cloudflare.com"
            crossorigin
        />

        <!-- Alternate Languages -->
        <link rel="alternate" hreflang="en" href="https://playlisttube.com" />
        <link
            rel="alternate"
            hreflang="x-default"
            href="https://playlisttube.com"
        />

        <!-- Navigation -->
        <link rel="index" title="Home" href="/" />
        <link rel="search" title="Search" href="/?search" />
        <link rel="help" title="Help" href="/help" />

        <!-- Structured Data - WebApplication -->
        <script type="application/ld+json">
            {
                "@context": "https://schema.org",
                "@type": "WebApplication",
                "name": "PlaylistTube",
                "alternateName": "YouTube Playlist Player",
                "description": "Free YouTube Playlist Player - Watch playlists ad-free, search millions of playlists, enjoy seamless viewing on all devices",
                "url": "https://playlisttube.com",
                "applicationCategory": "MultimediaApplication",
                "applicationSubCategory": "Video Player",
                "operatingSystem": "Windows, macOS, Linux, iOS, Android, Chrome OS",
                "softwareVersion": "1.0.0",
                "inLanguage": "en",
                "offers": {
                    "@type": "Offer",
                    "price": "0",
                    "priceCurrency": "USD",
                    "availability": "https://schema.org/InStock"
                },
                "aggregateRating": {
                    "@type": "AggregateRating",
                    "ratingValue": "4.8",
                    "ratingCount": "1250",
                    "bestRating": "5",
                    "worstRating": "1"
                },
                "featureList": [
                    "YouTube playlist playback",
                    "Playlist search functionality",
                    "Multiple theme options (16+ themes)",
                    "Mobile responsive design",
                    "No registration required",
                    "Ad-free viewing experience",
                    "Live stream support",
                    "Live chat integration",
                    "API key rotation",
                    "Quota tracking"
                ],
                "screenshot": "https://playlisttube.com/screenshot.jpg",
                "softwareHelp": {
                    "@type": "CreativeWork",
                    "name": "PlaylistTube Help Documentation"
                }
            }
        </script>

        <!-- Structured Data - Organization -->
        <script type="application/ld+json">
            {
                "@context": "https://schema.org",
                "@type": "Organization",
                "name": "PlaylistTube",
                "alternateName": "YouTube Playlist Player",
                "url": "https://playlisttube.com",
                "logo": "https://playlisttube.com/logo.png",
                "sameAs": [
                    "https://github.com/rgbailon/PlaylistTube",
                    "https://twitter.com/playlisttube"
                ],
                "contactPoint": {
                    "@type": "ContactPoint",
                    "contactType": "customer support",
                    "availableLanguage": "English"
                }
            }
        </script>

        <!-- Structured Data - Website -->
        <script type="application/ld+json">
            {
                "@context": "https://schema.org",
                "@type": "WebSite",
                "name": "PlaylistTube",
                "alternateName": "YouTube Playlist Player",
                "url": "https://playlisttube.com",
                "potentialAction": {
                    "@type": "SearchAction",
                    "target": {
                        "@type": "EntryPoint",
                        "urlTemplate": "https://playlisttube.com/?search&q={search_term_string}"
                    },
                    "query-input": "required name=search_term_string"
                },
                "inLanguage": "en"
            }
        </script>

        <!-- Structured Data - Software Source Code -->
        <script type="application/ld+json">
            {
                "@context": "https://schema.org",
                "@type": "SoftwareSourceCode",
                "name": "PlaylistTube",
                "codeRepository": "https://github.com/rgbailon/PlaylistTube",
                "programmingLanguage": "HTML, CSS, JavaScript",
                "runtimePlatform": "Web Browser",
                "targetProduct": {
                    "@type": "SoftwareApplication",
                    "name": "PlaylistTube",
                    "applicationCategory": "MultimediaApplication"
                },
                "license": "https://github.com/rgbailon/PlaylistTube/blob/main/LICENSE"
            }
        </script>

        <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@500;600;700&display=swap"
            rel="stylesheet"
        />
        <style>
            :root {
                /* Minimalist Theme (Default) - Clean, lots of white space */
                --bg-main: #fafafa;
                --bg-card: #ffffff;
                --bg-glass: rgba(255, 255, 255, 0.95);
                --bg-hover: #f5f5f5;
                --bg-active: #f0f0f0;
                --text-main: #171717;
                --text-muted: #737373;
                --border-color: #e5e5e5;
                --border-hover: #d4d4d4;
                --accent-color: #171717;
                --accent-hover: #404040;
                --accent-bg: #f5f5f5;
                --accent-border: #d4d4d4;
                --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.03);
                --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
                --scrollbar-thumb: #d4d4d4;
                --scrollbar-track: transparent;
            }

            /* Bold & Colorful Theme - Vibrant palettes, eye-catching */
            [data-theme="bold"] {
                --bg-main: #0a0a0a;
                --bg-card: #171717;
                --bg-glass: rgba(23, 23, 23, 0.95);
                --bg-hover: #262626;
                --bg-active: #404040;
                --text-main: #ffffff;
                --text-muted: #a3a3a3;
                --border-color: #404040;
                --border-hover: #525252;
                --accent-color: #22d3ee;
                --accent-hover: #67e8f9;
                --accent-bg: rgba(34, 211, 238, 0.15);
                --accent-border: #06b6d4;
                --shadow-sm: 0 0 10px rgba(236, 72, 153, 0.3);
                --shadow-md: 0 0 20px rgba(168, 85, 247, 0.4);
                --scrollbar-thumb: #ec4899;
                --scrollbar-track: #0a0a0a;
            }

            [data-theme="bold"] .nav-btn.active,
            [data-theme="bold"] .mobile-tab.active {
                background: linear-gradient(
                    135deg,
                    #ec4899 0%,
                    #a855f7 50%,
                    #06b6d4 100%
                ) !important;
                color: white !important;
                border: none !important;
            }

            /* Dark Mode Theme - Sleek, modern, easy on eyes */
            [data-theme="dark"] {
                --bg-main: #0f172a;
                --bg-card: #1e293b;
                --bg-glass: rgba(30, 41, 59, 0.95);
                --bg-hover: #334155;
                --bg-active: #475569;
                --text-main: #f1f5f9;
                --text-muted: #94a3b8;
                --border-color: #334155;
                --border-hover: #475569;
                --accent-color: #60a5fa;
                --accent-hover: #93c5fd;
                --accent-bg: rgba(96, 165, 250, 0.1);
                --accent-border: #3b82f6;
                --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
                --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
                --scrollbar-thumb: #475569;
                --scrollbar-track: #0f172a;
            }

            /* Retro/Vintage Theme - Nostalgic design elements */
            [data-theme="retro"] {
                --bg-main: #fdf6e3;
                --bg-card: #fefcf6;
                --bg-glass: rgba(253, 246, 227, 0.95);
                --bg-hover: #f5edd6;
                --bg-active: #ede4c9;
                --text-main: #5c4a32;
                --text-muted: #8b7355;
                --border-color: #d4c4a8;
                --border-hover: #c4b393;
                --accent-color: #b85c38;
                --accent-hover: #a04a2a;
                --accent-bg: rgba(184, 92, 56, 0.1);
                --accent-border: #c4a77d;
                --shadow-sm: 2px 2px 4px rgba(92, 74, 50, 0.1);
                --shadow-md: 4px 4px 8px rgba(92, 74, 50, 0.15);
                --scrollbar-thumb: #c4a77d;
                --scrollbar-track: #fdf6e3;
            }

            /* Illustrated/Cartoon Theme - Playful, hand-drawn feel */
            [data-theme="cartoon"] {
                --bg-main: #fff8f0;
                --bg-card: #ffffff;
                --bg-glass: #ffffff;
                --bg-hover: #fff0e6;
                --bg-active: #ffe4d6;
                --text-main: #2d2d2d;
                --text-muted: #666666;
                --border-color: #2d2d2d;
                --border-hover: #1a1a1a;
                --accent-color: #ff6b6b;
                --accent-hover: #ee5a5a;
                --accent-bg: #fff0f0;
                --accent-border: #2d2d2d;
                --shadow-sm: 3px 3px 0px 0px #2d2d2d;
                --shadow-md: 5px 5px 0px 0px #2d2d2d;
                --scrollbar-thumb: #2d2d2d;
                --scrollbar-track: #fff8f0;
            }

            [data-theme="cartoon"] .glass,
            [data-theme="cartoon"] .input-styled,
            [data-theme="cartoon"] .player-container,
            [data-theme="cartoon"] .video-item,
            [data-theme="cartoon"] .nav-btn,
            [data-theme="cartoon"] .theme-dropdown-content,
            [data-theme="cartoon"] .mobile-tab {
                border-width: 2px !important;
                border-radius: 8px !important;
            }

            /* Photography Theme - Large focus on media content */
            [data-theme="photo"] {
                --bg-main: #000000;
                --bg-card: #0a0a0a;
                --bg-glass: rgba(10, 10, 10, 0.9);
                --bg-hover: #1a1a1a;
                --bg-active: #262626;
                --text-main: #e5e5e5;
                --text-muted: #737373;
                --border-color: #262626;
                --border-hover: #404040;
                --accent-color: #ffffff;
                --accent-hover: #e5e5e5;
                --accent-bg: rgba(255, 255, 255, 0.05);
                --accent-border: #404040;
                --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.5);
                --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.7);
                --scrollbar-thumb: #404040;
                --scrollbar-track: #000000;
            }

            [data-theme="photo"] .player-container {
                border: none !important;
                box-shadow: 0 0 60px rgba(255, 255, 255, 0.05) !important;
            }

            /* Forest Theme (Green/Nature) */
            [data-theme="forest"] {
                --bg-main: #14281d;
                --bg-card: #1e392a;
                --bg-glass: rgba(30, 57, 42, 0.95);
                --bg-hover: #2a4c38;
                --bg-active: #355e46;
                --text-main: #e8f5e9;
                --text-muted: #a5d6a7;
                --border-color: #2a4c38;
                --border-hover: #355e46;
                --accent-color: #4ade80;
                --accent-hover: #86efac;
                --accent-bg: rgba(74, 222, 128, 0.15);
                --accent-border: #22c55e;
                --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
                --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.5);
                --scrollbar-thumb: #22c55e;
                --scrollbar-track: #14281d;
            }

            /* Ocean Theme (Deep Teal) */
            [data-theme="ocean"] {
                --bg-main: #0c4a6e;
                --bg-card: #075985;
                --bg-glass: rgba(7, 89, 133, 0.95);
                --bg-hover: #0369a1;
                --bg-active: #0284c7;
                --text-main: #f0f9ff;
                --text-muted: #bae6fd;
                --border-color: #0369a1;
                --border-hover: #0284c7;
                --accent-color: #38bdf8;
                --accent-hover: #7dd3fc;
                --accent-bg: rgba(56, 189, 248, 0.15);
                --accent-border: #0ea5e9;
                --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
                --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.5);
                --scrollbar-thumb: #0ea5e9;
                --scrollbar-track: #0c4a6e;
            }

            /* Sunset Theme (Warm Purple/Pink) */
            [data-theme="sunset"] {
                --bg-main: #4a044e;
                --bg-card: #701a75;
                --bg-glass: rgba(112, 26, 117, 0.95);
                --bg-hover: #86198f;
                --bg-active: #a21caf;
                --text-main: #fdf4ff;
                --text-muted: #f5d0fe;
                --border-color: #86198f;
                --border-hover: #a21caf;
                --accent-color: #fca5a5;
                --accent-hover: #fcd34d;
                --accent-bg: rgba(252, 165, 165, 0.15);
                --accent-border: #f87171;
                --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
                --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.5);
                --scrollbar-thumb: #f87171;
                --scrollbar-track: #4a044e;
            }

            /* Cyber Theme (Neon Green/Black) */
            [data-theme="cyber"] {
                --bg-main: #000000;
                --bg-card: #0a0a0a;
                --bg-glass: rgba(10, 10, 10, 0.95);
                --bg-hover: #111111;
                --bg-active: #1a1a1a;
                --text-main: #00ff00;
                --text-muted: #00aa00;
                --border-color: #003300;
                --border-hover: #004400;
                --accent-color: #00ff00;
                --accent-hover: #33ff33;
                --accent-bg: rgba(0, 255, 0, 0.1);
                --accent-border: #00ff00;
                --shadow-sm: 0 0 5px #00ff00;
                --shadow-md: 0 0 15px #00ff00;
                --scrollbar-thumb: #00ff00;
                --scrollbar-track: #000000;
            }

            /* Coffee Theme (Warm Brown) */
            [data-theme="coffee"] {
                --bg-main: #271c19;
                --bg-card: #3c2a25;
                --bg-glass: rgba(60, 42, 37, 0.95);
                --bg-hover: #4e362e;
                --bg-active: #5d4037;
                --text-main: #d7ccc8;
                --text-muted: #a1887f;
                --border-color: #4e362e;
                --border-hover: #5d4037;
                --accent-color: #d7ccc8;
                --accent-hover: #efebe9;
                --accent-bg: rgba(215, 204, 200, 0.15);
                --accent-border: #8d6e63;
                --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
                --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.5);
                --scrollbar-thumb: #8d6e63;
                --scrollbar-track: #271c19;
            }

            /* Netflix Theme (Dark with Red Accents) */
            [data-theme="netflix"] {
                --bg-main: #141414;
                --bg-card: #1f1f1f;
                --bg-glass: rgba(31, 31, 31, 0.98);
                --bg-hover: #2a2a2a;
                --bg-active: #333333;
                --text-main: #ffffff;
                --text-muted: #b3b3b3;
                --border-color: #2a2a2a;
                --border-hover: #404040;
                --accent-color: #e50914;
                --accent-hover: #f40612;
                --accent-bg: rgba(229, 9, 20, 0.15);
                --accent-border: #b20710;
                --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.5);
                --shadow-md: 0 8px 16px rgba(0, 0, 0, 0.7);
                --scrollbar-thumb: #e50914;
                --scrollbar-track: #141414;
            }

            /* Netflix theme special hover effects */
            [data-theme="netflix"] .video-item:hover {
                transform: scale(1.02);
                box-shadow: 0 4px 20px rgba(229, 9, 20, 0.3);
            }

            [data-theme="netflix"] .player-container {
                border: none;
                box-shadow: 0 0 40px rgba(229, 9, 20, 0.2);
            }

            [data-theme="netflix"] .nav-btn.active {
                background: linear-gradient(135deg, #e50914 0%, #b20710 100%);
                color: white;
                border: none;
            }

            [data-theme="netflix"] .mobile-tab.active {
                background: linear-gradient(135deg, #e50914 0%, #b20710 100%);
                color: white;
            }

            [data-theme="netflix"] .btn-add {
                background: linear-gradient(135deg, #e50914 0%, #b20710 100%);
            }

            [data-theme="netflix"] .btn-add:hover {
                background: linear-gradient(135deg, #f40612 0%, #e50914 100%);
                box-shadow: 0 4px 15px rgba(229, 9, 20, 0.4);
            }

            * {
                font-family: "Helvetica Neue", "Inter", sans-serif;
                transition:
                    background-color 0.3s ease,
                    border-color 0.3s ease,
                    color 0.3s ease;
            }

            h1,
            h2,
            h3,
            h4,
            h5,
            h6 {
                font-family: "Outfit", sans-serif;
            }

            body {
                background-color: var(--bg-main);
                color: var(--text-main);
                min-height: 100vh;
            }

            /* Custom Scrollbar */
            .scrollbar-thin::-webkit-scrollbar {
                width: 6px;
            }
            .scrollbar-thin::-webkit-scrollbar-track {
                background: var(--scrollbar-track);
            }
            .scrollbar-thin::-webkit-scrollbar-thumb {
                background: var(--scrollbar-thumb);
                border-radius: 10px;
            }
            .scrollbar-thin::-webkit-scrollbar-thumb:hover {
                background: var(--text-muted);
            }

            /* Active Video Item */
            .video-item.active {
                background: var(--accent-bg);
                border: 1px solid var(--accent-border);
                box-shadow: var(--shadow-sm);
            }

            /* Glass/Card Styles */
            .glass {
                background: var(--bg-card);
                border: 1px solid var(--border-color);
                box-shadow: var(--shadow-sm);
            }

            .glass-darker {
                background: var(--bg-glass);
                backdrop-filter: blur(12px);
                -webkit-backdrop-filter: blur(12px);
                border-bottom: 1px solid var(--border-color);
            }

            /* Button Hover Effects */
            .btn-hover {
                transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            }

            .btn-hover:hover {
                transform: translateY(-1px);
                box-shadow: var(--shadow-md);
            }

            /* Card Hover Effects */
            .card-hover {
                transition: all 0.2s ease;
            }

            .card-hover:hover {
                background: var(--bg-hover);
                border-color: var(--border-hover);
            }

            /* Video Player Container - Glass thin glowing border */
            .player-container {
                background: #000;
                border-radius: 16px;
                overflow: hidden;
                border: 1px solid rgba(255, 255, 255, 0.2);
                box-shadow:
                    0 0 0 1px rgba(255, 255, 255, 0.1),
                    0 0 20px rgba(255, 255, 255, 0.1),
                    0 4px 30px rgba(0, 0, 0, 0.3);
                transition: all 0.3s ease;
                min-height: 200px; /* Ensure minimum height on small screens */
            }

            .player-container:hover {
                box-shadow:
                    0 0 0 1px rgba(255, 255, 255, 0.2),
                    0 0 30px rgba(255, 255, 255, 0.15),
                    0 4px 40px rgba(0, 0, 0, 0.4);
            }

            /* Responsive video player for small screens */
            @media (max-width: 768px) {
                .player-container {
                    min-height: 180px;
                    aspect-ratio: 16/9 !important;
                }

                #player-wrapper {
                    min-height: 180px;
                }
            }

            @media (max-width: 480px) {
                .player-container {
                    min-height: 150px;
                }

                #player-wrapper {
                    min-height: 150px;
                }
            }

            /* Theme-specific player glass glow effects */
            [data-theme="light"] .player-container {
                border-color: rgba(59, 130, 246, 0.3);
                box-shadow:
                    0 0 0 1px rgba(59, 130, 246, 0.2),
                    0 0 25px rgba(59, 130, 246, 0.15),
                    0 4px 30px rgba(0, 0, 0, 0.2);
            }

            [data-theme="light"] .player-container:hover {
                box-shadow:
                    0 0 0 1px rgba(59, 130, 246, 0.3),
                    0 0 35px rgba(59, 130, 246, 0.25),
                    0 4px 40px rgba(0, 0, 0, 0.25);
            }

            [data-theme="dark"] .player-container {
                border-color: rgba(96, 165, 250, 0.4);
                box-shadow:
                    0 0 0 1px rgba(96, 165, 250, 0.2),
                    0 0 25px rgba(96, 165, 250, 0.2),
                    0 4px 30px rgba(0, 0, 0, 0.4);
            }

            [data-theme="dark"] .player-container:hover {
                box-shadow:
                    0 0 0 1px rgba(96, 165, 250, 0.4),
                    0 0 40px rgba(96, 165, 250, 0.3),
                    0 4px 40px rgba(0, 0, 0, 0.5);
            }

            [data-theme="bold"] .player-container {
                border-color: rgba(124, 58, 237, 0.5);
                box-shadow:
                    0 0 0 1px rgba(124, 58, 237, 0.3),
                    0 0 30px rgba(124, 58, 237, 0.25),
                    0 4px 30px rgba(0, 0, 0, 0.3);
            }

            [data-theme="bold"] .player-container:hover {
                box-shadow:
                    0 0 0 1px rgba(124, 58, 237, 0.5),
                    0 0 45px rgba(124, 58, 237, 0.35),
                    0 4px 40px rgba(0, 0, 0, 0.4);
            }

            [data-theme="retro"] .player-container {
                border-color: rgba(234, 179, 8, 0.4);
                box-shadow:
                    0 0 0 1px rgba(234, 179, 8, 0.2),
                    0 0 25px rgba(234, 179, 8, 0.2),
                    0 4px 30px rgba(0, 0, 0, 0.3);
            }

            [data-theme="retro"] .player-container:hover {
                box-shadow:
                    0 0 0 1px rgba(234, 179, 8, 0.4),
                    0 0 35px rgba(234, 179, 8, 0.3),
                    0 4px 40px rgba(0, 0, 0, 0.35);
            }

            [data-theme="cartoon"] .player-container {
                border: 3px solid rgba(0, 0, 0, 0.8);
                box-shadow:
                    4px 4px 0px 0px rgba(0, 0, 0, 0.8),
                    0 0 20px rgba(0, 0, 0, 0.2);
            }

            [data-theme="photo"] .player-container {
                border-color: rgba(255, 255, 255, 0.25);
                box-shadow:
                    0 0 0 1px rgba(255, 255, 255, 0.15),
                    0 0 30px rgba(255, 255, 255, 0.1),
                    0 8px 40px rgba(0, 0, 0, 0.3);
            }

            [data-theme="photo"] .player-container:hover {
                box-shadow:
                    0 0 0 1px rgba(255, 255, 255, 0.25),
                    0 0 40px rgba(255, 255, 255, 0.15),
                    0 8px 50px rgba(0, 0, 0, 0.4);
            }

            [data-theme="forest"] .player-container {
                border-color: rgba(16, 185, 129, 0.4);
                box-shadow:
                    0 0 0 1px rgba(16, 185, 129, 0.2),
                    0 0 25px rgba(16, 185, 129, 0.2),
                    0 4px 30px rgba(0, 0, 0, 0.3);
            }

            [data-theme="forest"] .player-container:hover {
                box-shadow:
                    0 0 0 1px rgba(16, 185, 129, 0.4),
                    0 0 35px rgba(16, 185, 129, 0.3),
                    0 4px 40px rgba(0, 0, 0, 0.35);
            }

            [data-theme="ocean"] .player-container {
                border-color: rgba(6, 182, 212, 0.4);
                box-shadow:
                    0 0 0 1px rgba(6, 182, 212, 0.2),
                    0 0 25px rgba(6, 182, 212, 0.2),
                    0 4px 30px rgba(0, 0, 0, 0.3);
            }

            [data-theme="ocean"] .player-container:hover {
                box-shadow:
                    0 0 0 1px rgba(6, 182, 212, 0.4),
                    0 0 35px rgba(6, 182, 212, 0.3),
                    0 4px 40px rgba(0, 0, 0, 0.35);
            }

            [data-theme="sunset"] .player-container {
                border-color: rgba(249, 115, 22, 0.4);
                box-shadow:
                    0 0 0 1px rgba(249, 115, 22, 0.2),
                    0 0 25px rgba(249, 115, 22, 0.2),
                    0 4px 30px rgba(0, 0, 0, 0.3);
            }

            [data-theme="sunset"] .player-container:hover {
                box-shadow:
                    0 0 0 1px rgba(249, 115, 22, 0.4),
                    0 0 35px rgba(249, 115, 22, 0.3),
                    0 4px 40px rgba(0, 0, 0, 0.35);
            }

            [data-theme="cyber"] .player-container {
                border-color: rgba(0, 255, 157, 0.5);
                box-shadow:
                    0 0 0 1px rgba(0, 255, 157, 0.3),
                    0 0 30px rgba(0, 255, 157, 0.25),
                    0 0 60px rgba(0, 255, 157, 0.1),
                    0 4px 30px rgba(0, 0, 0, 0.4);
            }

            [data-theme="cyber"] .player-container:hover {
                box-shadow:
                    0 0 0 1px rgba(0, 255, 157, 0.5),
                    0 0 40px rgba(0, 255, 157, 0.4),
                    0 0 80px rgba(0, 255, 157, 0.2),
                    0 4px 40px rgba(0, 0, 0, 0.5);
            }

            [data-theme="coffee"] .player-container {
                border-color: rgba(180, 83, 9, 0.4);
                box-shadow:
                    0 0 0 1px rgba(180, 83, 9, 0.2),
                    0 0 25px rgba(180, 83, 9, 0.15),
                    0 4px 30px rgba(0, 0, 0, 0.3);
            }

            [data-theme="coffee"] .player-container:hover {
                box-shadow:
                    0 0 0 1px rgba(180, 83, 9, 0.4),
                    0 0 35px rgba(180, 83, 9, 0.25),
                    0 4px 40px rgba(0, 0, 0, 0.35);
            }

            [data-theme="netflix"] .player-container {
                border-color: rgba(229, 9, 20, 0.5);
                box-shadow:
                    0 0 0 1px rgba(229, 9, 20, 0.3),
                    0 0 30px rgba(229, 9, 20, 0.25),
                    0 4px 30px rgba(0, 0, 0, 0.4);
            }

            [data-theme="netflix"] .player-container:hover {
                box-shadow:
                    0 0 0 1px rgba(229, 9, 20, 0.5),
                    0 0 45px rgba(229, 9, 20, 0.35),
                    0 4px 40px rgba(0, 0, 0, 0.5);
            }

            [data-theme="pink"] .player-container {
                border-color: rgba(236, 72, 153, 0.4);
                box-shadow:
                    0 0 0 1px rgba(236, 72, 153, 0.2),
                    0 0 25px rgba(236, 72, 153, 0.2),
                    0 4px 30px rgba(0, 0, 0, 0.3);
            }

            [data-theme="pink"] .player-container:hover {
                box-shadow:
                    0 0 0 1px rgba(236, 72, 153, 0.4),
                    0 0 35px rgba(236, 72, 153, 0.3),
                    0 4px 40px rgba(0, 0, 0, 0.35);
            }

            [data-theme="purple"] .player-container {
                border-color: rgba(168, 85, 247, 0.4);
                box-shadow:
                    0 0 0 1px rgba(168, 85, 247, 0.2),
                    0 0 25px rgba(168, 85, 247, 0.2),
                    0 4px 30px rgba(0, 0, 0, 0.3);
            }

            [data-theme="purple"] .player-container:hover {
                box-shadow:
                    0 0 0 1px rgba(168, 85, 247, 0.4),
                    0 0 35px rgba(168, 85, 247, 0.3),
                    0 4px 40px rgba(0, 0, 0, 0.35);
            }

            [data-theme="red"] .player-container {
                border-color: rgba(239, 68, 68, 0.4);
                box-shadow:
                    0 0 0 1px rgba(239, 68, 68, 0.2),
                    0 0 25px rgba(239, 68, 68, 0.2),
                    0 4px 30px rgba(0, 0, 0, 0.3);
            }

            [data-theme="red"] .player-container:hover {
                box-shadow:
                    0 0 0 1px rgba(239, 68, 68, 0.4),
                    0 0 35px rgba(239, 68, 68, 0.3),
                    0 4px 40px rgba(0, 0, 0, 0.35);
            }

            [data-theme="gray"] .player-container {
                border-color: rgba(161, 161, 170, 0.4);
                box-shadow:
                    0 0 0 1px rgba(161, 161, 170, 0.2),
                    0 0 25px rgba(161, 161, 170, 0.15),
                    0 4px 30px rgba(0, 0, 0, 0.3);
            }

            [data-theme="gray"] .player-container:hover {
                box-shadow:
                    0 0 0 1px rgba(161, 161, 170, 0.4),
                    0 0 35px rgba(161, 161, 170, 0.25),
                    0 4px 40px rgba(0, 0, 0, 0.35);
            }

            /* Input Fields */
            .input-styled {
                background: var(--bg-main);
                border: 1px solid var(--border-color);
                color: var(--text-main);
                caret-color: var(--text-main);
                transition: all 0.2s ease;
            }

            .input-styled:focus {
                background: var(--bg-card);
                border-color: var(--accent-color);
                box-shadow: 0 0 0 2px var(--accent-bg);
                outline: none;
            }

            .input-styled::placeholder {
                color: var(--text-muted);
            }

            /* All dark themes - ensure proper contrast */
            [data-theme="dark"] .input-styled,
            [data-theme="bold"] .input-styled,
            [data-theme="photo"] .input-styled,
            [data-theme="forest"] .input-styled,
            [data-theme="ocean"] .input-styled,
            [data-theme="sunset"] .input-styled,
            [data-theme="cyber"] .input-styled,
            [data-theme="coffee"] .input-styled {
                background: rgba(0, 0, 0, 0.3);
            }

            [data-theme="dark"] .input-styled:focus,
            [data-theme="bold"] .input-styled:focus,
            [data-theme="photo"] .input-styled:focus,
            [data-theme="forest"] .input-styled:focus,
            [data-theme="ocean"] .input-styled:focus,
            [data-theme="sunset"] .input-styled:focus,
            [data-theme="cyber"] .input-styled:focus,
            [data-theme="coffee"] .input-styled:focus {
                background: var(--bg-card);
            }

            /* WebKit autofill handling for dark themes */
            [data-theme="dark"] .input-styled:-webkit-autofill,
            [data-theme="bold"] .input-styled:-webkit-autofill,
            [data-theme="photo"] .input-styled:-webkit-autofill,
            [data-theme="cyber"] .input-styled:-webkit-autofill {
                -webkit-text-fill-color: var(--text-main);
                -webkit-box-shadow: 0 0 0px 1000px var(--bg-card) inset;
                caret-color: var(--text-main);
            }

            /* Mobile sidebar styles */
            .mobile-sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                background: var(--bg-card);
                border-right: 1px solid var(--border-color);
            }
            .mobile-sidebar.open {
                transform: translateX(0);
            }
            .mobile-video-list {
                transform: translateX(100%);
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                background: var(--bg-card);
                border-left: 1px solid var(--border-color);
            }
            .mobile-video-list.open {
                transform: translateX(0);
            }
            .overlay {
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.3s ease;
                background: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(2px);
                z-index: 35; /* Lower than chatbot */
            }
            .overlay.open {
                opacity: 1;
                pointer-events: auto;
            }

            /* Mobile tab styles */
            .mobile-tab {
                transition: all 0.2s ease;
                background: var(--bg-card);
                color: var(--text-muted);
                border-top: 1px solid var(--border-color);
                z-index: 35; /* Lower than chatbot */
            }
            .mobile-tab.active {
                background: var(--bg-hover);
                color: var(--accent-color);
            }

            /* Nav button active */
            .nav-btn {
                color: var(--text-muted);
                background: transparent;
            }
            .nav-btn:hover {
                background: var(--bg-hover);
                color: var(--text-main);
            }
            .nav-btn.active {
                background: var(--accent-bg);
                color: var(--accent-color);
                font-weight: 600;
                border: 1px solid var(--accent-border);
            }

            /* Thumbnail Overlay */
            .thumbnail-overlay {
                position: absolute;
                inset: 0;
                background: rgba(0, 0, 0, 0.05);
                transition: opacity 0.2s ease;
            }

            .video-item:hover .thumbnail-overlay {
                opacity: 0;
            }

            /* Collapsible Animation */
            .collapse-content {
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                display: none;
            }

            .collapse-content.open {
                max-height: 2000px;
                display: block;
            }

            /* Playlist History - Auto Scrollable */
            #playlist-history,
            #playlist-history-mobile {
                flex-grow: 1 !important;
                overflow-y: auto !important;
                overflow-x: hidden !important;
            }

            /* Sidebar needs explicit height */
            #playlist-history-sidebar {
                height: 100% !important;
            }

            /* Mobile sidebar height */
            #mobile-history-sidebar {
                height: calc(100vh - 65px - 64px) !important;
            }

            /* Collapsed sidebar styles */
            #playlist-history-sidebar {
                transition: all 0.3s ease;
                width: 18rem;
                flex-shrink: 0;
                z-index: 20;
            }

            #playlist-history-sidebar.collapsed {
                width: 40px;
                overflow: hidden;
                flex-shrink: 0;
                height: 100%;
            }

            /* When sidebar is collapsed within main-page, ensure full height */
            #main-page #playlist-history-sidebar.collapsed {
                height: 100%;
            }

            /* Hide wrapper content when collapsed */
            #playlist-history-sidebar.collapsed > div:first-child {
                display: none;
            }

            /* Show only the toggle button when collapsed */
            #playlist-history-sidebar.collapsed > .collapsed-toggle-btn {
                display: flex !important;
            }

            /* Hide collapsed toggle button when NOT collapsed (i.e., when expanded) */
            #playlist-history-sidebar:not(.collapsed) > .collapsed-toggle-btn {
                display: none !important;
            }

            /* Center collapsed toggle button */
            #playlist-history-sidebar.collapsed > .collapsed-toggle-btn {
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
                height: calc(100% - 60px);
                width: 100%;
            }

            #playlist-history-sidebar.collapsed > .collapsed-toggle-btn button {
                margin: auto;
            }

            /* Adjust the main content when sidebar is collapsed */
            #main-page.sidebar-collapsed {
                margin-left: 0;
            }

            /* Make player full width when sidebar is collapsed */
            #main-page.sidebar-collapsed #player-wrapper {
                width: 100% !important;
                max-width: 100% !important;
                height: 100% !important;
                min-height: 100% !important;
                position: relative !important;
                overflow: visible !important;
            }

            /* Make player container visible when collapsed */
            #main-page.sidebar-collapsed .player-container {
                overflow: visible !important;
                height: 100% !important;
            }

            /* Ensure fullscreen button is visible when collapsed */
            #main-page.sidebar-collapsed #fullscreen-btn {
                z-index: 10 !important;
                opacity: 1 !important;
                visibility: visible !important;
            }

            /* Remove scroll from video player when sidebar is collapsed */
            #main-page.sidebar-collapsed #video-chat-scroll-container {
                overflow: visible !important;
                height: 100% !important;
                max-height: none !important;
                display: flex !important;
                flex-direction: column !important;
            }

            /* Make video chat wrapper full height when collapsed */
            #main-page.sidebar-collapsed #video-chat-wrapper {
                height: 100% !important;
                min-height: 100% !important;
            }

            /* Make main content full height when collapsed */
            #main-page.sidebar-collapsed + #main-content,
            #main-page.sidebar-collapsed ~ main#main-content {
                height: 100% !important;
            }

            /* Hide settings button when collapsed */
            #playlist-history-sidebar.collapsed .border-t.border-custom {
                display: none !important;
            }

            /* Hide settings dock host when collapsed */
            #playlist-history-sidebar.collapsed #settings-dock-host-desktop {
                display: none !important;
            }

            /* Settings dock host needs relative positioning */
            #settings-dock-host-desktop {
                position: relative;
            }

            #settings-dock-host-mobile {
                position: relative;
            }

            /* Adjust toggle button when sidebar is collapsed */
            #playlist-history-sidebar.collapsed #history-toggle-icon {
                position: static;
                transform: none;
            }

            /* Status Indicator */
            @keyframes pulse-dot {
                0% {
                    box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4);
                }
                70% {
                    box-shadow: 0 0 0 4px rgba(34, 197, 94, 0);
                }
                100% {
                    box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);
                }
            }
            .status-indicator {
                animation: pulse-dot 2s infinite;
            }

            /* Theme Toggle Button */
            .theme-toggle {
                cursor: pointer;
                padding: 0.5rem;
                border-radius: 9999px;
                color: var(--text-muted);
                background: var(--bg-hover);
                border: 1px solid var(--border-color);
                transition: all 0.2s ease;
            }
            .theme-toggle:hover {
                color: var(--accent-color);
                border-color: var(--accent-color);
            }

            /* Theme Dropdown */
            .theme-dropdown {
                position: relative;
                display: inline-block;
            }
            .theme-dropdown-content {
                display: none;
                position: absolute;
                right: 0;
                top: 100%;
                margin-top: 0.5rem;
                background: var(--bg-card);
                border: 1px solid var(--border-color);
                border-radius: 0.75rem;
                box-shadow: var(--shadow-md);
                min-width: 140px;
                z-index: 100;
                overflow: hidden;
            }
            .theme-dropdown-content.show {
                display: block;
            }
            .theme-option {
                display: flex;
                align-items: center;
                gap: 0.75rem;
                padding: 0.75rem 1rem;
                cursor: pointer;
                transition: all 0.15s ease;
                color: var(--text-main);
                font-size: 0.875rem;
            }
            .theme-option:hover {
                background: var(--bg-hover);
            }
            .theme-option.active {
                background: var(--accent-bg);
                color: var(--accent-color);
                font-weight: 600;
            }
            .theme-dot {
                width: 14px;
                height: 14px;
                border-radius: 50%;
                border: 2px solid rgba(0, 0, 0, 0.1);
            }

            /* Utility colors handled by variables */
            .text-custom-main {
                color: var(--text-main);
            }
            .text-custom-muted {
                color: var(--text-muted);
            }
            .bg-custom-card {
                background-color: var(--bg-card);
            }
            .border-custom {
                border-color: var(--border-color);
            }

            /* Sort Buttons */
            .sort-btn {
                background: var(--bg-main);
                color: var(--text-muted);
                border: 1px solid var(--border-color);
            }
            .sort-btn:hover {
                background: var(--bg-hover);
                color: var(--text-main);
                border-color: var(--border-hover);
            }
            .sort-btn.active {
                background: var(--accent-bg);
                color: var(--accent-color);
                border-color: var(--accent-border);
                font-weight: 600;
            }

            /* Theme-aware Add Button */
            .btn-add {
                background-color: var(--accent-color);
                color: white;
                transition: all 0.2s ease;
            }
            .btn-add:hover {
                background-color: var(--accent-hover);
                transform: translateY(-1px);
            }
            /* Fix contrast for light-accent themes */
            [data-theme="photo"] .btn-add,
            [data-theme="photo"] button[class*="bg-[var(--accent-color)]"] {
                color: #000000;
            }
            /* Minimalist/Retro/Cartoon accents are dark enough for white text */
            [data-theme="light"] .btn-add,
            [data-theme="retro"] .btn-add,
            [data-theme="cartoon"] .btn-add {
                color: white;
            }

            /* Video Item Tooltip */
            .video-item {
                position: relative;
                /* Optimize rendering for large lists */
                contain: layout style;
                will-change: background-color;
            }

            .video-item.loading {
                opacity: 0.7;
                pointer-events: none;
            }
            .video-item[data-tooltip]:hover::before {
                content: attr(data-tooltip);
                position: absolute;
                bottom: calc(100% + 8px);
                left: 50%;
                transform: translateX(-50%);
                padding: 8px 12px;
                background: var(--text-main);
                color: var(--bg-card);
                font-size: 11px;
                font-weight: 500;
                line-height: 1.4;
                border-radius: 6px;
                white-space: normal;
                max-width: 250px;
                z-index: 1000;
                pointer-events: none;
                box-shadow: var(--shadow-md);
                text-align: center;
            }
            .video-item[data-tooltip]:hover::after {
                content: "";
                position: absolute;
                bottom: calc(100% + 4px);
                left: 50%;
                transform: translateX(-50%);
                border: 6px solid transparent;
                border-top-color: var(--text-main);
                z-index: 1000;
                pointer-events: none;
            }

            /* Ensure video list has enough top padding for first item tooltip */
            #video-list,
            #video-list-mobile {
                padding-top: 16px !important;
            }

            /* Mobile Fullscreen Mode */
            #player-wrapper.fullscreen-mode {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                z-index: 50 !important; /* Lower than chatbot */
                border-radius: 0 !important;
                aspect-ratio: auto !important;
            }

            #player-wrapper.fullscreen-mode #player,
            #player-wrapper.fullscreen-mode iframe {
                width: 100% !important;
                height: 100% !important;
            }

            #player-wrapper.fullscreen-mode #fullscreen-btn {
                position: fixed;
                bottom: 20px;
                right: 20px;
                z-index: 10000;
                background: rgba(0, 0, 0, 0.8);
                padding: 12px 20px;
                font-size: 16px;
            }

            /* Hide other elements when in fullscreen */
            body.player-fullscreen .glass-darker,
            body.player-fullscreen .mobile-sidebar,
            body.player-fullscreen .mobile-video-list,
            body.player-fullscreen #mobile-overlay,
            body.player-fullscreen > div:not(#main-page),
            body.player-fullscreen #video-info,
            body.player-fullscreen
                .md\\:hidden:not(#player-wrapper):not(#fullscreen-btn) {
                display: none !important;
            }

            body.player-fullscreen {
                overflow: hidden !important;
            }

            body.player-fullscreen #main-page {
                padding: 0 !important;
                margin: 0 !important;
                height: 100vh !important;
                z-index: 40; /* Lower than chatbot */
            }

            /* Landscape hint for mobile */
            @media (max-width: 768px) and (orientation: portrait) {
                #player-wrapper.fullscreen-mode::before {
                    content: "ð± Rotate device";
                    position: absolute;
                    top: 10px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: rgba(0, 0, 0, 0.7);
                    color: white;
                    padding: 8px 16px;
                    border-radius: 20px;
                    font-size: 12px;
                    z-index: 10001;
                    white-space: nowrap;
                    animation: fadeOut 3s forwards;
                }
            }

            @keyframes fadeOut {
                0%,
                70% {
                    opacity: 1;
                }
                100% {
                    opacity: 0;
                    pointer-events: none;
                }
            }

            /* Force landscape on mobile fullscreen */
            @media (max-width: 768px) {
                body.player-fullscreen {
                    position: fixed;
                    width: 100vh;
                    height: 100vw;
                    transform: rotate(90deg);
                    transform-origin: center center;
                    top: 50%;
                    left: 50%;
                    margin-top: -50vw;
                    margin-left: -50vh;
                }

                body.player-fullscreen #player-wrapper {
                    width: 100vh !important;
                    height: 100vw !important;
                }

                body.player-fullscreen #player-wrapper iframe {
                    width: 100% !important;
                    height: 100% !important;
                }

                /* Hide the rotation hint when we force rotation */
                body.player-fullscreen #player-wrapper.fullscreen-mode::before {
                    display: none !important;
                }
            }

            /* Settings Dock (Inside History Sidebar) */
            .settings-dock {
                position: absolute;
                z-index: 1000;
                width: 100%;
                max-width: 100%;
                max-height: 65vh;
                overflow-y: auto;
                overflow-x: hidden;
                border: 1px solid var(--border-color);
                border-radius: var(--radius-ui);
                bottom: 100%;
                left: 0;
                margin-bottom: 8px;
            }
            .settings-dock.hidden {
                display: none;
            }

            /* Hide the dock-close button inside settings */
            .settings-dock .dock-close {
                display: none;
            }

            .settings-dock .dock-close i {
                font-size: 10px;
            }

            /* Prevent any child from forcing horizontal scroll */
            .settings-dock * {
                max-width: 100%;
            }

            /* Settings dock scrollbar - theme based */
            .settings-dock::-webkit-scrollbar {
                width: 4px;
            }
            .settings-dock::-webkit-scrollbar-track {
                background: var(--scrollbar-track);
            }
            .settings-dock::-webkit-scrollbar-thumb {
                background: var(--scrollbar-thumb);
                border-radius: 2px;
            }
            .settings-dock::-webkit-scrollbar-thumb:hover {
                background: var(--text-muted);
            }

            /* Firefox scrollbar for settings dock */
            .settings-dock {
                scrollbar-width: thin;
                scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-track);
            }

            /* Sharper corners across the UI (including Search result cards) */
            :root {
                --radius-ui: 3px;
                --radius-ui-sm: 2px;
            }

            .glass,
            .glass-darker,
            .input-styled,
            .nav-btn,
            .sort-btn,
            .theme-toggle,
            .theme-dropdown-content,
            .player-container,
            .video-item,
            .history-item,
            .mobile-tab,
            .btn-add,
            #fullscreen-btn,
            #btn-load-more {
                border-radius: var(--radius-ui) !important;
            }

            /* Images / thumbnails slightly sharper */
            #search-results img,
            img.video-thumb {
                border-radius: var(--radius-ui-sm) !important;
            }

            /* Live Stream Cards - Netflix Style */
            .live-stream-card {
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                transform-origin: center center;
            }

            .live-stream-card:hover {
                transform: scale(1.05);
                z-index: 10;
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            }

            [data-theme="netflix"] .live-stream-card:hover {
                box-shadow: 0 20px 40px rgba(229, 9, 20, 0.3);
            }

            .live-stream-card .aspect-video {
                position: relative;
                overflow: hidden;
            }

            .live-stream-card .aspect-video::after {
                content: "";
                position: absolute;
                inset: 0;
                background: linear-gradient(
                    to top,
                    rgba(0, 0, 0, 0.8) 0%,
                    transparent 50%
                );
                opacity: 0;
                transition: opacity 0.3s ease;
            }

            .live-stream-card:hover .aspect-video::after {
                opacity: 1;
            }

            /* Live Category Buttons */
            .live-category-btn {
                transition: all 0.2s ease;
                border: 2px solid transparent;
            }

            .live-category-btn:hover {
                transform: translateY(-2px);
            }

            .live-category-btn.active {
                box-shadow: 0 4px 12px rgba(229, 9, 20, 0.4);
            }

            /* Responsive adjustments for live page */
            @media (max-width: 768px) {
                .live-stream-card:hover {
                    transform: scale(1.02);
                }
            }

            /* Animation for live indicator */
            @keyframes live-pulse {
                0%,
                100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.5;
                }
            }

            .live-stream-card .fa-circle {
                animation: live-pulse 2s infinite;
            }

            /* Live Chat Box Styles */
            #live-chat-container {
                box-shadow: var(--shadow-md);
            }

            #live-chat-container.open {
                height: 450px !important;
            }

            #live-chat-iframe-container iframe,
            #live-chat-iframe-container-main iframe {
                width: 100%;
                height: 100%;
                border: none;
            }

            /* Ensure chat containers can scroll */
            #live-chat-iframe-container,
            #live-chat-iframe-container-main {
                overflow: auto;
                -webkit-overflow-scrolling: touch;
                height: 300px;
                min-height: 200px;
            }

            #live-chat-iframe-container iframe,
            #live-chat-iframe-container-main iframe {
                width: 100%;
                height: 100%;
                border: none;
                min-height: 200px;
            }

            /* Dark theme support for chat */
            [data-theme="dark"] #live-chat-iframe-container,
            [data-theme="dark"] #live-chat-iframe-container-main,
            [data-theme="bold"] #live-chat-iframe-container,
            [data-theme="bold"] #live-chat-iframe-container-main,
            [data-theme="photo"] #live-chat-iframe-container,
            [data-theme="photo"] #live-chat-iframe-container-main,
            [data-theme="forest"] #live-chat-iframe-container,
            [data-theme="forest"] #live-chat-iframe-container-main,
            [data-theme="ocean"] #live-chat-iframe-container,
            [data-theme="ocean"] #live-chat-iframe-container-main,
            [data-theme="sunset"] #live-chat-iframe-container,
            [data-theme="sunset"] #live-chat-iframe-container-main,
            [data-theme="cyber"] #live-chat-iframe-container,
            [data-theme="cyber"] #live-chat-iframe-container-main,
            [data-theme="coffee"] #live-chat-iframe-container,
            [data-theme="coffee"] #live-chat-iframe-container-main,
            [data-theme="netflix"] #live-chat-iframe-container,
            [data-theme="netflix"] #live-chat-iframe-container-main {
                background: #0f0f0f;
            }

            /* Settings dock border visibility for all themes - glass thin */
            [data-theme="light"] .settings-dock,
            [data-theme="retro"] .settings-dock,
            [data-theme="cartoon"] .settings-dock {
                border: 1px solid rgba(203, 213, 225, 0.5);
            }

            [data-theme="dark"] .settings-dock {
                border: 1px solid rgba(75, 85, 99, 0.5);
            }

            [data-theme="bold"] .settings-dock {
                border: 1px solid rgba(124, 58, 237, 0.5);
            }

            [data-theme="photo"] .settings-dock {
                border: 1px solid rgba(255, 255, 255, 0.2);
            }

            [data-theme="forest"] .settings-dock {
                border: 1px solid rgba(6, 95, 70, 0.5);
            }

            [data-theme="ocean"] .settings-dock {
                border: 1px solid rgba(14, 116, 144, 0.5);
            }

            [data-theme="sunset"] .settings-dock {
                border: 1px solid rgba(194, 65, 12, 0.5);
            }

            [data-theme="cyber"] .settings-dock {
                border: 1px solid rgba(0, 255, 157, 0.5);
            }

            [data-theme="coffee"] .settings-dock {
                border: 1px solid rgba(146, 64, 14, 0.5);
            }

            [data-theme="netflix"] .settings-dock {
                border: 1px solid rgba(229, 9, 20, 0.6);
            }

            [data-theme="pink"] .settings-dock {
                border: 1px solid rgba(249, 168, 212, 0.5);
            }

            [data-theme="purple"] .settings-dock {
                border: 1px solid rgba(168, 85, 247, 0.5);
            }

            [data-theme="red"] .settings-dock {
                border: 1px solid rgba(239, 68, 68, 0.5);
            }

            [data-theme="gray"] .settings-dock {
                border: 1px solid rgba(107, 114, 128, 0.5);
            }

            #live-chat-toggle-btn {
                position: relative;
            }

            #live-chat-toggle-btn::before {
                content: "";
                position: absolute;
                left: 0;
                top: 0;
                bottom: 0;
                width: 3px;
                background: #ef4444;
                border-radius: 3px 0 0 3px;
                opacity: 0;
                transition: opacity 0.2s;
            }

            #live-chat-toggle-btn:hover::before {
                opacity: 1;
            }

            #live-chat-chevron.rotate {
                transform: rotate(180deg);
            }

            /* Main chat toggle button styling */
            #live-chat-toggle-btn-main {
                position: relative;
                background-color: var(--accent-color) !important;
                border-color: var(--accent-color) !important;
                color: #ffffff !important;
            }

            #live-chat-toggle-btn-main:hover {
                background-color: var(--accent-hover) !important;
                border-color: var(--accent-hover) !important;
                color: #ffffff !important;
            }

            /* Photography theme - fix contrast for chat button */
            [data-theme="photo"] #live-chat-toggle-btn-main {
                background-color: var(--text-main) !important;
                border-color: var(--text-main) !important;
                color: var(--bg-main) !important;
            }

            [data-theme="photo"] #live-chat-toggle-btn-main:hover {
                background-color: var(--text-muted) !important;
                border-color: var(--text-muted) !important;
                color: var(--bg-main) !important;
            }

            /* Video and Chat Scrollable Container */
            #video-chat-scroll-container {
                scroll-behavior: smooth;
            }

            /* Scrollbar visible when scrolling */
            #video-chat-scroll-container.scrolling {
                scrollbar-width: thin;
            }

            #video-chat-scroll-container.scrolling::-webkit-scrollbar {
                width: 8px;
            }

            #video-chat-scroll-container.scrolling::-webkit-scrollbar-thumb {
                background: var(--scrollbar-thumb);
                border-radius: var(--radius-ui-sm);
            }

            #video-chat-scroll-container.scrolling::-webkit-scrollbar-thumb:hover {
                background: var(--text-muted);
            }

            #video-chat-scroll-container.scrolling::-webkit-scrollbar-track {
                background: var(--scrollbar-track);
                border-radius: var(--radius-ui-sm);
            }

            /* Default scrollbar hidden */
            #video-chat-scroll-container::-webkit-scrollbar {
                width: 0;
                background: transparent;
            }

            /* Ensure player maintains aspect ratio and doesn't shrink */
            #player-wrapper {
                flex-shrink: 0 !important;
                aspect-ratio: 16/9 !important;
            }

            /* Desktop chat sizing */
            @media (min-width: 769px) {
                #video-chat-scroll-container {
                    max-height: calc(100vh - 140px);
                }

                #live-chat-container-main {
                    width: 100%;
                }

                #live-chat-container-main > div {
                    width: 100%;
                }

                #live-chat-iframe-container-main {
                    width: 100%;
                    height: 300px !important;
                    position: relative;
                }

                #live-chat-iframe-container-main iframe {
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                }
            }

            /* Responsive chat adjustments */
            @media (max-width: 768px) {
                #live-chat-container.open {
                    height: 350px !important;
                }

                #live-chat-iframe-container,
                #live-chat-iframe-container-main {
                    min-height: 300px;
                    height: 300px !important;
                }
            }

            /* Floating Chat Panel Styles */
            #live-chat-floating {
                box-shadow: -4px 0 15px rgba(0, 0, 0, 0.15);
            }

            #live-chat-floating > div:first-child {
                flex-shrink: 0;
            }

            /* Live chat height matching video list */
            #live-chat-section {
                flex: 1;
                display: flex;
                flex-direction: column;
                min-height: 0;
            }

            #live-chat-container-main {
                flex: 1;
                display: flex;
                flex-direction: column;
                min-height: 0;
            }

            #live-chat-container-main > div {
                flex: 1;
                display: flex;
                flex-direction: column;
                min-height: 0;
            }

            /* Increase height for main chat container */
            #live-chat-iframe-container-main {
                flex: 1 !important;
                min-height: 0 !important;
            }

            /* Float toggle button */
            #chat-float-btn {
                transition: all 0.2s ease;
            }

            #chat-float-btn:hover {
                transform: scale(1.05);
            }

            #chat-float-btn.floating-active,
            #chat-float-btn-header.floating-active {
                background: var(--accent-color) !important;
                color: white !important;
            }

            /* Photography theme - fix contrast for floating-active state */
            [data-theme="photo"] #chat-float-btn.floating-active,
            [data-theme="photo"] #chat-float-btn-header.floating-active {
                background: var(--text-main) !important;
                color: var(--bg-main) !important;
            }

            /* Keep video list visible below floating chat */
            body.chat-floating #video-list,
            body.chat-floating aside.w-80 {
                position: relative;
                z-index: 1;
            }

            /* Video player maintains size when chat floats */
            body.chat-floating #player-wrapper {
                width: 100% !important;
                max-width: 100% !important;
            }

            @media (max-width: 1100px) {
                #live-chat-section.floating {
                    width: 280px;
                    max-width: 280px;
                }
            }

            @media (max-width: 768px) {
                #live-chat-section.floating {
                    width: 100%;
                    max-width: 100%;
                    right: 0;
                    left: 0;
                    top: auto;
                    bottom: 64px;
                    max-height: 50vh;
                    border-left: none;
                    border-top: 1px solid var(--border-color);
                    box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.15);
                }

                #live-chat-section.floating #live-chat-iframe-container-main {
                    height: calc(50vh - 100px) !important;
                }
            }
        </style>

        <!-- Google tag (gtag.js) -->
        <script
            async
            src="https://www.googletagmanager.com/gtag/js?id=G-MNCJ5PZ2ZM"
        ></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag() {
                dataLayer.push(arguments);
            }
            gtag("js", new Date());

            gtag("config", "G-MNCJ5PZ2ZM");
        </script>
    </head>
    <body class="overflow-hidden">
        <!-- Navigation -->
        <nav
            class="glass sticky top-0 z-40 px-4 py-2 flex items-center justify-between"
        >
            <div class="flex items-center gap-3">
                <div
                    class="bg-gray-700 text-white p-1.5 rounded-lg shadow-sm cursor-pointer hover:scale-105 transition-transform"
                >
                    <i class="fab fa-youtube text-base md:text-lg"></i>
                </div>
                <h1
                    class="text-base md:text-lg font-semibold tracking-tight text-custom-main"
                >
                    PlaylistTube
                </h1>
            </div>
            <div class="flex items-center gap-1 md:gap-2">
                <button
                    onclick="showPage('main')"
                    class="nav-btn active px-3 py-1.5 rounded-md transition-all text-xs md:text-sm flex items-center gap-1.5"
                    id="nav-main"
                >
                    <i class="fas fa-play-circle text-xs"></i><span class="hidden md:inline">Player</span>
                </button>
                <button
                    onclick="showPage('search')"
                    class="nav-btn px-3 py-1.5 rounded-md transition-all text-xs md:text-sm flex items-center gap-1.5"
                    id="nav-search"
                >
                    <i class="fas fa-search text-xs"></i><span class="hidden md:inline">Search</span>
                </button>
                <button
                    onclick="showPage('live')"
                    class="nav-btn px-3 py-1.5 rounded-md transition-all text-xs md:text-sm flex items-center gap-1.5"
                    id="nav-live"
                >
                    <i class="fas fa-broadcast-tower text-xs"></i><span class="hidden md:inline">Live</span>
                </button>
                <button
                    onclick="showPage('chat')"
                    class="nav-btn px-3 py-1.5 rounded-md transition-all text-xs md:text-sm flex items-center gap-1.5"
                    id="nav-chat"
                >
                    <i class="fas fa-robot text-xs"></i><span class="hidden md:inline">AI Chat</span>
                </button>
                <button
                    onclick="showPage('privacy')"
                    class="nav-btn px-3 py-1.5 rounded-md transition-all text-xs md:text-sm flex items-center gap-1.5"
                    id="nav-privacy"
                >
                    <i class="fas fa-shield-alt text-xs"></i><span class="hidden md:inline">Privacy</span>
                </button>
            </div>
        </nav>

        <!-- Mobile Bottom Tab Bar -->
        <div
            class="md:hidden fixed bottom-0 left-0 right-0 bg-custom-card border-t border-custom z-40 flex shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]"
        >
            <button
                onclick="toggleMobileHistory()"
                class="mobile-tab flex-1 py-3 flex flex-col items-center gap-1 text-[10px] font-medium"
                id="tab-history"
            >
                <i class="fas fa-history text-lg mb-0.5"></i>
                <span>History</span>
            </button>
            <button
                onclick="showPage('main')"
                class="mobile-tab flex-1 py-3 flex flex-col items-center gap-1 text-[10px] font-medium active"
                id="tab-player"
            >
                <i class="fas fa-play-circle text-lg mb-0.5"></i>
                <span>Player</span>
            </button>
            <button
                onclick="toggleMobileVideoList()"
                class="mobile-tab flex-1 py-3 flex flex-col items-center gap-1 text-[10px] font-medium"
                id="tab-videos"
            >
                <i class="fas fa-list text-lg mb-0.5"></i>
                <span>Videos</span>
            </button>
            <button
                onclick="showPage('chat')"
                class="mobile-tab flex-1 py-3 flex flex-col items-center gap-1 text-[10px] font-medium"
                id="tab-chat"
            >
                <i class="fas fa-robot text-lg mb-0.5"></i>
                <span>AI Chat</span>
            </button>
        </div>

        <!-- Mobile Overlay -->
        <div
            id="mobile-overlay"
            class="overlay md:hidden fixed inset-0 z-30"
            onclick="closeMobilePanels()"
        ></div>

        <!-- Main Page -->
        <div
            id="main-page"
            class="flex flex-col md:flex-row h-[calc(100vh-70px)] md:h-[calc(100vh-70px)] pb-16 md:pb-0"
        >
            <!-- Fixed close button for settings -->
            <button
                onclick="toggleSettingsDock()"
                id="settings-close-btn-fixed"
                class="fixed hidden z-50 w-8 h-8 rounded-full bg-[var(--bg-card)] border border-[var(--border-color)] text-[var(--text-muted)] hover:text-[var(--text-main)] shadow-lg flex items-center justify-center"
                title="Close Settings"
            >
                <i class="fas fa-times text-sm"></i>
            </button>
            <!-- Left Sidebar - Playlist History (Desktop) -->
            <aside
                id="playlist-history-sidebar"
                class="hidden md:flex w-72 glass flex-col border-r border-custom z-20 overflow-hidden transition-all duration-300"
                style="height: 100%;"
            >
                <!-- Header -->
                <div class="p-4 border-b border-custom bg-custom-card flex-shrink-0" style="min-height: auto;">
                    <div class="flex items-center justify-between">
                        <h2
                            class="font-semibold text-sm uppercase tracking-wider text-custom-muted flex items-center gap-2 playlist-history-header-text"
                        >
                            <i class="fas fa-history text-blue-500"></i>
                            Playlist History
                        </h2>
                        <button
                            onclick="togglePlaylistHistory()"
                            class="hidden md:flex w-8 h-8 rounded-full bg-[var(--bg-card)] border border-[var(--border-color)] text-[var(--text-muted)] items-center justify-center hover:bg-[var(--bg-hover)] hover:text-custom-main transition-colors shadow-sm"
                            title="Collapse/Expand"
                        >
                            <i
                                class="fas fa-chevron-left text-sm"
                                id="history-toggle-icon"
                            ></i>
                        </button>
                    </div>
                    <!-- Search Input -->
                    <div class="mt-3 relative playlist-history-search">
                        <input
                            type="text"
                            id="history-search"
                            placeholder="Search history..."
                            class="w-full input-styled rounded-lg pl-8 pr-3 py-1.5 text-xs"
                            onkeyup="filterHistory()"
                        />
                        <i
                            class="fas fa-search absolute left-2.5 top-1/2 -translate-y-1/2 text-custom-muted text-xs"
                        ></i>
                    </div>
                </div>
                
                <!-- Scrollable Playlist History -->
                <div
                    id="playlist-history"
                    class="overflow-y-auto scrollbar-thin p-3 space-y-2"
                    style="background: var(--bg-main); flex-grow: 1; overflow-y: auto; height: 100%;"
                >
                    <!-- History Items -->
                </div>
                
                <!-- Settings dock mounts here on desktop -->
                <div
                    id="settings-dock-host-desktop"
                    class="px-2 pt-2 pb-2 flex-shrink-0"
                ></div>
                
                <!-- Toggle button when collapsed -->
                <div
                    class="p-2 flex items-center justify-center collapsed-toggle-btn hidden md:flex flex-shrink-0"
                    title="Expand History"
                >
                    <button
                        onclick="togglePlaylistHistory()"
                        class="w-8 h-8 rounded-full bg-[var(--bg-card)] border border-[var(--border-color)] text-[var(--text-muted)] flex items-center justify-center hover:text-custom-main hover:bg-[var(--bg-hover)] shadow-lg transition-colors"
                    >
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                
                <!-- Settings button - Fixed at bottom, NOT scrollable -->
                <div class="p-2 border-t border-custom bg-custom-card flex-shrink-0">
                    <button
                        onclick="toggleSettingsDock()"
                        class="py-1 px-2 rounded text-custom-muted hover:text-custom-main transition-colors font-medium flex items-center justify-center gap-1 border border-custom w-full"
                        title="Settings"
                    >
                        <i class="fas fa-gear text-base"></i>
                    </button>
                </div>
            </aside>

            <!-- Mobile History Sidebar -->
            <aside
                id="mobile-history-sidebar"
                class="mobile-sidebar md:hidden fixed top-[65px] left-0 bottom-16 w-4/5 max-w-xs flex flex-col z-40 shadow-xl overflow-hidden"
                style="height: calc(100vh - 65px - 64px);"
            >
                <!-- Header -->
                <div
                    class="p-4 border-b border-custom flex flex-col gap-3 bg-custom-card flex-shrink-0"
                >
                    <div class="flex items-center justify-between">
                        <h2
                            class="font-semibold text-custom-main flex items-center gap-2"
                        >
                            <i class="fas fa-history text-blue-500"></i>
                            History
                        </h2>
                        <div class="flex gap-2">
                            <button
                                onclick="toggleMobilePlaylistHistory()"
                                class="text-custom-muted hover:text-custom-main p-2 rounded-lg hover:bg-custom-main"
                                title="Collapse/Expand"
                            >
                                <i
                                    class="fas fa-chevron-down"
                                    id="mobile-history-toggle-icon"
                                ></i>
                            </button>
                            <button
                                onclick="closeMobilePanels()"
                                class="text-custom-muted hover:text-custom-main p-2 rounded-lg hover:bg-custom-main"
                            >
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <!-- Mobile Search Input -->
                    <div class="relative">
                        <input
                            type="text"
                            id="history-search-mobile"
                            placeholder="Search history..."
                            class="w-full input-styled rounded-lg pl-8 pr-3 py-2 text-sm"
                            onkeyup="filterHistoryMobile()"
                        />
                        <i
                            class="fas fa-search absolute left-2.5 top-1/2 -translate-y-1/2 text-custom-muted text-sm"
                        ></i>
                    </div>
                </div>
                
                <!-- Scrollable Playlist History -->
                <div
                    id="playlist-history-mobile"
                    class="overflow-y-auto scrollbar-thin p-2 space-y-2"
                    style="flex-grow: 1; overflow-y: auto; height: 100%;"
                >
                    <!-- Mobile History Items -->
                </div>
                
                <!-- Settings dock mounts here on mobile -->
                <div
                    id="settings-dock-host-mobile"
                    class="px-2 pt-2 pb-2 flex-shrink-0"
                ></div>
                
                <!-- Settings button - Fixed at bottom, NOT scrollable -->
                <div class="p-2 border-t border-custom bg-custom-card flex-shrink-0">
                    <button
                        onclick="toggleSettingsDock()"
                        class="py-1 px-2 rounded text-custom-muted hover:text-custom-main transition-colors font-medium flex items-center justify-center gap-1 border border-custom w-full"
                        title="Settings"
                    >
                        <i class="fas fa-gear text-base"></i>
                    </button>
                </div>
            </aside>

            <!-- Main Content -->
            <main
                id="main-content"
                class="flex-1 flex flex-col overflow-hidden relative"
                style="background: var(--bg-main)"
            >
                <!-- Live Videos Panel - Appears when My Live playlist is active -->
                <div
                    id="live-videos-panel"
                    class="hidden glass border-b border-custom bg-custom-card p-3"
                >
                    <div class="flex items-center justify-between">
                        <h3
                            class="font-semibold text-sm uppercase tracking-wider text-custom-muted flex items-center gap-2"
                        >
                            <i class="fas fa-satellite-dish text-red-500"></i>
                            My Live Videos
                        </h3>
                        <button
                            onclick="clearLiveVideos()"
                            class="text-red-400 hover:text-red-500 transition-colors text-xs font-medium flex items-center gap-1"
                            title="Clear Live Videos"
                        >
                            <i class="fas fa-trash-alt"></i> Clear
                        </button>
                    </div>
                    <div
                        id="live-videos-list"
                        class="mt-2 flex flex-wrap gap-2"
                    >
                        <!-- Live videos will be added here -->
                    </div>
                </div>
                <!-- Settings Dock (Hidden by default; toggled from History) -->
                <div id="settings-dock" class="settings-dock glass hidden">
                    <button
                        class="dock-close theme-toggle"
                        onclick="toggleSettingsDock()"
                        title="Close"
                    >
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="bg-custom-card border border-custom">
                        <!-- Collapsible Header -->
                        <button
                            onclick="toggleInputSection()"
                            class="w-full p-2 flex items-center justify-between hover:bg-custom-card transition-colors cursor-pointer group"
                        >
                            <div class="flex items-center gap-2">
                                <div
                                    class="w-6 h-6 rounded-lg bg-blue-50 text-blue-500 flex items-center justify-center group-hover:bg-blue-100 transition-colors"
                                >
                                    <i class="fas fa-sliders-h text-xs"></i>
                                </div>
                                <span
                                    id="api-status"
                                    class="text-[10px] px-2 py-0.5 rounded-full bg-slate-100 text-slate-500 font-medium border border-slate-200"
                                    >No Key</span
                                >
                            </div>
                            <i
                                class="fas fa-chevron-down text-custom-muted text-xs transition-transform duration-300"
                                id="input-toggle-icon"
                            ></i>
                        </button>

                        <!-- Collapsible Content -->
                        <div id="input-section" class="collapse-content">
                            <div class="p-2 pb-3">
                                <div class="w-full">
                                    <div class="grid grid-cols-1 gap-2 mb-1">
                                        <!-- Theme Selector (moved from top nav into Settings) -->
                                        <div
                                            class="p-2 rounded-lg bg-custom-main border border-custom"
                                        >
                                            <label
                                                class="block text-[10px] font-semibold text-custom-muted uppercase tracking-wide mb-1"
                                            >
                                                Theme
                                            </label>
                                            <select
                                                id="theme-select"
                                                class="w-full input-styled rounded px-2 py-1 text-xs"
                                                onchange="setTheme(this.value)"
                                            >
                                                <option value="light">
                                                    Minimalist
                                                </option>
                                                <option value="bold">
                                                    Bold &amp; Colorful
                                                </option>
                                                <option value="dark">
                                                    Dark Mode
                                                </option>
                                                <option value="retro">
                                                    Retro/Vintage
                                                </option>
                                                <option value="cartoon">
                                                    Illustrated
                                                </option>
                                                <option value="photo">
                                                    Photography
                                                </option>
                                                <option value="forest">
                                                    Forest
                                                </option>
                                                <option value="ocean">
                                                    Ocean
                                                </option>
                                                <option value="sunset">
                                                    Sunset
                                                </option>
                                                <option value="cyber">
                                                    Cyber
                                                </option>
                                                <option value="coffee">
                                                    Coffee
                                                </option>
                                                <option value="netflix">
                                                    Netflix
                                                </option>
                                            </select>
                                        </div>

                                        <div
                                            class="p-2 rounded-lg bg-custom-main border border-custom"
                                        >
                                            <button
                                                onclick="toggleApiKeysSection()"
                                                class="w-full flex items-center justify-between"
                                            >
                                                <label
                                                    class="block text-[10px] font-semibold text-custom-muted uppercase tracking-wide flex items-center gap-1"
                                                >
                                                    <i class="fas fa-key"></i>
                                                    API Keys
                                                </label>
                                                <i
                                                    class="fas fa-chevron-down text-[9px] transition-transform"
                                                    id="api-keys-chevron"
                                                ></i>
                                            </button>
                                            <!-- API Warning (outside collapsible section) -->
                                            <div
                                                id="api-quota-warning"
                                                class="mt-2 hidden"
                                            >
                                                <div
                                                    id="api-warning-content"
                                                    class="rounded px-2 py-1 text-[9px] font-medium flex items-center gap-1.5 transition-all duration-300"
                                                >
                                                    <i
                                                        class="fas fa-exclamation-triangle"
                                                    ></i>
                                                    <span
                                                        id="api-warning-text"
                                                    ></span>
                                                </div>
                                            </div>
                                            <!-- API Keys Section Content -->
                                            <div
                                                id="api-keys-section"
                                                class="mt-2 space-y-1.5 hidden"
                                            >
                                                <!-- API Keys List (Collapsible) -->
                                                <div
                                                    id="api-keys-container"
                                                    class="mb-1"
                                                >
                                                    <button
                                                        onclick="
                                                            event.stopPropagation();
                                                            toggleApiKeysList();
                                                        "
                                                        id="api-keys-toggle"
                                                        class="hidden w-full text-left text-[10px] py-1 px-1.5 rounded border border-custom bg-custom-card text-custom-muted hover:bg-custom-main transition flex items-center justify-between"
                                                    >
                                                        <span
                                                            ><i
                                                                class="fas fa-key mr-1"
                                                            ></i
                                                            ><span
                                                                id="api-keys-summary"
                                                                >0</span
                                                            ></span
                                                        >
                                                        <i
                                                            class="fas fa-chevron-down text-[9px] transition-transform"
                                                            id="api-keys-list-chevron"
                                                        ></i>
                                                    </button>
                                                    <div
                                                        id="api-keys-list"
                                                        class="space-y-1 max-h-20 overflow-y-auto scrollbar-thin text-[10px]"
                                                    >
                                                        <!-- Keys rendered here -->
                                                    </div>
                                                </div>
                                                <!-- Add New Key -->
                                                <div class="relative">
                                                    <input
                                                        type="password"
                                                        id="api-key-input"
                                                        placeholder="Add API Key"
                                                        class="w-full input-styled rounded px-2 py-1 text-xs pr-8"
                                                    />
                                                    <button
                                                        onclick="
                                                            event.stopPropagation();
                                                            toggleApiVisibility();
                                                        "
                                                        class="absolute right-2 top-1/2 -translate-y-1/2 text-custom-muted hover:text-blue-500 transition text-xs"
                                                    >
                                                        <i
                                                            class="fas fa-eye"
                                                            id="api-eye"
                                                        ></i>
                                                    </button>
                                                </div>
                                                <div class="flex gap-1.5">
                                                    <button
                                                        onclick="addApiKey()"
                                                        class="flex-1 px-2 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded font-medium text-[10px] shadow-sm btn-hover transition-colors"
                                                    >
                                                        <i
                                                            class="fas fa-plus mr-0.5"
                                                        ></i
                                                        >Add & Validate
                                                    </button>
                                                    <button
                                                        onclick="
                                                            event.stopPropagation();
                                                            clearAllApiKeys();
                                                        "
                                                        class="px-2 py-1 bg-custom-card text-red-500 border border-custom hover:bg-red-50 hover:border-red-200 rounded font-medium text-[10px] transition-colors"
                                                        title="Clear"
                                                    >
                                                        Clear
                                                    </button>
                                                </div>
                                                <div
                                                    id="youtube-api-status"
                                                    class="hidden text-[9px] px-2 py-1 rounded"
                                                ></div>
                                                <p
                                                    class="text-[8px] text-custom-muted mt-1 text-center opacity-70"
                                                >
                                                    Auto-rotates on limit
                                                </p>
                                                <!-- API Quota Progress Bar -->
                                                <div
                                                    id="quota-section"
                                                    class="mt-2 pt-2 border-t border-custom hidden"
                                                >
                                                    <div
                                                        class="flex justify-between items-center mb-1"
                                                    >
                                                        <span
                                                            class="text-[9px] text-custom-muted font-medium"
                                                            >Quota</span
                                                        >
                                                        <span
                                                            id="quota-text"
                                                            class="text-[9px] text-custom-muted"
                                                            >0 / 10k</span
                                                        >
                                                    </div>
                                                    <div
                                                        class="w-full h-1.5 bg-custom-card rounded-full overflow-hidden border border-custom"
                                                    >
                                                        <div
                                                            id="quota-bar"
                                                            class="h-full bg-green-500 transition-all duration-300"
                                                            style="width: 0%"
                                                        ></div>
                                                    </div>
                                                    <div
                                                        class="flex justify-between items-center mt-0.5"
                                                    >
                                                        <span
                                                            id="quota-percent"
                                                            class="text-[8px] text-custom-muted"
                                                            >0%</span
                                                        >
                                                        <button
                                                            onclick="
                                                                resetQuota()
                                                            "
                                                            class="text-[8px] text-custom-muted hover:text-blue-500 transition"
                                                            title="Reset"
                                                        >
                                                            <i
                                                                class="fas fa-undo mr-0.5"
                                                            ></i
                                                            >Reset
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Chatbot API Settings -->
                                        <div
                                            class="p-2 rounded-lg bg-custom-main border border-custom"
                                        >
                                            <button
                                                onclick="
                                                    toggleChatbotApiSection()
                                                "
                                                class="w-full flex items-center justify-between"
                                            >
                                                <label
                                                    class="block text-[10px] font-semibold text-custom-muted uppercase tracking-wide flex items-center gap-1"
                                                >
                                                    <i
                                                        class="fas fa-robot text-blue-500"
                                                    ></i>
                                                    Chatbot AI
                                                </label>
                                                <div
                                                    class="flex items-center gap-2"
                                                >
                                                    <span
                                                        id="chatbot-api-status"
                                                        class="text-[8px] px-1.5 py-0.5 rounded-full bg-gray-200 text-gray-600"
                                                        >Not Set</span
                                                    >
                                                    <i
                                                        class="fas fa-chevron-down text-[9px] transition-transform"
                                                        id="chatbot-api-chevron"
                                                    ></i>
                                                </div>
                                            </button>
                                            <!-- Chatbot API Section Content -->
                                            <div
                                                id="chatbot-api-section"
                                                class="mt-2 space-y-1.5 hidden"
                                            >
                                                <div>
                                                    <select
                                                        id="chatbot-provider"
                                                        class="w-full input-styled rounded px-2 py-1 text-[10px]"
                                                        onchange="
                                                            updateChatbotEndpointHint()
                                                        "
                                                    >
                                                        <option value="openai">
                                                            OpenAI
                                                        </option>
                                                        <option
                                                            value="anthropic"
                                                        >
                                                            Anthropic
                                                        </option>
                                                        <option
                                                            value="deepseek"
                                                        >
                                                            DeepSeek
                                                        </option>
                                                        <option value="gemini">
                                                            Google Gemini
                                                        </option>
                                                        <option value="ollama">
                                                            Ollama (Local)
                                                        </option>
                                                        <option value="ollama-cloud">
                                                            Ollama Cloud
                                                        </option>
                                                        <option value="openrouter">
                                                            OpenRouter
                                                        </option>
                                                        <option value="custom">
                                                            Custom
                                                        </option>
                                                </select>
                                                </div>
                                                <div id="chatbot-url-field">
                                                    <input
                                                        type="text"
                                                        id="chatbot-api-url"
                                                        placeholder="API Base URL"
                                                        class="w-full input-styled rounded px-2 py-1 text-[10px]"
                                                    />
                                                </div>
                                                <div id="chatbot-key-field">
                                                    <input
                                                        type="password"
                                                        id="chatbot-api-key"
                                                        placeholder="API Key"
                                                        class="w-full input-styled rounded px-2 py-1 text-[10px]"
                                                    />
                                                </div>
                                                <div class="relative">
                                                    <input
                                                        type="hidden"
                                                        id="chatbot-model"
                                                        value=""
                                                    />
                                                    <button
                                                        onclick="
                                                            toggleChatbotModelDropdown()
                                                        "
                                                        class="w-full text-left input-styled rounded px-2 py-1 text-[10px] flex items-center justify-between"
                                                        id="chatbot-model-btn"
                                                    >
                                                        <span
                                                            id="chatbot-model-label"
                                                            >Select Model</span
                                                        >
                                                        <i
                                                            class="fas fa-chevron-down text-[9px] transition-transform"
                                                            id="chatbot-model-chevron"
                                                        ></i>
                                                    </button>
                                                    <div
                                                        id="chatbot-model-dropdown"
                                                        class="hidden absolute left-0 right-0 mt-1 bg-[var(--bg-card)] border border-[var(--border-color)] rounded-lg shadow-lg z-50 max-h-64 overflow-y-auto"
                                                    >
                                                        <!-- Models populated by JS -->
                                                    </div>
                                                </div>
                                                <div class="flex gap-1">
                                                    <button
                                                        onclick="
                                                            validateAndSaveChatbotAPI()
                                                        "
                                                        class="flex-1 px-2 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded font-medium text-[10px] transition-colors"
                                                    >
                                                        <i
                                                            class="fas fa-save mr-0.5"
                                                        ></i>
                                                        Save & Validate
                                                    </button>
                                                </div>
                                                <div
                                                    id="chatbot-error"
                                                    class="hidden text-[9px] px-2 py-1 rounded bg-red-100 text-red-700"
                                                ></div>
                                                <div
                                                    id="chatbot-success"
                                                    class="hidden text-[9px] px-2 py-1 rounded bg-green-100 text-green-700"
                                                ></div>
                                            </div>
                                        </div>

                                        <!-- Clear History (moved below settings & playlist) -->
                                        <div
                                            class="p-2 rounded-lg bg-custom-main border border-custom"
                                        >
                                            <div
                                                class="flex items-center justify-between gap-2"
                                            >
                                                <div class="min-w-0">
                                                    <p
                                                        class="text-[10px] font-semibold text-custom-main"
                                                    >
                                                        History
                                                    </p>
                                                    <p
                                                        class="text-[9px] text-custom-muted"
                                                    >
                                                        Remove saved playlists
                                                    </p>
                                                </div>
                                                <button
                                                    onclick="
                                                        event.stopPropagation();
                                                        clearHistory();
                                                    "
                                                    class="py-1 px-2 rounded text-red-400 hover:text-red-500 transition-colors text-[10px] font-semibold flex items-center justify-center gap-1 border border-custom flex-shrink-0"
                                                    title="Clear"
                                                >
                                                    <i
                                                        class="fas fa-trash-alt text-[9px]"
                                                    ></i
                                                    >Clear
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <p
                                        id="error-message"
                                        class="text-center rounded py-1 px-2 text-xs mt-1 hidden"
                                    ></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Player Section -->
                <div class="flex-1 flex flex-col md:flex-row overflow-hidden">
                    <!-- Video Player -->
                    <div
                        class="flex-1 p-3 md:p-6 flex flex-col min-h-0 overflow-hidden"
                    >
                        <!-- Video and Chat Wrapper -->
                        <div
                            id="video-chat-wrapper"
                            class="flex flex-col md:flex-row gap-4 overflow-hidden h-full"
                        >
                            <!-- Left Column: Video Player and Info -->
                            <div
                                class="flex-1 flex flex-col overflow-y-auto md:overflow-y-auto scrollbar-thin"
                                id="video-chat-scroll-container"
                            >
                                <div
                                    id="player-wrapper"
                                    class="player-container relative aspect-video w-full bg-black flex-shrink-0"
                                >
                                    <div
                                        id="player-placeholder"
                                        class="absolute inset-0 flex items-center justify-center bg-slate-900"
                                        style="border-radius: 0"
                                    >
                                        <div class="text-center px-4">
                                            <div
                                                class="w-16 h-16 rounded-full bg-slate-800 flex items-center justify-center mx-auto mb-4 shadow-inner"
                                            >
                                                <i
                                                    class="fab fa-youtube text-4xl text-slate-600"
                                                ></i>
                                            </div>
                                            <p
                                                class="text-slate-400 text-sm font-medium"
                                            >
                                                Ready to play
                                            </p>
                                            <p
                                                class="text-slate-600 text-xs mt-1"
                                            >
                                                Load a playlist to start
                                            </p>
                                        </div>
                                    </div>
                                    <div id="player"></div>
                                    <!-- Mobile Fullscreen Button -->
                                    <button
                                        id="fullscreen-btn"
                                        onclick="toggleFullscreen()"
                                        class="md:hidden absolute bottom-3 right-3 bg-black/70 hover:bg-black/90 text-white px-3 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition-all z-10"
                                    >
                                        <i class="fas fa-expand"></i>
                                        <span id="fullscreen-text"
                                            >Fullscreen</span
                                        >
                                    </button>
                                </div>

                                <div
                                    id="video-info"
                                    class="mt-4 px-1 hidden flex-shrink-0"
                                >
                                    <h3
                                        id="video-title"
                                        class="text-lg md:text-xl font-bold mb-1 line-clamp-2 text-custom-main leading-tight"
                                    ></h3>
                                    <p
                                        id="video-channel"
                                        class="text-custom-muted text-sm flex items-center gap-2 font-medium"
                                    >
                                        <i
                                            class="fas fa-user-circle text-custom-muted"
                                        ></i>
                                        <span></span>
                                    </p>
                                </div>

                                <!-- Live Chat Section - Below Video Player (Desktop Only) -->
                                <div
                                    id="live-chat-section"
                                    class="mt-4 hidden md:block flex-shrink-0"
                                >
                                    <!-- Live Chat Container (Always Visible) -->
                                    <div
                                        id="live-chat-container-main"
                                        class="mt-2 overflow-hidden flex-1"
                                    >
                                        <div
                                            class="border border-[var(--border-color)] bg-[var(--bg-card)] flex flex-col h-full"
                                        >
                                            <div class="flex flex-col h-full">
                                                <div
                                                    class="px-3 py-2 border-b border-[var(--border-color)] bg-[var(--bg-hover)] flex items-center justify-between flex-shrink-0"
                                                >
                                                    <span
                                                        class="text-xs font-semibold text-[var(--text-main)] flex items-center gap-2"
                                                    >
                                                        <span
                                                            class="w-2 h-2 bg-[var(--accent-color)] animate-pulse"
                                                        ></span>
                                                        Live Chat
                                                    </span>
                                                    <button
                                                        onclick="toggleChatFloat()"
                                                        class="text-[var(--text-muted)] hover:text-[var(--text-main)] p-1 transition"
                                                        title="Float chat to right"
                                                    >
                                                        <i class="fas fa-external-link-alt text-xs"></i>
                                                    </button>
                                                </div>
                                                <div id="live-chat-iframe-container-main" class="flex-1 bg-white w-full" style="
                                                        overflow: auto;
                                                        -webkit-overflow-scrolling: touch;
                                                    ">
                                                    <!-- YouTube Live Chat iframe will be loaded here -->
                                                </div>
                                                <div class="px-3 py-1.5 bg-[var(--bg-hover)] border-t border-[var(--border-color)] text-[10px] text-[var(--text-muted)] text-center flex-shrink-0">
                                                    Chat requires domain registration
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Floating Live Chat (Hidden by default) -->
                                <div
                                    id="live-chat-floating"
                                    class="fixed right-2 top-2 bottom-2 w-80 hidden z-50 flex flex-col rounded-lg"
                                    style="background: var(--bg-card); border: 1px solid var(--border-color); box-shadow: 0 4px 20px rgba(0,0,0,0.15)"
                                >
                                    <div class="px-3 py-2 border-b border-[var(--border-color)] bg-[var(--bg-hover)] flex items-center justify-between flex-shrink-0 rounded-t-lg">
                                        <span class="text-xs font-semibold text-[var(--text-main)] flex items-center gap-2">
                                            <span class="w-2 h-2 bg-[var(--accent-color)] animate-pulse"></span>
                                            Live Chat
                                        </span>
                                        <button onclick="toggleChatFloat()" class="text-[var(--text-muted)] hover:text-[var(--text-main)] p-1 transition">
                                            <i class="fas fa-times text-xs"></i>
                                        </button>
                                    </div>
                                    <div id="live-chat-iframe-floating" class="flex-1 bg-white w-full rounded-b-lg" style="overflow: auto; -webkit-overflow-scrolling: touch;">
                                        <!-- YouTube Live Chat iframe will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Mobile Navigation Controls -->
                        <div class="md:hidden flex gap-3 mt-4 mb-4 px-1">
                            <button
                                onclick="playPreviousVideo()"
                                class="flex-1 bg-custom-card border border-custom py-3 rounded-xl text-sm font-medium hover:bg-custom-main transition-colors flex items-center justify-center gap-2 shadow-sm text-custom-main"
                            >
                                <i
                                    class="fas fa-step-backward text-custom-muted"
                                ></i
                                >Prev
                            </button>
                            <button
                                onclick="playNextVideo()"
                                class="flex-1 bg-custom-card border border-custom py-3 rounded-xl text-sm font-medium hover:bg-custom-main transition-colors flex items-center justify-center gap-2 shadow-sm text-custom-main"
                            >
                                Next<i
                                    class="fas fa-step-forward text-custom-muted"
                                ></i>
                            </button>
                        </div>
                    </div>

                    <!-- Video List (Desktop) -->
                    <aside
                        class="hidden md:flex w-80 glass border-l border-custom flex-col z-10"
                    >
                        <div class="p-4 border-b border-custom bg-custom-card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h2
                                        class="font-semibold text-sm uppercase tracking-wider text-custom-muted flex items-center gap-2"
                                    >
                                        <i class="fas fa-list-ol text-blue-500"></i>
                                        <span id="playlist-title" class="truncate"
                                            >Playlist</span
                                        >
                                    </h2>
                                    <p
                                        id="video-count"
                                        class="text-xs text-custom-muted mt-1 pl-6"
                                    ></p>
                                </div>
                                <button
                                    onclick="toggleChatFloat()"
                                    id="chat-float-btn-header"
                                    class="w-8 h-8 rounded-full bg-[var(--bg-card)] border border-[var(--border-color)] text-[var(--text-muted)] flex items-center justify-center hover:text-[var(--accent-color)] hover:border-[var(--accent-color)] transition-colors"
                                    title="Float chat to right"
                                >
                                    <i class="fas fa-external-link-alt text-sm"></i>
                                </button>
                            </div>
                        </div>
                        <div
                            id="video-list"
                            class="flex-1 overflow-y-auto scrollbar-thin p-3 space-y-2"
                            style="background: var(--bg-main)"
                        >
                            <div class="text-center py-10">
                                <div
                                    class="w-12 h-12 rounded-full bg-custom-card flex items-center justify-center mx-auto mb-3 border border-custom"
                                >
                                    <i
                                        class="fas fa-film text-xl text-custom-muted"
                                    ></i>
                                </div>
                                <p class="text-custom-muted text-sm">
                                    Videos will appear here
                                </p>
                            </div>
                        </div>
                    </aside>
                </div>
            </main>

            <!-- Mobile Video List Sidebar -->
            <aside
                id="mobile-video-sidebar"
                class="mobile-video-list md:hidden fixed top-[65px] right-0 bottom-16 w-4/5 max-w-xs flex flex-col z-40 shadow-xl"
            >
                <div
                    class="p-4 border-b border-custom flex items-center justify-between bg-custom-card"
                >
                    <div class="min-w-0 pr-4">
                        <h2
                            class="font-semibold text-custom-main flex items-center gap-2 truncate"
                        >
                            <i class="fas fa-list-ol text-blue-500"></i>
                            <span id="playlist-title-mobile" class="truncate"
                                >Videos</span
                            >
                        </h2>
                        <p
                            id="video-count-mobile"
                            class="text-xs text-custom-muted mt-0.5"
                        ></p>
                    </div>
                    <button
                        onclick="closeMobilePanels()"
                        class="text-custom-muted hover:text-custom-main p-2 rounded-lg hover:bg-custom-main"
                    >
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div
                    id="video-list-mobile"
                    class="flex-1 overflow-y-auto scrollbar-thin p-2 space-y-2"
                >
                    <!-- Mobile Video Items -->
                </div>
            </aside>
        </div>

        <!-- Search Page -->
        <div
            id="search-page"
            class="hidden h-[calc(100vh-70px)] overflow-y-auto pb-16 md:pb-0"
            style="background: var(--bg-main)"
        >
            <div class="max-w-4xl mx-auto p-4 md:p-8">
                <!-- Search Bar -->
                <div
                    class="glass rounded-2xl p-6 md:p-8 shadow-sm border border-custom bg-custom-card mb-8"
                >
                    <div class="flex flex-col gap-4">
                        <div
                            class="flex flex-col md:flex-row gap-4 items-center"
                        >
                            <div class="w-full relative">
                                <input
                                    type="text"
                                    id="yt-search-input"
                                    placeholder="Search for playlists (e.g., 'lofi hip hop', 'coding tutorials')..."
                                    class="w-full input-styled rounded-xl pl-12 pr-4 py-4 text-sm md:text-base shadow-sm"
                                    onkeydown="
                                        if (event.key === 'Enter')
                                            searchPlaylists();
                                    "
                                />
                                <i
                                    class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-custom-muted text-lg"
                                ></i>
                            </div>
                            <button
                                onclick="searchPlaylists()"
                                class="w-full md:w-auto px-8 py-4 bg-[var(--accent-color)] hover:opacity-90 text-white rounded-xl font-medium shadow-sm btn-hover transition-all flex items-center justify-center gap-2 min-w-[140px]"
                            >
                                <i class="fas fa-search"></i> Search
                            </button>
                        </div>

                        <!-- Sort Options -->
                        <div
                            class="flex flex-wrap items-center gap-3 pt-2 border-t border-custom"
                        >
                            <span class="text-sm text-custom-muted font-medium"
                                ><i class="fas fa-sort mr-2"></i>Sort by:</span
                            >
                            <div class="flex flex-wrap gap-2">
                                <button
                                    onclick="setSortOrder('relevance')"
                                    class="sort-btn active px-4 py-2 rounded-lg text-sm font-medium transition-all"
                                    data-sort="relevance"
                                >
                                    <i class="fas fa-star mr-1.5"></i>Relevance
                                </button>
                                <button
                                    onclick="setSortOrder('date')"
                                    class="sort-btn px-4 py-2 rounded-lg text-sm font-medium transition-all"
                                    data-sort="date"
                                >
                                    <i class="fas fa-arrow-down mr-1.5"></i
                                    >Newest First
                                </button>
                                <button
                                    onclick="setSortOrder('date-asc')"
                                    class="sort-btn px-4 py-2 rounded-lg text-sm font-medium transition-all"
                                    data-sort="date-asc"
                                >
                                    <i class="fas fa-arrow-up mr-1.5"></i>Oldest
                                    First
                                </button>
                                <button
                                    onclick="setSortOrder('viewCount')"
                                    class="sort-btn px-4 py-2 rounded-lg text-sm font-medium transition-all"
                                    data-sort="viewCount"
                                >
                                    <i class="fas fa-eye mr-1.5"></i>Most Viewed
                                </button>
                                <button
                                    onclick="setSortOrder('rating')"
                                    class="sort-btn px-4 py-2 rounded-lg text-sm font-medium transition-all"
                                    data-sort="rating"
                                >
                                    <i class="fas fa-thumbs-up mr-1.5"></i>Top
                                    Rated
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Results Grid -->
                <div
                    id="search-results"
                    class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-6"
                >
                    <div class="col-span-full text-center py-20 opacity-50">
                        <i
                            class="fab fa-youtube text-6xl mb-4 text-custom-muted"
                        ></i>
                        <p class="text-custom-muted text-lg">
                            Search YouTube for playlists
                        </p>
                        <p class="text-custom-muted text-sm mt-1">
                            Only playlists will be shown (no single videos)
                        </p>
                    </div>
                </div>

                <!-- Load More -->
                <div id="search-load-more" class="hidden mt-8 text-center pb-8">
                    <button
                        onclick="searchMore()"
                        id="btn-load-more"
                        class="px-8 py-3 bg-custom-card border border-custom text-custom-main rounded-xl hover:bg-blue-50 hover:border-blue-200 transition font-medium"
                    >
                        Load More Results
                    </button>
                </div>
            </div>
        </div>

        <!-- AI Chat Page -->
        <div
            id="chat-page"
            class="hidden h-[calc(100vh-70px)] flex flex-col items-center justify-center"
            style="background: var(--bg-main)"
        >
            <!-- Chat Messages -->
            <div
                id="chat-page-messages"
                class="flex-1 overflow-y-auto scrollbar-thin p-4 space-y-4 min-h-0 w-[90%] max-w-3xl"
                style="background: var(--bg-main)"
            >
                <!-- Welcome Message -->
                <div class="flex items-start gap-3">
                    <div
                        class="w-9 h-9 rounded-full flex items-center justify-center flex-shrink-0"
                        style="background: linear-gradient(135deg, var(--accent-color), #6366f1)"
                    >
                        <i class="fas fa-robot text-white text-sm"></i>
                    </div>
                    <div
                        class="rounded-2xl p-4 max-w-[85%] shadow-sm"
                        style="background: var(--bg-card); border: 1px solid var(--border-color)"
                    >
                        <p style="color: var(--text-main); line-height: 1.6">
                            Hello! I'm your AI assistant. How can I help you today?
                        </p>
                        <div class="mt-3 pt-3 border-t" style="border-color: var(--border-color)">
                            <p style="color: var(--text-muted); font-size: 0.85em">
                                <i class="fas fa-info-circle mr-1"></i> Configure your API key in Settings to start using AI features.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Chat Input -->
            <div
                class="flex-shrink-0 p-4 w-[90%] max-w-3xl"
                style="background: var(--bg-card); border-top: 1px solid var(--border-color)"
            >
                <div class="relative max-w-full mx-auto flex items-center gap-2">
                    <button
                        onclick="clearChat()"
                        class="p-2 rounded-full transition flex-shrink-0"
                        style="background: var(--bg-hover); color: var(--text-muted)"
                        title="Clear chat"
                    >
                        <i class="fas fa-trash-alt"></i>
                    </button>
                    <textarea
                        id="chat-page-input"
                        placeholder="Type your message..."
                        rows="1"
                        class="flex-1 input-styled rounded-2xl pl-5 pr-12 py-3 text-sm md:text-base resize-none"
                        style="min-height: 50px; max-height: 150px; background: var(--bg-main); border: 1px solid var(--border-color)"
                        oninput="autoResizeChatInput(this)"
                        onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendChatMessage(); }"
                    ></textarea>
                    <button
                        onclick="sendChatMessage()"
                        id="chat-page-send-btn"
                        class="absolute right-2 top-1/2 -translate-y-1/2 p-2.5 rounded-full transition"
                        style="background: #4b5563; color: white; width: 36px; height: 36px;"
                    >
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <p class="text-center text-xs mt-2" style="color: var(--text-muted)">
                    Press Enter to send, Shift+Enter for new line
                </p>
            </div>
        </div>

        <!-- Live Page -->
        <div
            id="live-page"
            class="hidden h-[calc(100vh-70px)] overflow-y-auto pb-16 md:pb-0"
            style="background: var(--bg-main)"
        >
            <div class="max-w-7xl mx-auto">
                <!-- Search Bar -->
                <div class="px-4 md:px-8 py-6">
                    <div class="relative max-w-2xl mx-auto">
                        <input
                            type="text"
                            id="live-search-input"
                            placeholder="Search live streams (e.g., 'gaming', 'music', 'news')..."
                            class="w-full input-styled rounded-xl pl-12 pr-4 py-4 text-sm md:text-base shadow-lg"
                            onkeydown="
                                if (event.key === 'Enter') searchLiveStreams();
                            "
                        />
                        <i
                            class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-custom-muted text-lg"
                        ></i>
                        <button
                            onclick="searchLiveStreams()"
                            class="absolute right-2 top-1/2 -translate-y-1/2 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition"
                        >
                            Search
                        </button>
                    </div>
                </div>

                <!-- Categories -->
                <div class="px-4 md:px-8 pb-4">
                    <div class="flex flex-wrap gap-2 justify-center">
                        <button
                            onclick="setLiveCategory('all')"
                            class="live-category-btn active px-4 py-2 rounded-full text-sm font-medium transition bg-red-600 text-white"
                            data-category="all"
                        >
                            <i class="fas fa-fire mr-1"></i> Trending
                        </button>
                        <button
                            onclick="setLiveCategory('gaming')"
                            class="live-category-btn px-4 py-2 rounded-full text-sm font-medium transition bg-[var(--bg-card)] text-[var(--text-main)] hover:bg-red-600 hover:text-white"
                            data-category="gaming"
                        >
                            <i class="fas fa-gamepad mr-1"></i> Gaming
                        </button>
                        <button
                            onclick="setLiveCategory('music')"
                            class="live-category-btn px-4 py-2 rounded-full text-sm font-medium transition bg-[var(--bg-card)] text-[var(--text-main)] hover:bg-red-600 hover:text-white"
                            data-category="music"
                        >
                            <i class="fas fa-music mr-1"></i> Music
                        </button>
                        <button
                            onclick="setLiveCategory('news')"
                            class="live-category-btn px-4 py-2 rounded-full text-sm font-medium transition bg-[var(--bg-card)] text-[var(--text-main)] hover:bg-red-600 hover:text-white"
                            data-category="news"
                        >
                            <i class="fas fa-newspaper mr-1"></i> News
                        </button>
                        <button
                            onclick="setLiveCategory('sports')"
                            class="live-category-btn px-4 py-2 rounded-full text-sm font-medium transition bg-[var(--bg-card)] text-[var(--text-main)] hover:bg-red-600 hover:text-white"
                            data-category="sports"
                        >
                            <i class="fas fa-futbol mr-1"></i> Sports
                        </button>
                        <button
                            onclick="setLiveCategory('technology')"
                            class="live-category-btn px-4 py-2 rounded-full text-sm font-medium transition bg-[var(--bg-card)] text-[var(--text-main)] hover:bg-red-600 hover:text-white"
                            data-category="technology"
                        >
                            <i class="fas fa-microchip mr-1"></i> Tech
                        </button>
                        <button
                            onclick="setLiveCategory('entertainment')"
                            class="live-category-btn px-4 py-2 rounded-full text-sm font-medium transition bg-[var(--bg-card)] text-[var(--text-main)] hover:bg-red-600 hover:text-white"
                            data-category="entertainment"
                        >
                            <i class="fas fa-tv mr-1"></i> Entertainment
                        </button>
                    </div>
                </div>

                <!-- Live Streams Grid -->
                <div class="px-4 md:px-8 py-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2
                            id="live-section-title"
                            class="text-xl md:text-2xl font-bold text-[var(--text-main)]"
                        >
                            Trending Live Streams
                        </h2>
                        <span
                            id="live-count"
                            class="text-sm text-[var(--text-muted)]"
                        ></span>
                    </div>
                    <div
                        id="live-results"
                        class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-6"
                    >
                        <div class="col-span-full text-center py-20 opacity-50">
                            <i
                                class="fas fa-broadcast-tower text-6xl mb-4 text-[var(--text-muted)]"
                            ></i>
                            <p class="text-[var(--text-muted)] text-lg">
                                Select a category to discover live streams
                            </p>
                            <p class="text-[var(--text-muted)] text-sm mt-2">
                                Real-time content from YouTube creators
                                worldwide
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Load More -->
                <div
                    id="live-load-more"
                    class="hidden px-4 md:px-8 pb-8 text-center"
                >
                    <button
                        onclick="loadMoreLiveStreams()"
                        id="btn-live-load-more"
                        class="px-8 py-3 bg-[var(--bg-card)] border border-[var(--border-color)] text-[var(--text-main)] rounded-xl hover:bg-red-50 hover:border-red-200 transition font-medium"
                    >
                        Load More Streams
                    </button>
                </div>
            </div>
        </div>

        <!-- Privacy Page -->
        <div
            id="privacy-page"
            class="hidden h-[calc(100vh-70px)] overflow-y-auto pb-16 md:pb-0"
            style="background: var(--bg-main)"
        >
            <div class="max-w-3xl mx-auto p-4 md:p-8">
                <div
                    class="glass rounded-2xl p-6 md:p-10 shadow-sm border border-custom bg-custom-card"
                >
                    <div class="text-center mb-8 md:mb-10">
                        <div
                            class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-blue-50 text-blue-600 mb-4 shadow-sm"
                        >
                            <i class="fas fa-shield-alt text-3xl"></i>
                        </div>
                        <h2
                            class="text-2xl md:text-3xl font-bold text-custom-main"
                        >
                            Privacy & Security
                        </h2>
                        <p class="text-custom-muted mt-2">
                            Simple, transparent, and secure by design.
                        </p>
                    </div>

                    <div class="space-y-6">
                        <!-- Security Badge -->
                        <div
                            class="bg-green-50 border border-green-200 text-green-800 rounded-xl p-5 md:p-6"
                        >
                            <div class="flex items-start gap-4">
                                <i
                                    class="fas fa-lock text-xl mt-1 opacity-80"
                                ></i>
                                <div>
                                    <h3 class="font-bold text-lg mb-1">
                                        Privacy First
                                    </h3>
                                    <p
                                        class="text-sm opacity-90 leading-relaxed"
                                    >
                                        Currently 100% client-side with no
                                        external servers or database. Your
                                        playlists and preferences are stored
                                        locally in your browser. Database
                                        integration may be added in the future
                                        to enable cloud sync and cross-device
                                        access (will be optional).
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Data Storage -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div
                                class="p-5 rounded-xl border border-custom bg-custom-main"
                            >
                                <h4
                                    class="font-bold text-custom-main mb-3 flex items-center gap-2"
                                >
                                    <i class="fas fa-hdd text-custom-muted"></i>
                                    Saved Locally
                                </h4>
                                <ul class="text-sm text-custom-muted space-y-2">
                                    <li class="flex items-center gap-2">
                                        <i
                                            class="fas fa-check text-green-500 text-xs"
                                        ></i
                                        >API Key (Cookies)
                                    </li>
                                    <li class="flex items-center gap-2">
                                        <i
                                            class="fas fa-check text-green-500 text-xs"
                                        ></i
                                        >Playlist History
                                    </li>
                                </ul>
                            </div>
                            <div
                                class="p-5 rounded-xl border border-custom bg-custom-main"
                            >
                                <h4
                                    class="font-bold text-custom-main mb-3 flex items-center gap-2"
                                >
                                    <i
                                        class="fas fa-chart-line text-custom-muted"
                                    ></i>
                                    Analytics
                                </h4>
                                <ul class="text-sm text-custom-muted space-y-2">
                                    <li class="flex items-center gap-2">
                                        <i
                                            class="fas fa-check text-green-500 text-xs"
                                        ></i
                                        >Google Analytics (page views)
                                    </li>
                                    <li class="flex items-center gap-2">
                                        <i
                                            class="fas fa-times text-red-400 text-xs"
                                        ></i
                                        >No personal data collected
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <!-- Google Analytics Notice -->
                        <div
                            class="bg-yellow-50 border border-yellow-200 rounded-xl p-4"
                        >
                            <div class="flex items-start gap-3">
                                <i
                                    class="fas fa-info-circle text-yellow-600 mt-0.5"
                                ></i>
                                <div>
                                    <h4
                                        class="font-semibold text-yellow-800 text-sm mb-1"
                                    >
                                        Google Analytics
                                    </h4>
                                    <p class="text-xs text-yellow-700">
                                        We use Google Analytics to track page
                                        views and usage patterns. This helps us
                                        improve the application. No personal
                                        information or API keys are ever shared
                                        with Google.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- API Key Info -->
                        <div
                            class="p-5 md:p-6 rounded-xl border border-blue-200 bg-blue-50"
                        >
                            <h3
                                class="font-bold text-blue-900 mb-4 flex items-center gap-2"
                            >
                                <i class="fas fa-key text-blue-500"></i>
                                About Your API Key
                            </h3>
                            <div class="space-y-3 text-sm text-blue-800">
                                <p>
                                    You can remove your API key at any time
                                    using the
                                    <span
                                        class="font-semibold text-red-500 bg-white px-1.5 py-0.5 rounded border border-red-100"
                                        >Clear</span
                                    >
                                    button in the settings panel.
                                </p>
                                <p>
                                    Clearing your "Playlist History"
                                    <strong class="text-blue-900"
                                        >does not</strong
                                    >
                                    remove your API key.
                                </p>
                                <div class="mt-4 pt-3 border-t border-blue-200">
                                    <p class="text-xs font-semibold mb-1">
                                        <i class="fas fa-user-shield mr-1"></i>
                                        Security Recommendation:
                                    </p>
                                    <p class="text-xs opacity-90">
                                        We strongly recommend creating a
                                        separate
                                        <strong>"Dummy" Google Account</strong>
                                        to generate your API key. This ensures
                                        your primary account remains completely
                                        isolated.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Setup Guide -->
                        <div class="pt-4 border-t border-custom">
                            <h3 class="font-bold text-custom-main mb-4">
                                How to get a Key
                            </h3>
                            <div class="space-y-2 text-sm">
                                <a
                                    href="https://console.cloud.google.com/"
                                    target="_blank"
                                    class="flex items-center justify-between p-3 rounded-lg border border-custom hover:border-blue-300 hover:bg-blue-50 transition-colors group"
                                >
                                    <span
                                        class="text-custom-muted group-hover:text-blue-700"
                                        >1. Open Google Cloud Console</span
                                    >
                                    <i
                                        class="fas fa-external-link-alt text-custom-muted group-hover:text-blue-400"
                                    ></i>
                                </a>
                                <div
                                    class="p-3 rounded-lg border border-custom bg-custom-main text-custom-muted"
                                >
                                    2. Create Project & Enable "YouTube Data API
                                    v3"
                                </div>
                                <div
                                    class="p-3 rounded-lg border border-custom bg-custom-main text-custom-muted"
                                >
                                    3. Create Credentials (API Key) & Paste here
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // Cookie Management
            function setCookie(name, value, days = 365) {
                const expires = new Date(
                    Date.now() + days * 864e5,
                ).toUTCString();
                document.cookie =
                    name +
                    "=" +
                    encodeURIComponent(value) +
                    "; expires=" +
                    expires +
                    "; path=/; SameSite=Strict";
            }

            function getCookie(name) {
                const value = document.cookie
                    .split("; ")
                    .find((row) => row.startsWith(name + "="));
                return value ? decodeURIComponent(value.split("=")[1]) : null;
            }

            function deleteCookie(name) {
                document.cookie =
                    name + "=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/";
            }

            // State
            let player = null;
            let currentPlaylist = [];
            let currentVideoIndex = 0;
            let playlistHistory = [];
            let theme = "light";
            let apiKeys = [];
            let currentKeyIndex = 0;

            // Initialize
            document.addEventListener("DOMContentLoaded", () => {
                loadTheme();
                loadSavedData();
                loadYouTubeAPI();
                mountSettingsDock();
                window.addEventListener("resize", debounceMountSettingsDock);

                // Ensure collapsible button is properly initialized
                setTimeout(() => {
                    ensureCollapsibleButtonVisible();
                }, 100);
            });

            // Theme Management
            const themes = [
                "light",
                "bold",
                "dark",
                "retro",
                "cartoon",
                "photo",
                "forest",
                "ocean",
                "sunset",
                "cyber",
                "coffee",
                "netflix",
            ];

            function loadTheme() {
                const savedTheme = getCookie("yt_theme");
                if (savedTheme && themes.includes(savedTheme)) {
                    theme = savedTheme;
                } else {
                    theme = "light";
                }
                applyTheme();
            }

            function toggleThemeDropdown() {
                const dropdown = document.getElementById("theme-dropdown");
                dropdown.classList.toggle("show");
            }

            function setTheme(newTheme) {
                theme = newTheme;
                setCookie("yt_theme", theme);
                applyTheme();

                // Sync settings select if present
                const sel = document.getElementById("theme-select");
                if (sel) sel.value = theme;

                // Close dropdown if it still exists (older UI)
                const dd = document.getElementById("theme-dropdown");
                if (dd) dd.classList.remove("show");
            }

            function applyTheme() {
                document.documentElement.setAttribute("data-theme", theme);

                // Sync settings select
                const sel = document.getElementById("theme-select");
                if (sel) sel.value = theme;

                // Update active state in dropdown (if present)
                document.querySelectorAll(".theme-option").forEach((opt) => {
                    const onclick = opt.getAttribute("onclick") || "";
                    const match = onclick.match(/setTheme\('([^']+)'\)/);
                    const key = match ? match[1] : null;
                    opt.classList.toggle("active", key === theme);
                });
            }

            // Close dropdown when clicking outside (if dropdown exists)
            document.addEventListener("click", function (e) {
                const dropdown = document.getElementById("theme-dropdown");
                const btn = document.getElementById("theme-btn");
                if (!dropdown || !btn) return;
                if (!dropdown.contains(e.target) && !btn.contains(e.target)) {
                    dropdown.classList.remove("show");
                }
            });

            function loadSavedData() {
                // Load API keys (multiple)
                const savedApiKeys = getCookie("yt_api_keys");
                if (savedApiKeys) {
                    try {
                        apiKeys = JSON.parse(savedApiKeys);
                    } catch (e) {
                        apiKeys = [];
                    }
                }

                // Load current key index
                const savedKeyIndex = getCookie("yt_current_key_index");
                if (savedKeyIndex) {
                    currentKeyIndex = parseInt(savedKeyIndex) || 0;
                }

                // Restore API key list expanded state (collapsed by default)
                const expandedCookie = getCookie("yt_api_keys_expanded");
                apiKeysExpanded = expandedCookie === "1" ? true : false;

                // Render API keys list
                renderApiKeysList();
                updateApiStatus();

                // API section is collapsed by default (only expand if user previously opened it)
                const settingsOpen = getCookie("yt_settings_open") === "1";
                if (settingsOpen) {
                    // open settings content
                    const section = document.getElementById("input-section");
                    const icon = document.getElementById("input-toggle-icon");
                    if (section && icon) {
                        section.classList.add("open");
                        icon.classList.add("rotate-180");
                    }
                }

                // Restore API Keys section state
                const apiKeysSectionOpen =
                    getCookie("yt_api_keys_section_open") === "1";
                const apiKeysSection =
                    document.getElementById("api-keys-section");
                const apiKeysChevron =
                    document.getElementById("api-keys-chevron");
                if (apiKeysSection && apiKeysChevron) {
                    if (apiKeysSectionOpen) {
                        apiKeysSection.classList.remove("hidden");
                        apiKeysChevron.classList.add("rotate-180");
                    } else {
                        apiKeysSection.classList.add("hidden");
                        apiKeysChevron.classList.remove("rotate-180");
                    }
                }

                // Restore Chatbot API section state
                const chatbotApiSectionOpen =
                    getCookie("yt_chatbot_api_section_open") === "1";
                const chatbotApiSection = document.getElementById(
                    "chatbot-api-section",
                );
                const chatbotApiChevron = document.getElementById(
                    "chatbot-api-chevron",
                );
                if (chatbotApiSection && chatbotApiChevron) {
                    if (chatbotApiSectionOpen) {
                        chatbotApiSection.classList.remove("hidden");
                        chatbotApiChevron.classList.add("rotate-180");
                    } else {
                        chatbotApiSection.classList.add("hidden");
                        chatbotApiChevron.classList.remove("rotate-180");
                    }
                }

                // Load and display quota
                loadQuota();
                updateQuotaDisplay();

                // Load playlist history
                const savedHistory = getCookie("yt_playlist_history");
                if (savedHistory) {
                    try {
                        playlistHistory = JSON.parse(savedHistory);
                        renderPlaylistHistory();
                    } catch (e) {
                        playlistHistory = [];
                    }
                }
            }

            // Multi-API Key Management
            // Collapsed by default when multiple keys exist
            let apiKeysExpanded = false;

            function toggleApiKeysSection() {
                const section = document.getElementById("api-keys-section");
                const chevron = document.getElementById("api-keys-chevron");
                const isOpen = !section.classList.contains("hidden");
                section.classList.toggle("hidden");
                chevron.classList.toggle("rotate-180");
                setCookie("yt_api_keys_section_open", isOpen ? "0" : "1");
            }

            function toggleApiKeysList() {
                apiKeysExpanded = !apiKeysExpanded;
                const list = document.getElementById("api-keys-list");
                const chevron = document.getElementById(
                    "api-keys-list-chevron",
                );

                list.classList.toggle("hidden", !apiKeysExpanded);
                chevron.classList.toggle("rotate-180", apiKeysExpanded);
                setCookie("yt_api_keys_expanded", apiKeysExpanded ? "1" : "0");
            }

            function renderApiKeysList() {
                const container = document.getElementById("api-keys-list");
                const toggle = document.getElementById("api-keys-toggle");
                const summary = document.getElementById("api-keys-summary");

                // Update quota display when keys change
                if (typeof updateQuotaDisplay === "function") {
                    updateQuotaDisplay();
                }

                if (apiKeys.length === 0) {
                    toggle.classList.add("hidden");
                    container.classList.remove("hidden");
                    container.innerHTML =
                        '<p class="text-custom-muted text-center py-2 opacity-60">No API keys added yet</p>';
                    return;
                }

                // Show toggle button if more than 1 key
                if (apiKeys.length > 1) {
                    toggle.classList.remove("hidden");
                    summary.textContent = `${apiKeys.length} keys saved (Key ${currentKeyIndex + 1} active)`;

                    // Default to collapsed when multiple keys exist (unless user expanded)
                    container.classList.toggle("hidden", !apiKeysExpanded);
                    document
                        .getElementById("api-keys-list-chevron")
                        .classList.toggle("rotate-180", apiKeysExpanded);

                    // If many keys, keep collapsed by default
                    if (apiKeys.length > 2 && apiKeysExpanded) {
                        apiKeysExpanded = false;
                        container.classList.add("hidden");
                        document
                            .getElementById("api-keys-list-chevron")
                            .classList.remove("rotate-180");
                        setCookie("yt_api_keys_expanded", "0");
                    }
                } else {
                    toggle.classList.add("hidden");
                    container.classList.remove("hidden");
                }

                container.innerHTML = apiKeys
                    .map((key, index) => {
                        const shortKey = `${key.substring(0, 8)}...${key.substring(key.length - 4)}`;
                        const active = index === currentKeyIndex;
                        return `
                <div class="flex items-center gap-2 p-2 rounded-lg ${active ? "border border-green-500/50 bg-green-500/10" : "bg-custom-card border border-custom"}">
                    <button onclick="event.stopPropagation(); setActiveApiKey(${index})" class="w-7 h-7 rounded-md border border-custom flex items-center justify-center ${active ? "bg-green-500/20 text-green-500" : "bg-custom-main text-custom-muted hover:text-custom-main"}" title="Make active">
                        <i class="fas ${active ? "fa-check" : "fa-circle"} text-[10px]"></i>
                    </button>
                    <span class="flex-1 font-mono truncate text-custom-main">${shortKey}</span>
                    <button onclick="event.stopPropagation(); copyApiKey(${index})" class="w-7 h-7 rounded-md border border-custom flex items-center justify-center text-custom-muted hover:text-custom-main" title="Copy">
                        <i class="fas fa-copy text-[10px]"></i>
                    </button>
                    <button onclick="event.stopPropagation(); removeApiKey(${index})" class="w-7 h-7 rounded-md border border-custom flex items-center justify-center text-red-400 hover:text-red-600" title="Remove">
                        <i class="fas fa-trash text-[10px]"></i>
                    </button>
                </div>
            `;
                    })
                    .join("");
            }

            function setActiveApiKey(index) {
                if (index < 0 || index >= apiKeys.length) return;
                currentKeyIndex = index;
                setCookie("yt_current_key_index", currentKeyIndex.toString());
                renderApiKeysList();
                updateApiStatus();
            }

            async function copyApiKey(index) {
                const key = apiKeys[index];
                if (!key) return;
                try {
                    await navigator.clipboard.writeText(key);
                    showMessage("API key copied", "success");
                } catch (e) {
                    // Fallback
                    const temp = document.createElement("textarea");
                    temp.value = key;
                    document.body.appendChild(temp);
                    temp.select();
                    document.execCommand("copy");
                    document.body.removeChild(temp);
                    showMessage("API key copied", "success");
                }
            }

            async function addApiKey() {
                const input = document.getElementById("api-key-input");
                const newKey = input.value.trim();

                if (!newKey) {
                    showYouTubeApiStatus("Please enter an API key", "error");
                    return;
                }

                // Check if key already exists
                if (apiKeys.includes(newKey)) {
                    showYouTubeApiStatus(
                        "This API key is already added",
                        "error",
                    );
                    return;
                }

                // Validate key first
                const btn = document.querySelector(
                    'button[onclick*="addApiKey"]',
                );
                const originalHtml = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML =
                    '<i class="fas fa-circle-notch fa-spin"></i> Validating...';

                try {
                    const resp = await fetch(
                        `https://www.googleapis.com/youtube/v3/search?part=snippet&q=test&maxResults=1&key=${newKey}`,
                    );
                    const data = await resp.json();

                    if (!resp.ok || data.error) {
                        const errorMsg =
                            data?.error?.message || "Invalid API key";
                        showYouTubeApiStatus(
                            "Invalid API key: " + errorMsg,
                            "error",
                        );
                        btn.disabled = false;
                        btn.innerHTML = originalHtml;
                        return;
                    }

                    // Key is valid, add it
                    apiKeys.push(newKey);
                    setCookie("yt_api_keys", JSON.stringify(apiKeys));
                    input.value = "";
                    renderApiKeysList();
                    updateApiStatus();
                    showYouTubeApiStatus(
                        "API key verified and added!",
                        "success",
                    );
                } catch (err) {
                    showYouTubeApiStatus("Invalid API key", "error");
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                }
            }

            function showYouTubeApiStatus(message, type) {
                const statusDiv = document.getElementById("youtube-api-status");
                statusDiv.textContent = message;
                statusDiv.classList.remove(
                    "hidden",
                    "bg-green-100",
                    "text-green-700",
                    "bg-red-100",
                    "text-red-700",
                );

                if (type === "success") {
                    statusDiv.classList.add("bg-green-100", "text-green-700");
                } else if (type === "error") {
                    statusDiv.classList.add("bg-red-100", "text-red-700");
                }
                statusDiv.classList.remove("hidden");

                setTimeout(() => {
                    statusDiv.classList.add("hidden");
                }, 5000);
            }

            function removeApiKey(index) {
                apiKeys.splice(index, 1);

                // Adjust current index if needed
                if (currentKeyIndex >= apiKeys.length) {
                    currentKeyIndex = Math.max(0, apiKeys.length - 1);
                }

                setCookie("yt_api_keys", JSON.stringify(apiKeys));
                setCookie("yt_current_key_index", currentKeyIndex.toString());
                renderApiKeysList();
                updateApiStatus();
            }

            function clearAllApiKeys() {
                if (confirm("Are you sure you want to clear ALL API keys?")) {
                    apiKeys = [];
                    currentKeyIndex = 0;
                    deleteCookie("yt_api_keys");
                    deleteCookie("yt_current_key_index");
                    renderApiKeysList();
                    updateApiStatus();
                    showMessage("All API keys cleared", "success");
                }
            }

            function getCurrentApiKey() {
                if (apiKeys.length === 0) return null;
                return apiKeys[currentKeyIndex];
            }

            function rotateToNextApiKey() {
                if (apiKeys.length <= 1) return false;

                currentKeyIndex = (currentKeyIndex + 1) % apiKeys.length;
                setCookie("yt_current_key_index", currentKeyIndex.toString());
                renderApiKeysList();
                showMessage(
                    `Switched to API key ${currentKeyIndex + 1} of ${apiKeys.length}`,
                    "info",
                );
                return true;
            }

            function loadYouTubeAPI() {
                const tag = document.createElement("script");
                tag.src = "https://www.youtube.com/iframe_api";
                const firstScriptTag =
                    document.getElementsByTagName("script")[0];
                firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
            }

            // Search History
            function filterHistory() {
                const query = document
                    .getElementById("history-search")
                    .value.toLowerCase();
                const filtered = playlistHistory.filter((item) =>
                    item.title.toLowerCase().includes(query),
                );
                renderPlaylistHistory(filtered);
            }

            function filterHistoryMobile() {
                const query = document
                    .getElementById("history-search-mobile")
                    .value.toLowerCase();
                const filtered = playlistHistory.filter((item) =>
                    item.title.toLowerCase().includes(query),
                );
                renderPlaylistHistory(filtered);
            }

            // Mobile Panel Management
            function toggleMobileHistory() {
                const sidebar = document.getElementById(
                    "mobile-history-sidebar",
                );
                const videoSidebar = document.getElementById(
                    "mobile-video-sidebar",
                );
                const overlay = document.getElementById("mobile-overlay");

                videoSidebar.classList.remove("open");
                sidebar.classList.toggle("open");
                overlay.classList.toggle(
                    "open",
                    sidebar.classList.contains("open"),
                );

                updateMobileTabs();
            }

            function toggleMobileVideoList() {
                const sidebar = document.getElementById("mobile-video-sidebar");
                const historySidebar = document.getElementById(
                    "mobile-history-sidebar",
                );
                const overlay = document.getElementById("mobile-overlay");

                historySidebar.classList.remove("open");
                sidebar.classList.toggle("open");
                overlay.classList.toggle(
                    "open",
                    sidebar.classList.contains("open"),
                );

                updateMobileTabs();
            }

            function closeMobilePanels() {
                document
                    .getElementById("mobile-history-sidebar")
                    .classList.remove("open");
                document
                    .getElementById("mobile-video-sidebar")
                    .classList.remove("open");
                document
                    .getElementById("mobile-overlay")
                    .classList.remove("open");
                updateMobileTabs();
            }

            function updateMobileTabs() {
                const historyOpen = document
                    .getElementById("mobile-history-sidebar")
                    .classList.contains("open");
                const videosOpen = document
                    .getElementById("mobile-video-sidebar")
                    .classList.contains("open");

                document
                    .getElementById("tab-history")
                    .classList.toggle("active", historyOpen);
                document
                    .getElementById("tab-player")
                    .classList.toggle("active", !historyOpen && !videosOpen);
                document
                    .getElementById("tab-videos")
                    .classList.toggle("active", videosOpen);
            }

            // Page Navigation
            function showPage(page) {
                document
                    .getElementById("main-page")
                    .classList.toggle("hidden", page !== "main");
                document
                    .getElementById("search-page")
                    .classList.toggle("hidden", page !== "search");
                document
                    .getElementById("live-page")
                    .classList.toggle("hidden", page !== "live");
                document
                    .getElementById("privacy-page")
                    .classList.toggle("hidden", page !== "privacy");
                document
                    .getElementById("chat-page")
                    .classList.toggle("hidden", page !== "chat");

                document
                    .querySelectorAll(".nav-btn")
                    .forEach((btn) => btn.classList.remove("active"));
                const navBtn = document.getElementById("nav-" + page);
                if (navBtn) navBtn.classList.add("active");

                // Load live streams when navigating to live page
                if (page === "live" && !liveStreamsLoaded) {
                    loadLiveCategory("all");
                    liveStreamsLoaded = true;
                }

                closeMobilePanels();

                // Ensure the playlist history collapsible functionality is maintained
                setTimeout(() => {
                    // Make sure the toggle button is properly positioned
                    ensureCollapsibleButtonVisible();
                }, 100);
            }

            // Function to ensure the collapsible button is visible and properly positioned
            function ensureCollapsibleButtonVisible() {
                const sidebar = document.getElementById(
                    "playlist-history-sidebar",
                );
                const toggleIcon = document.getElementById(
                    "history-toggle-icon",
                );
                if (sidebar && toggleIcon) {
                    // Update the icon based on the current state
                    if (sidebar.classList.contains("collapsed")) {
                        // When collapsed, the icon should point right
                        toggleIcon.classList.remove("fa-chevron-left");
                        toggleIcon.classList.add("fa-chevron-right");
                    } else {
                        // When expanded, the icon should point left
                        toggleIcon.classList.remove("fa-chevron-right");
                        toggleIcon.classList.add("fa-chevron-left");
                    }
                }
            }

            // ========== SEARCH FUNCTIONALITY ==========
            let searchNextToken = "";
            let currentSearchQuery = "";
            let currentSortOrder = "relevance";
            let allSearchResults = [];

            function setSortOrder(order) {
                currentSortOrder = order;

                // Update active button styling
                document.querySelectorAll(".sort-btn").forEach((btn) => {
                    btn.classList.toggle("active", btn.dataset.sort === order);
                });

                // If we have results and selecting client-side sort (oldest first), sort them
                if (order === "date-asc" && allSearchResults.length > 0) {
                    // Sort existing results by date ascending (oldest first)
                    const sorted = [...allSearchResults].sort((a, b) => {
                        return (
                            new Date(a.snippet.publishedAt) -
                            new Date(b.snippet.publishedAt)
                        );
                    });
                    renderSearchResults(sorted);
                } else if (currentSearchQuery) {
                    // Re-search with new sort order
                    searchPlaylists();
                }
            }

            function renderSearchResults(items) {
                const container = document.getElementById("search-results");
                container.innerHTML = "";

                items.forEach((item) => {
                    const el = document.createElement("div");
                    el.className =
                        "live-stream-card glass rounded-xl overflow-hidden shadow-sm border border-[var(--border-color)] flex flex-col card-hover group cursor-pointer";

                    const thumbnail =
                        item.snippet.thumbnails.medium?.url ||
                        item.snippet.thumbnails.default?.url;
                    const title = item.snippet.title;
                    const channel = item.snippet.channelTitle;
                    const videoCount = item.videoCount || 0;

                    el.innerHTML = `
                    <div class="relative aspect-video bg-slate-200 overflow-hidden">
                        <img src="${thumbnail}" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 320 180%22><rect fill=%22%23cbd5e1%22 width=%22100%%22 height=%22100%%22/></svg>'">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                        <div class="absolute bottom-2 right-2 px-2 py-1 rounded bg-black/70 text-white text-xs font-medium">
                            <i class="fas fa-video mr-1"></i>${videoCount} videos
                        </div>
                        <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                            <div class="w-16 h-16 rounded-full bg-blue-600/90 flex items-center justify-center shadow-lg transform scale-75 group-hover:scale-100 transition-transform">
                                <i class="fas fa-play text-white text-2xl ml-1"></i>
                            </div>
                        </div>
                    </div>
                    <div class="p-4 flex flex-col flex-1">
                        <h3 class="font-bold text-[var(--text-main)] line-clamp-2 mb-2 text-sm md:text-base leading-snug group-hover:text-blue-500 transition-colors">${escapeHtml(title)}</h3>
                        <div class="mt-auto flex items-center justify-between">
                            <p class="text-xs text-[var(--text-muted)] flex items-center gap-1 truncate flex-1">
                                <i class="fas fa-user-circle"></i>
                                <span class="truncate">${escapeHtml(channel)}</span>
                            </p>
                            <div class="flex gap-1 ml-2">
                                <button onclick="event.stopPropagation(); importPlaylist('${item.id.playlistId}')" class="btn-add w-7 h-7 rounded-lg transition flex items-center justify-center shadow-sm" title="Add to History">
                                    <i class="fas fa-plus text-xs"></i>
                                </button>
                                <button onclick="event.stopPropagation(); playPlaylistDirect('${item.id.playlistId}')" class="btn-add w-7 h-7 rounded-lg transition flex items-center justify-center shadow-sm" title="Play Now">
                                    <i class="fas fa-play text-xs"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                    el.onclick = () => playPlaylistDirect(item.id.playlistId);
                    el.ondblclick = () =>
                        playPlaylistDirect(item.id.playlistId);

                    container.appendChild(el);
                });
            }

            async function searchPlaylists(pageToken = "") {
                const apiKey = getCurrentApiKey();
                const query = document
                    .getElementById("yt-search-input")
                    .value.trim();

                if (!apiKey) {
                    alert(
                        "Please add at least one API Key in the Player Settings first.",
                    );
                    showPage("main");
                    toggleInputSection();
                    return;
                }

                if (!query) return;

                currentSearchQuery = query;
                const container = document.getElementById("search-results");
                const loadMoreBtn = document.getElementById("search-load-more");

                if (!pageToken) {
                    container.innerHTML =
                        '<div class="col-span-full text-center py-20"><i class="fas fa-circle-notch fa-spin text-4xl text-blue-500"></i><p class="mt-4 text-custom-muted">Searching playlists...</p></div>';
                    loadMoreBtn.classList.add("hidden");
                } else {
                    document.getElementById("btn-load-more").innerHTML =
                        '<i class="fas fa-circle-notch fa-spin"></i> Loading...';
                }

                try {
                    // Determine API sort order (date-asc uses 'date' then sorts client-side)
                    const apiOrder =
                        currentSortOrder === "date-asc"
                            ? "date"
                            : currentSortOrder;

                    const response = await fetch(
                        `https://www.googleapis.com/youtube/v3/search?part=snippet&type=playlist&q=${encodeURIComponent(query)}&maxResults=12&order=${apiOrder}&key=${apiKey}${pageToken ? "&pageToken=" + pageToken : ""}`,
                    );
                    const data = await response.json();

                    if (data.error) {
                        // Check for quota exceeded error
                        if (
                            data.error.code === 403 &&
                            data.error.message.includes("quota")
                        ) {
                            if (rotateToNextApiKey()) {
                                // Retry with next key
                                searchPlaylists(pageToken);
                                return;
                            }
                        }
                        throw new Error(data.error.message);
                    }

                    searchNextToken = data.nextPageToken || "";

                    if (!pageToken) {
                        allSearchResults = [];
                        container.innerHTML = "";
                        if (data.items.length === 0) {
                            container.innerHTML =
                                '<div class="col-span-full text-center py-20 text-custom-muted"><i class="fas fa-inbox text-4xl mb-4"></i><p>No playlists found for "' +
                                escapeHtml(query) +
                                '"</p></div>';
                            return;
                        }
                    }

                    // Track search API usage (100 units per search call)
                    trackApiCall("search", 1);

                    // Fetch video counts for all playlists in one batch call
                    const playlistIds = data.items
                        .map((item) => item.id.playlistId)
                        .join(",");
                    const detailsResponse = await fetch(
                        `https://www.googleapis.com/youtube/v3/playlists?part=contentDetails&id=${playlistIds}&key=${apiKey}`,
                    );
                    const detailsData = await detailsResponse.json();

                    // Track playlists API usage (1 unit)
                    trackApiCall("playlists", 1);

                    // Create a map of playlist ID to video count
                    const videoCountMap = {};
                    if (detailsData.items) {
                        detailsData.items.forEach((item) => {
                            videoCountMap[item.id] =
                                item.contentDetails.itemCount;
                        });
                    }

                    // Merge video counts into search results
                    data.items.forEach((item) => {
                        item.videoCount =
                            videoCountMap[item.id.playlistId] || 0;
                    });

                    // Store results for client-side sorting
                    allSearchResults = allSearchResults.concat(data.items);

                    // If oldest first, sort all results
                    let itemsToRender = data.items;
                    if (currentSortOrder === "date-asc") {
                        const sorted = [...allSearchResults].sort((a, b) => {
                            return (
                                new Date(a.snippet.publishedAt) -
                                new Date(b.snippet.publishedAt)
                            );
                        });
                        container.innerHTML = "";
                        itemsToRender = sorted;
                    }

                    itemsToRender.forEach((item) => {
                        const el = document.createElement("div");
                        el.className =
                            "glass rounded-xl overflow-hidden shadow-sm border border-custom flex flex-col card-hover";
                        el.innerHTML = `
                        <div class="relative aspect-video bg-slate-200">
                            <img src="${item.snippet.thumbnails.medium?.url || item.snippet.thumbnails.default?.url}" class="w-full h-full object-cover" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 320 180%22><rect fill=%22%23cbd5e1%22 width=%22100%%22 height=%22100%%22/></svg>'">
                        </div>
                        <div class="p-4 flex flex-col flex-1">
                            <h3 class="font-bold text-custom-main line-clamp-2 mb-2 text-sm md:text-base leading-snug">${escapeHtml(item.snippet.title)}</h3>
                            <p class="text-xs text-custom-muted mb-4 flex items-center gap-1">
                                <i class="fas fa-user-circle"></i> ${escapeHtml(item.snippet.channelTitle)}
                            </p>
                            <div class="mt-auto flex items-center justify-between">
                                <div class="flex gap-2">
                                    <button onclick="importPlaylist('${item.id.playlistId}')" class="btn-add w-9 h-9 rounded-lg transition flex items-center justify-center shadow-sm" title="Add to History">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                    <button onclick="playPlaylistDirect('${item.id.playlistId}')" class="btn-add w-9 h-9 rounded-lg transition flex items-center justify-center shadow-sm" title="Play Now">
                                        <i class="fas fa-play"></i>
                                    </button>
                                </div>
                                <span class="text-xs text-custom-muted font-medium flex items-center gap-1">
                                    <i class="fas fa-video text-[10px]"></i> ${item.videoCount || 0}
                                </span>
                            </div>
                        </div>
                    `;
                        container.appendChild(el);
                    });

                    if (searchNextToken) {
                        loadMoreBtn.classList.remove("hidden");
                        document.getElementById("btn-load-more").innerHTML =
                            "Load More Results";
                    } else {
                        loadMoreBtn.classList.add("hidden");
                    }
                } catch (error) {
                    container.innerHTML = `<div class="col-span-full text-center text-red-500 py-10"><i class="fas fa-exclamation-triangle text-3xl mb-3"></i><p>Error: ${escapeHtml(stripHtml(error.message))}</p></div>`;
                    loadMoreBtn.classList.add("hidden");
                }
            }

            function searchMore() {
                if (searchNextToken) {
                    searchPlaylists(searchNextToken);
                }
            }

            async function importPlaylist(playlistId) {
                // Ensure we have at least one API key configured
                if (!apiKeys || apiKeys.length === 0) {
                    alert(
                        "Please add at least one API Key in the Player Settings first.",
                    );
                    showPage("main");
                    toggleInputSection();
                    return;
                }

                // Find and update button(s)
                const btns = document.querySelectorAll(
                    `button[onclick="importPlaylist('${playlistId}')"]`,
                );
                btns.forEach(
                    (btn) =>
                        (btn.innerHTML =
                            '<i class="fas fa-circle-notch fa-spin"></i>'),
                );

                let attempts = 0;
                while (attempts < Math.max(1, apiKeys.length)) {
                    const apiKey = getCurrentApiKey();
                    try {
                        const response = await fetch(
                            `https://www.googleapis.com/youtube/v3/playlists?part=snippet,contentDetails&id=${playlistId}&key=${apiKey}`,
                        );
                        const data = await response.json();

                        if (data.error) {
                            // Rotate on quota exceeded
                            if (
                                data.error.code === 403 &&
                                (data.error.message || "")
                                    .toLowerCase()
                                    .includes("quota")
                            ) {
                                if (rotateToNextApiKey()) {
                                    attempts++;
                                    continue;
                                }
                            }
                            throw new Error(
                                data.error.message ||
                                    "Failed to fetch playlist",
                            );
                        }

                        if (data.items && data.items.length > 0) {
                            const item = data.items[0];
                            const title = item.snippet.title;
                            const count = item.contentDetails.itemCount;
                            const url = `https://www.youtube.com/playlist?list=${playlistId}`;
                            const thumbnail =
                                item.snippet.thumbnails?.medium?.url ||
                                item.snippet.thumbnails?.default?.url ||
                                null;
                            const channel =
                                item.snippet.channelTitle || "Unknown Channel";

                            addToHistory(
                                playlistId,
                                title,
                                url,
                                count,
                                thumbnail,
                                channel,
                            );

                            btns.forEach((btn) => {
                                btn.innerHTML = '<i class="fas fa-check"></i>';
                                btn.classList.remove("btn-add");
                                btn.classList.add("bg-green-600");
                                setTimeout(() => {
                                    btn.innerHTML =
                                        '<i class="fas fa-plus"></i>';
                                    btn.classList.add("btn-add");
                                    btn.classList.remove("bg-green-600");
                                }, 1500);
                            });
                        }
                        return; // success
                    } catch (e) {
                        if (attempts >= apiKeys.length - 1) {
                            btns.forEach(
                                (btn) =>
                                    (btn.innerHTML =
                                        '<i class="fas fa-plus"></i>'),
                            );
                            showMessage(
                                "Error importing: " +
                                    stripHtml(e.message || "Unknown error"),
                                "error",
                            );
                            return;
                        }
                        attempts++;
                        rotateToNextApiKey();
                    }
                }
            }

            async function playPlaylistDirect(playlistId) {
                const url = `https://www.youtube.com/playlist?list=${playlistId}`;
                showPage("main");
                await loadPlaylist(url);
            }

            // API Key Management
            function toggleApiVisibility() {
                const input = document.getElementById("api-key-input");
                const eye = document.getElementById("api-eye");
                if (input.type === "password") {
                    input.type = "text";
                    eye.classList.replace("fa-eye", "fa-eye-slash");
                } else {
                    input.type = "password";
                    eye.classList.replace("fa-eye-slash", "fa-eye");
                }
            }

            function updateApiStatus() {
                const status = document.getElementById("api-status");

                if (apiKeys.length > 0) {
                    status.textContent = `${apiKeys.length} Key${apiKeys.length > 1 ? "s" : ""}`;
                    status.classList.remove(
                        "text-slate-500",
                        "bg-slate-100",
                        "border-slate-200",
                    );
                    status.classList.add(
                        "text-green-600",
                        "bg-green-50",
                        "border-green-200",
                    );
                    status.style.borderColor = "#bbf7d0";
                } else {
                    status.textContent = "No API Key";
                    status.classList.remove(
                        "text-green-600",
                        "bg-green-50",
                        "border-green-200",
                    );
                    status.classList.add(
                        "text-slate-500",
                        "bg-slate-100",
                        "border-slate-200",
                    );
                    status.style.borderColor = "#e2e8f0";
                }
            }

            function toggleInputSection() {
                const section = document.getElementById("input-section");
                const icon = document.getElementById("input-toggle-icon");

                section.classList.toggle("open");
                icon.classList.toggle("rotate-180");

                // persist open/close state
                const isOpen = section.classList.contains("open");
                setCookie("yt_settings_open", isOpen ? "1" : "0");
            }

            // Settings Dock mount (kept within History sidebar boundary)
            function mountSettingsDock() {
                const dock = document.getElementById("settings-dock");
                if (!dock) return;

                const desktopHost = document.getElementById(
                    "settings-dock-host-desktop",
                );
                const mobileHost = document.getElementById(
                    "settings-dock-host-mobile",
                );
                const isDesktop =
                    window.matchMedia("(min-width: 768px)").matches;
                const host = isDesktop ? desktopHost : mobileHost;

                if (host && dock.parentElement !== host) {
                    host.appendChild(dock);
                }
            }

            let mountDockTimer = null;
            function debounceMountSettingsDock() {
                clearTimeout(mountDockTimer);
                mountDockTimer = setTimeout(() => mountSettingsDock(), 150);
            }

            // Settings Dock toggle
            function toggleSettingsDock(force) {
                const dock = document.getElementById("settings-dock");
                if (!dock) return;

                // Mount to correct host if needed
                const desktopHost = document.getElementById("settings-dock-host-desktop");
                const mobileHost = document.getElementById("settings-dock-host-mobile");
                const isDesktop = window.matchMedia("(min-width: 768px)").matches;
                const host = isDesktop ? desktopHost : mobileHost;

                if (host && dock.parentElement !== host) {
                    host.appendChild(dock);
                }

                // Toggle visibility
                if (force !== undefined) {
                    // Force show/hide
                    if (force) {
                        dock.classList.remove("hidden");
                    } else {
                        dock.classList.add("hidden");
                    }
                } else {
                    // Toggle current state
                    dock.classList.toggle("hidden");
                }
            }

            // Playlist Management
            function extractPlaylistId(url) {
                const regex = /[?&]list=([^&]+)/;
                const match = url.match(regex);
                return match ? match[1] : null;
            }

            function isPlaylistUrl(url) {
                return (
                    (url.includes("list=") && !url.includes("/watch?v=")) ||
                    url.includes("playlist?list=")
                );
            }

            async function loadPlaylist(playlistUrlOverride = "") {
                // Hide live chat toggle and clear chat when loading a new playlist
                hideLiveChatToggle();

                // Use multi-key system
                if (!apiKeys || apiKeys.length === 0) {
                    showMessage(
                        "Please add at least one API Key in the Player Settings first.",
                        "error",
                    );
                    showPage("main");
                    toggleInputSection();
                    return;
                }

                // This app loads playlists from History or Search (URL is passed in).
                const playlistUrl = (playlistUrlOverride || "").trim();

                if (!playlistUrl) {
                    showMessage(
                        "Pick a playlist from History or Search first.",
                        "error",
                    );
                    return;
                }

                if (!isPlaylistUrl(playlistUrl)) {
                    showMessage(
                        "Please enter a valid playlist URL (not a single video link)",
                        "error",
                    );
                    return;
                }

                const playlistId = extractPlaylistId(playlistUrl);
                if (!playlistId) {
                    showMessage(
                        "Could not extract playlist ID from URL",
                        "error",
                    );
                    return;
                }

                let attempts = 0;
                showMessage("Loading playlist...", "info");

                while (attempts < Math.max(1, apiKeys.length)) {
                    const apiKey = getCurrentApiKey();
                    try {
                        // Fetch playlist details
                        const playlistResponse = await fetch(
                            `https://www.googleapis.com/youtube/v3/playlists?part=snippet&id=${playlistId}&key=${apiKey}`,
                        );
                        const playlistData = await playlistResponse.json();

                        if (playlistData.error) {
                            if (
                                playlistData.error.code === 403 &&
                                (playlistData.error.message || "")
                                    .toLowerCase()
                                    .includes("quota")
                            ) {
                                if (rotateToNextApiKey()) {
                                    attempts++;
                                    continue;
                                }
                            }
                            throw new Error(playlistData.error.message);
                        }

                        const playlistTitle =
                            playlistData.items?.[0]?.snippet?.title ||
                            "Unknown Playlist";
                        const playlistChannel =
                            playlistData.items?.[0]?.snippet?.channelTitle ||
                            "Unknown Channel";

                        // Track playlists API usage (1 unit)
                        trackApiCall("playlists", 1);

                        // Fetch playlist items
                        let allItems = [];
                        let nextPageToken = "";
                        let playlistItemsCalls = 0;

                        do {
                            const response = await fetch(
                                `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&maxResults=50&playlistId=${playlistId}&key=${apiKey}${nextPageToken ? "&pageToken=" + nextPageToken : ""}`,
                            );
                            const data = await response.json();

                            if (data.error) {
                                if (
                                    data.error.code === 403 &&
                                    (data.error.message || "")
                                        .toLowerCase()
                                        .includes("quota")
                                ) {
                                    if (rotateToNextApiKey()) {
                                        attempts++;
                                        continue;
                                    }
                                }
                                throw new Error(data.error.message);
                            }

                            allItems = allItems.concat(data.items || []);
                            nextPageToken = data.nextPageToken;
                            playlistItemsCalls++;
                        } while (nextPageToken);

                        // Track playlistItems API usage (1 unit per page call)
                        trackApiCall("playlistItems", playlistItemsCalls);

                        if (allItems.length === 0) {
                            showMessage(
                                "Playlist is empty or private",
                                "error",
                            );
                            return;
                        }

                        currentPlaylist = allItems.map((item) => ({
                            videoId: item.snippet.resourceId.videoId,
                            title: item.snippet.title,
                            thumbnail:
                                item.snippet.thumbnails?.medium?.url ||
                                item.snippet.thumbnails?.default?.url,
                            channel: item.snippet.videoOwnerChannelTitle,
                            publishedAt: item.snippet.publishedAt,
                        }));

                        // Fetch video statistics (views) in batches of 50
                        const videoIds = currentPlaylist.map((v) => v.videoId);
                        let videosApiCalls = 0;
                        for (let i = 0; i < videoIds.length; i += 50) {
                            const batch = videoIds.slice(i, i + 50).join(",");
                            try {
                                const statsResponse = await fetch(
                                    `https://www.googleapis.com/youtube/v3/videos?part=statistics&id=${batch}&key=${apiKey}`,
                                );
                                const statsData = await statsResponse.json();
                                if (statsData.items) {
                                    statsData.items.forEach((stat) => {
                                        const video = currentPlaylist.find(
                                            (v) => v.videoId === stat.id,
                                        );
                                        if (video) {
                                            video.viewCount =
                                                parseInt(
                                                    stat.statistics.viewCount,
                                                ) || 0;
                                        }
                                    });
                                }
                                videosApiCalls++;
                            } catch (e) {
                                console.warn("Could not fetch video stats:", e);
                            }
                        }

                        // Track videos API usage (1 unit per batch call)
                        if (videosApiCalls > 0) {
                            trackApiCall("videos", videosApiCalls);
                        }

                        // Add to history with thumbnail from first video
                        const playlistThumbnail =
                            currentPlaylist[0]?.thumbnail || null;
                        addToHistory(
                            playlistId,
                            playlistTitle,
                            playlistUrl,
                            currentPlaylist.length,
                            playlistThumbnail,
                            playlistChannel,
                        );

                        // Update UI
                        document.getElementById("playlist-title").textContent =
                            playlistTitle;
                        document.getElementById(
                            "playlist-title-mobile",
                        ).textContent = playlistTitle;
                        document.getElementById("video-count").textContent =
                            `${currentPlaylist.length} videos`;
                        document.getElementById(
                            "video-count-mobile",
                        ).textContent = `${currentPlaylist.length} videos`;
                        renderVideoList();
                        playVideo(0);
                        hideMessage();
                        closeMobilePanels();
                        // Clear input if it exists (UI may hide it)
                        const inputEl = document.getElementById("playlist-url");
                        if (inputEl) inputEl.value = "";

                        // Ensure the collapsible button is properly visible after loading playlist
                        setTimeout(() => {
                            ensureCollapsibleButtonVisible();
                        }, 100);

                        return;
                    } catch (error) {
                        if (attempts >= apiKeys.length - 1) {
                            showMessage(
                                "Error: " + stripHtml(error.message),
                                "error",
                            );
                            return;
                        }
                        attempts++;
                        rotateToNextApiKey();
                    }
                }
            }

            // Debounce to prevent multiple rapid clicks
            let isPlayingVideo = false;
            let playDebounceTimer = null;

            function renderVideoList() {
                // For large playlists, use lazy loading approach
                const maxInitialRender = 100; // Render first 100, lazy load rest
                const totalVideos = currentPlaylist.length;

                const renderVideoItem = (video, index) => `
                <div class="video-item glass p-2.5 rounded-lg cursor-pointer card-hover flex gap-3 ${index === currentVideoIndex ? "active" : ""}"
                     data-index="${index}"
                     data-tooltip="${escapeHtml(video.title)}">
                    <div class="relative flex-shrink-0">
                        <img src="${index < maxInitialRender ? video.thumbnail || "data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22120%22 height=%2268%22><rect fill=%22%23cbd5e1%22 width=%22100%%22 height=%22100%%22/></svg>" : "data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22120%22 height=%2268%22><rect fill=%22%23cbd5e1%22 width=%22100%%22 height=%22100%%22/></svg>"}"
                             data-src="${video.thumbnail || ""}"
                             alt="" class="w-20 md:w-24 h-12 md:h-14 object-cover rounded shadow-sm bg-slate-200 video-thumb">
                        <div class="thumbnail-overlay rounded"></div>
                        <span class="absolute bottom-1 left-1 bg-black/70 text-white text-[10px] px-1.5 py-0.5 rounded font-medium">${index + 1}</span>
                    </div>
                    <div class="flex-1 min-w-0 flex flex-col">
                        <p class="text-xs md:text-sm font-medium line-clamp-1 text-custom-main leading-snug">${escapeHtml(video.title)}</p>
                        <p class="text-[10px] text-custom-muted mt-0.5 truncate flex items-center gap-1">
                            <i class="fas fa-user-circle"></i>
                            ${escapeHtml(video.channel || "")}
                        </p>
                        <p class="text-[9px] text-custom-muted mt-auto flex items-center gap-2">
                            <span>${formatViews(video.viewCount)} views</span>
                            <span>â¢</span>
                            <span>${formatTimeAgo(video.publishedAt)}</span>
                        </p>
                    </div>
                </div>
            `;

                const videoItemsHTML = currentPlaylist
                    .map((video, index) => renderVideoItem(video, index))
                    .join("");

                const videoListEl = document.getElementById("video-list");
                const videoListMobileEl =
                    document.getElementById("video-list-mobile");

                videoListEl.innerHTML = videoItemsHTML;
                videoListMobileEl.innerHTML = videoItemsHTML;

                // Use event delegation for clicks (much more performant for large lists)
                videoListEl.onclick = handleVideoListClick;
                videoListMobileEl.onclick = handleVideoListClick;

                // Lazy load thumbnails on scroll
                setupLazyLoading(videoListEl);
                setupLazyLoading(videoListMobileEl);

                // Update the live videos panel if this is the "My Live" playlist
                updateLiveVideosPanel();
            }

            function handleVideoListClick(e) {
                const videoItem = e.target.closest(".video-item");
                if (!videoItem) return;

                const index = parseInt(videoItem.dataset.index);
                if (isNaN(index)) return;

                // Clear any existing debounce to allow immediate play
                clearTimeout(playDebounceTimer);

                // Always play the video when clicked
                playVideo(index);
                closeMobilePanels();
            }

            function setupLazyLoading(container) {
                if (!container) return;

                const observer = new IntersectionObserver(
                    (entries) => {
                        entries.forEach((entry) => {
                            if (entry.isIntersecting) {
                                const img = entry.target;
                                const src = img.dataset.src;
                                if (src && img.src !== src) {
                                    img.src = src;
                                }
                                observer.unobserve(img);
                            }
                        });
                    },
                    { rootMargin: "100px" },
                );

                container
                    .querySelectorAll("img.video-thumb[data-src]")
                    .forEach((img) => {
                        observer.observe(img);
                    });
            }

            // Format view count (e.g., 1.2M, 45K)
            function formatViews(count) {
                if (!count) return "0";
                if (count >= 1000000) {
                    return (
                        (count / 1000000).toFixed(1).replace(/\.0$/, "") + "M"
                    );
                }
                if (count >= 1000) {
                    return (count / 1000).toFixed(1).replace(/\.0$/, "") + "K";
                }
                return count.toLocaleString();
            }

            // Format time ago (e.g., "2 hours ago", "3 days ago")
            function formatTimeAgo(dateString) {
                if (!dateString) return "";
                const date = new Date(dateString);
                const now = new Date();
                const seconds = Math.floor((now - date) / 1000);

                const intervals = [
                    { label: "year", seconds: 31536000 },
                    { label: "month", seconds: 2592000 },
                    { label: "week", seconds: 604800 },
                    { label: "day", seconds: 86400 },
                    { label: "hour", seconds: 3600 },
                    { label: "minute", seconds: 60 },
                ];

                for (const interval of intervals) {
                    const count = Math.floor(seconds / interval.seconds);
                    if (count >= 1) {
                        return `${count} ${interval.label}${count > 1 ? "s" : ""} ago`;
                    }
                }
                return "just now";
            }

            function playVideo(index) {
                if (index < 0 || index >= currentPlaylist.length) return;

                // Always force play when clicked - reset player state
                const isSameVideo = index === currentVideoIndex;

                currentVideoIndex = index;
                const video = currentPlaylist[index];

                document
                    .getElementById("player-placeholder")
                    .classList.add("hidden");

                // Show loading state in video info
                document
                    .getElementById("video-info")
                    .classList.remove("hidden");
                document.getElementById("video-title").textContent =
                    video.title || "Loading...";
                document.getElementById("video-channel").innerHTML =
                    `<i class="fas fa-user-circle text-custom-muted"></i><span>${video.channel || ""}</span>`;

                // Hide chat toggle initially - will only show if video is a live stream
                hideLiveChatToggle();

                try {
                    if (
                        player &&
                        typeof player.loadVideoById === "function" &&
                        !isSameVideo
                    ) {
                        // Player exists and different video, load new video
                        player.loadVideoById({
                            videoId: video.videoId,
                            startSeconds: 0,
                        });
                        // Explicitly ensure video plays after loading
                        setTimeout(() => {
                            try {
                                player.playVideo();
                            } catch (e) {}
                        }, 100);
                    } else if (
                        player &&
                        typeof player.loadVideoById === "function" &&
                        isSameVideo
                    ) {
                        // Same video clicked - force play
                        player.playVideo();
                        // If paused, ensure it plays
                        setTimeout(() => {
                            try {
                                if (
                                    player.getPlayerState &&
                                    player.getPlayerState() !==
                                        YT.PlayerState.PLAYING
                                ) {
                                    player.playVideo();
                                }
                            } catch (e) {}
                        }, 100);
                    } else if (player && typeof player.destroy === "function") {
                        // Player exists but in bad state, destroy and recreate
                        player.destroy();
                        player = null;
                        createPlayer(video.videoId);
                    } else {
                        // No player, create new one
                        createPlayer(video.videoId);
                    }
                } catch (e) {
                    console.error("Error playing video:", e);
                    // Try to recreate player on error
                    try {
                        if (player && typeof player.destroy === "function") {
                            player.destroy();
                        }
                    } catch (destroyError) {
                        console.error("Error destroying player:", destroyError);
                    }
                    player = null;
                    createPlayer(video.videoId);
                }

                // Update active state in list (use data-index for performance)
                document
                    .querySelectorAll(".video-item.active")
                    .forEach((el) => {
                        el.classList.remove("active");
                    });
                document
                    .querySelectorAll(`.video-item[data-index="${index}"]`)
                    .forEach((el) => {
                        el.classList.add("active");
                        // Scroll to active video
                        el.scrollIntoView({
                            behavior: "smooth",
                            block: "nearest",
                        });
                    });

                // Check if this is a live stream and show chat toggle if so
                checkAndShowLiveChat();

                // Backup check after player is ready
                setTimeout(() => {
                    checkPlayerForLiveStream();
                }, 2000);
            }

            function playNextVideo() {
                if (currentVideoIndex < currentPlaylist.length - 1) {
                    playVideo(currentVideoIndex + 1);
                }
            }

            function playPreviousVideo() {
                if (currentVideoIndex > 0) {
                    playVideo(currentVideoIndex - 1);
                }
            }

            function createPlayer(videoId) {
                console.log("Creating player for video:", videoId);

                // Clear the player div first
                const playerDiv = document.getElementById("player");
                if (playerDiv) {
                    playerDiv.innerHTML = "";
                }

                // Check if current video is a live stream
                const currentVideo = currentPlaylist[currentVideoIndex];
                const isLiveStream = currentVideo && currentVideo.isLive;

                // Small delay to ensure DOM is ready
                setTimeout(
                    () => {
                        try {
                            player = new YT.Player("player", {
                                height: "100%",
                                width: "100%",
                                videoId: videoId,
                                playerVars: {
                                    autoplay: 1,
                                    rel: 0,
                                    playsinline: 1,
                                    origin: window.location.origin,
                                    enablejsapi: 1,
                                    modestbranding: 1,
                                    ...(isLiveStream && {
                                        live_stream: 1,
                                    }),
                                },
                                events: {
                                    onReady: onPlayerReady,
                                    onStateChange: onPlayerStateChange,
                                    onError: onPlayerError,
                                },
                            });
                            console.log("Player created successfully");
                        } catch (e) {
                            console.error("Error creating player:", e);
                            showMessage(
                                "Error loading video player. Please refresh the page.",
                                "error",
                            );
                        }
                    },
                    isLiveStream ? 200 : 100,
                );
            }

            function onPlayerReady(event) {
                // Player is ready, ensure it plays
                console.log("Player ready, attempting to play");
                try {
                    event.target.playVideo();

                    // For live streams, verify playback started
                    const currentVideo = currentPlaylist[currentVideoIndex];
                    if (currentVideo && currentVideo.isLive) {
                        setTimeout(() => {
                            try {
                                const state = event.target.getPlayerState();
                                if (
                                    state !== YT.PlayerState.PLAYING &&
                                    state !== YT.PlayerState.BUFFERING
                                ) {
                                    console.log(
                                        "Live stream not playing, retrying...",
                                    );
                                    event.target.playVideo();
                                }
                            } catch (e) {
                                console.warn(
                                    "Could not check player state:",
                                    e,
                                );
                            }
                        }, 1000);
                    }
                } catch (e) {
                    console.error("Error starting playback:", e);
                }
            }

            function onPlayerError(event) {
                console.warn("Player Error:", event.data);
                // 100: Video not found, 101/150/153: Embedding disabled, 2: Invalid video ID
                if ([2, 100, 101, 150, 153].includes(event.data)) {
                    const video = currentPlaylist[currentVideoIndex];
                    const videoTitle = video?.title || "Video";
                    const videoId = video?.videoId;

                    // Show error with YouTube link option
                    const el = document.getElementById("error-message");
                    el.innerHTML = `
                    <span>Cannot play "${escapeHtml(videoTitle.substring(0, 30))}..." - </span>
                    <a href="https://www.youtube.com/watch?v=${videoId}" target="_blank" class="underline font-bold hover:text-blue-700">Watch on YouTube</a>
                    <span> | Auto-skipping in 3s...</span>
                `;
                    el.classList.remove(
                        "hidden",
                        "text-green-600",
                        "text-blue-600",
                    );
                    el.classList.add("text-red-600");
                    el.style.background = "#fef2f2";
                    el.style.border = "1px solid #fee2e2";

                    // Auto skip after delay
                    setTimeout(() => {
                        hideMessage();
                        if (currentVideoIndex < currentPlaylist.length - 1) {
                            playNextVideo();
                        }
                    }, 3000);
                } else if (event.data === 5) {
                    // HTML5 player error - try to recreate player
                    console.warn(
                        "HTML5 player error, attempting to recreate...",
                    );
                    try {
                        if (player && typeof player.destroy === "function") {
                            player.destroy();
                        }
                    } catch (e) {}
                    player = null;

                    setTimeout(() => {
                        const video = currentPlaylist[currentVideoIndex];
                        if (video) {
                            createPlayer(video.videoId);
                        }
                    }, 1000);
                }
            }

            function onPlayerStateChange(event) {
                // When video ends, play next
                if (event.data === YT.PlayerState.ENDED) {
                    if (currentVideoIndex < currentPlaylist.length - 1) {
                        playVideo(currentVideoIndex + 1);
                    }
                }
            }

            // History Management
            function addToHistory(
                playlistId,
                title,
                url,
                videoCount,
                thumbnail = null,
                channel = "Unknown Channel",
            ) {
                // Remove if already exists
                playlistHistory = playlistHistory.filter(
                    (p) => p.id !== playlistId,
                );

                // Add to beginning
                playlistHistory.unshift({
                    id: playlistId,
                    title: title,
                    url: url,
                    videoCount: videoCount,
                    thumbnail: thumbnail,
                    channel: channel,
                });

                // Keep only last 20
                playlistHistory = playlistHistory.slice(0, 20);

                // Save to cookie
                setCookie(
                    "yt_playlist_history",
                    JSON.stringify(playlistHistory),
                );

                // Re-render, respecting current search query if any
                filterHistory();
            }

            function renderPlaylistHistory(itemsToRender) {
                const items = itemsToRender || playlistHistory;

                const emptyHTML = `
                <div class="text-center py-10 h-full flex flex-col items-center justify-center">
                    <div class="w-12 h-12 rounded-full bg-custom-card flex items-center justify-center mb-3 border border-custom">
                        <i class="fas fa-inbox text-xl text-custom-muted"></i>
                    </div>
                    <p class="text-custom-muted text-sm">No playlists found</p>
                </div>
            `;

                const historyHTML =
                    items.length === 0
                        ? emptyHTML
                        : items
                              .map((playlist, index) => {
                                  // Find actual index in main history array for deletion
                                  const originalIndex =
                                      playlistHistory.findIndex(
                                          (p) => p.id === playlist.id,
                                      );
                                  const thumbnailUrl =
                                      playlist.thumbnail ||
                                      `https://img.youtube.com/vi/default/mqdefault.jpg`;
                                  const channelName =
                                      playlist.channel || "Unknown Channel";
                                  return `
                    <div class="glass rounded-lg p-2 cursor-pointer card-hover group history-item relative"
                         data-index="${originalIndex}">
                        <div class="flex gap-2">
                            <div class="flex-shrink-0 w-16 h-10 rounded overflow-hidden bg-slate-200">
                                <img src="${thumbnailUrl}"
                                     class="w-full h-full object-cover"
                                     alt=""
                                     onerror="this.src='https://img.youtube.com/vi/default/mqdefault.jpg'">
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="font-medium text-xs line-clamp-2 text-custom-main group-hover:text-blue-600 transition pr-6">${escapeHtml(playlist.title)}</p>
                                <div class="flex items-center justify-between mt-1 text-[10px] text-custom-muted">
                                    <span class="flex items-center gap-1">
                                        <i class="fas fa-video text-blue-400"></i>
                                        ${playlist.videoCount}
                                    </span>
                                    <span class="flex items-center gap-1">
                                        <i class="fas fa-user-circle"></i>
                                        ${escapeHtml(channelName)}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <button class="remove-history-btn absolute top-1 right-1 text-custom-muted hover:text-red-500 hover:bg-red-50 rounded p-1 transition"
                                data-id="${playlist.id}" title="Remove from history">
                            <i class="fas fa-times text-[10px]"></i>
                        </button>
                    </div>
                `;
                              })
                              .join("");

                document.getElementById("playlist-history").innerHTML =
                    historyHTML;
                document.getElementById("playlist-history-mobile").innerHTML =
                    historyHTML;

                // Add click event listeners for history items
                document.querySelectorAll(".history-item").forEach((item) => {
                    item.addEventListener("click", async function (e) {
                        if (e.target.closest(".remove-history-btn")) return;

                        // Prevent double-clicks
                        if (this.dataset.loading === "true") return;
                        this.dataset.loading = "true";

                        const index = parseInt(this.dataset.index);

                        try {
                            await loadFromHistory(index);
                        } finally {
                            this.dataset.loading = "false";
                        }
                    });
                });

                // Add click event listeners for remove buttons
                document
                    .querySelectorAll(".remove-history-btn")
                    .forEach((btn) => {
                        btn.addEventListener("click", function (e) {
                            e.stopPropagation();
                            const playlistId = this.dataset.id;
                            removeFromHistory(playlistId);
                        });
                    });
            }

            function escapeHtml(text) {
                const div = document.createElement("div");
                div.textContent = text;
                return div.innerHTML;
            }

            function stripHtml(html) {
                const div = document.createElement("div");
                div.innerHTML = html;
                return div.textContent || div.innerText || "";
            }

            async function loadFromHistory(index) {
                if (index >= 0 && index < playlistHistory.length) {
                    const playlist = playlistHistory[index];

                    // Show loading state on the clicked item
                    const historyItems = document.querySelectorAll(
                        `.history-item[data-index="${index}"]`,
                    );
                    historyItems.forEach((item) => {
                        item.style.opacity = "0.6";
                        item.style.pointerEvents = "none";
                    });

                    try {
                        showPage("main");
                        await loadPlaylist(playlist.url);
                    } finally {
                        // Reset loading state
                        historyItems.forEach((item) => {
                            item.style.opacity = "";
                            item.style.pointerEvents = "";
                        });
                    }
                }
            }

            function removeFromHistory(playlistId) {
                playlistHistory = playlistHistory.filter(
                    (p) => p.id !== playlistId,
                );
                setCookie(
                    "yt_playlist_history",
                    JSON.stringify(playlistHistory),
                );
                filterHistory(); // Re-render respecting search
            }

            function togglePlaylistHistory() {
                const sidebar = document.getElementById(
                    "playlist-history-sidebar",
                );
                const mainPage = document.getElementById("main-page");
                const historyContent =
                    document.getElementById("playlist-history");
                const searchDiv = document.querySelector(
                    "#playlist-history-sidebar .mt-3.relative",
                ); // Search input div
                const toggleIcon = document.getElementById(
                    "history-toggle-icon",
                );
                const collapsedToggleBtn = document.querySelector(
                    ".collapsed-toggle-btn",
                );

                // Toggle the collapsed class on the sidebar
                sidebar.classList.toggle("collapsed");

                if (sidebar.classList.contains("collapsed")) {
                    // When collapsed, hide the history content but keep header and settings dock visible
                    historyContent.style.display = "none";
                    searchDiv.style.display = "none";

                    // Update the toggle icon to point right when collapsed
                    toggleIcon.classList.remove("fa-chevron-left");
                    toggleIcon.classList.add("fa-chevron-right");

                    // Show the center toggle button
                    if (collapsedToggleBtn) {
                        collapsedToggleBtn.classList.remove("hidden");
                    }

                    // Add class to main page to indicate sidebar is collapsed
                    mainPage.classList.add("sidebar-collapsed");
                } else {
                    // When expanded, show the history content
                    historyContent.style.display = "block";
                    searchDiv.style.display = "block";

                    // Update the toggle icon to point left when expanded
                    toggleIcon.classList.remove("fa-chevron-right");
                    toggleIcon.classList.add("fa-chevron-left");

                    // Hide the center toggle button
                    if (collapsedToggleBtn) {
                        collapsedToggleBtn.classList.add("hidden");
                    }

                    // Remove class from main page to indicate sidebar is expanded
                    mainPage.classList.remove("sidebar-collapsed");
                }

                // Ensure the collapsible button is properly visible after toggle
                setTimeout(() => {
                    ensureCollapsibleButtonVisible();
                }, 50);
            }

            // Allow clicking on the entire header when collapsed to expand
            document.addEventListener("DOMContentLoaded", function () {
                const header = document.querySelector(
                    "#playlist-history-sidebar .p-4.border-b.border-custom.bg-custom-card",
                );
                if (header) {
                    header.addEventListener("click", function (e) {
                        // Only expand if the sidebar is collapsed and the click wasn't on the toggle button
                        if (
                            this.closest(
                                "#playlist-history-sidebar",
                            ).classList.contains("collapsed") &&
                            !e.target.closest("button")
                        ) {
                            togglePlaylistHistory();
                        }
                    });
                }
            });

            function toggleMobilePlaylistHistory() {
                const historyContainer = document.getElementById(
                    "playlist-history-mobile",
                );
                const toggleIcon = document.getElementById(
                    "mobile-history-toggle-icon",
                );

                historyContainer.classList.toggle("open");

                if (historyContainer.classList.contains("open")) {
                    toggleIcon.classList.remove("fa-chevron-left");
                    toggleIcon.classList.add("fa-chevron-down");
                    toggleIcon.style.transform = "rotate(0deg)";
                } else {
                    toggleIcon.classList.remove("fa-chevron-down");
                    toggleIcon.classList.add("fa-chevron-left");
                    toggleIcon.style.transform = "rotate(-90deg)";
                }
            }

            function clearHistory() {
                if (
                    confirm(
                        "Are you sure you want to clear all playlist history? This will NOT delete your API key.",
                    )
                ) {
                    playlistHistory = [];
                    deleteCookie("yt_playlist_history");
                    document.getElementById("history-search").value = ""; // Clear search
                    document.getElementById("history-search-mobile").value = "";
                    renderPlaylistHistory();
                    showMessage("Playlist history cleared", "success");
                }
            }

            function clearLiveVideos() {
                if (
                    confirm(
                        "Are you sure you want to clear all live videos from My Live playlist?",
                    )
                ) {
                    // Only clear if the current playlist is "My Live"
                    if (
                        currentPlaylist.length > 0 &&
                        currentPlaylist[0].title === "My Live"
                    ) {
                        currentPlaylist = [];
                        renderVideoList();
                        document.getElementById("video-count").textContent =
                            "0 videos";
                        document.getElementById(
                            "video-count-mobile",
                        ).textContent = "0 videos";
                        document.getElementById("playlist-title").textContent =
                            "My Live";
                        document.getElementById(
                            "playlist-title-mobile",
                        ).textContent = "My Live";
                        showMessage("My Live playlist cleared", "success");

                        // Hide the live videos panel
                        document
                            .getElementById("live-videos-panel")
                            .classList.add("hidden");
                    }
                }
            }

            function updateLiveVideosPanel() {
                const liveVideosPanel =
                    document.getElementById("live-videos-panel");
                const liveVideosList =
                    document.getElementById("live-videos-list");

                // Check if current playlist is "My Live"
                if (
                    currentPlaylist.length > 0 &&
                    currentPlaylist[0].title === "My Live"
                ) {
                    // Show the live videos panel
                    liveVideosPanel.classList.remove("hidden");

                    // Clear the current list
                    liveVideosList.innerHTML = "";

                    // Add each live video to the panel
                    currentPlaylist.forEach((video, index) => {
                        const videoElement = document.createElement("div");
                        videoElement.className =
                            "live-video-item glass p-2 rounded-lg cursor-pointer card-hover flex gap-2 items-center";
                        videoElement.onclick = () => playVideo(index);

                        videoElement.innerHTML = `
                        <img src="${video.thumbnail}" alt="${escapeHtml(video.title)}" class="w-12 h-9 object-cover rounded shadow-sm bg-slate-200">
                        <div class="flex-1 min-w-0">
                            <p class="text-xs font-medium line-clamp-1 text-custom-main leading-snug">${escapeHtml(video.title)}</p>
                            <p class="text-[10px] text-custom-muted truncate">${escapeHtml(video.channel)}</p>
                        </div>
                        <button onclick="event.stopPropagation(); removeLiveVideo(${index})" class="w-6 h-6 rounded-full bg-[var(--bg-card)] border border-[var(--border-color)] text-[var(--text-muted)] flex items-center justify-center hover:bg-red-500 hover:text-white transition-colors" title="Remove from My Live">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                    `;

                        liveVideosList.appendChild(videoElement);
                    });
                } else {
                    // Hide the live videos panel if not "My Live" playlist
                    liveVideosPanel.classList.add("hidden");
                }
            }

            function removeLiveVideo(index) {
                if (
                    currentPlaylist.length > 0 &&
                    currentPlaylist[0].title === "My Live"
                ) {
                    // Remove the video from the playlist
                    currentPlaylist.splice(index, 1);

                    // Update the UI
                    renderVideoList();
                    document.getElementById("video-count").textContent =
                        `${currentPlaylist.length} videos`;
                    document.getElementById("video-count-mobile").textContent =
                        `${currentPlaylist.length} videos`;

                    // Update the live videos panel
                    updateLiveVideosPanel();

                    showMessage(
                        "Video removed from My Live playlist",
                        "success",
                    );
                }
            }

            // UI Helpers
            function showMessage(message, type = "info") {
                const el = document.getElementById("error-message");
                el.textContent = message;
                el.classList.remove(
                    "hidden",
                    "text-red-600",
                    "text-green-600",
                    "text-blue-600",
                );
                el.style.background = "";
                el.style.border = "";

                if (type === "error") {
                    el.classList.add("text-red-600");
                    el.style.background = "#fef2f2";
                    el.style.border = "1px solid #fee2e2";
                } else if (type === "success") {
                    el.classList.add("text-green-600");
                    el.style.background = "#f0fdf4";
                    el.style.border = "1px solid #bbf7d0";
                } else {
                    el.classList.add("text-blue-600");
                    el.style.background = "#eff6ff";
                    el.style.border = "1px solid #bfdbfe";
                }
            }

            function hideMessage() {
                document
                    .getElementById("error-message")
                    .classList.add("hidden");
            }

            // YouTube API Ready callback
            function onYouTubeIframeAPIReady() {
                console.log("YouTube API Ready");
            }

            // Mobile Fullscreen Mode
            let isFullscreen = false;

            function toggleFullscreen() {
                const wrapper = document.getElementById("player-wrapper");
                const btn = document.getElementById("fullscreen-btn");
                const btnText = document.getElementById("fullscreen-text");
                const btnIcon = btn.querySelector("i");

                isFullscreen = !isFullscreen;

                if (isFullscreen) {
                    // Enter fullscreen
                    wrapper.classList.add("fullscreen-mode");
                    document.body.classList.add("player-fullscreen");
                    btnText.textContent = "Exit";
                    btnIcon.className = "fas fa-compress";

                    // Force landscape orientation on mobile
                    if (screen.orientation && screen.orientation.lock) {
                        screen.orientation
                            .lock("landscape")
                            .catch(function (err) {
                                console.log(
                                    "Orientation lock not supported:",
                                    err,
                                );
                            });
                    } else if (
                        screen.orientation &&
                        screen.orientation.angle !== undefined
                    ) {
                        // Alternative: try to rotate screen if API not available
                        console.log(
                            "Screen orientation API not available, trying alternative...",
                        );
                    }

                    // Force landscape via CSS for small screens
                    if (window.innerWidth < 768) {
                        document.body.style.transform = "rotate(90deg)";
                        document.body.style.transformOrigin = "center center";
                        document.body.style.width = "100vh";
                        document.body.style.height = "100vw";
                        document.body.style.overflow = "hidden";
                    }

                    // Also try native fullscreen API
                    if (wrapper.requestFullscreen) {
                        wrapper
                            .requestFullscreen()
                            .catch((err) => console.log(err));
                    } else if (wrapper.webkitRequestFullscreen) {
                        wrapper.webkitRequestFullscreen();
                    }
                } else {
                    // Exit fullscreen
                    exitFullscreenMode();
                }
            }

            function exitFullscreenMode() {
                const wrapper = document.getElementById("player-wrapper");
                const btn = document.getElementById("fullscreen-btn");
                const btnText = document.getElementById("fullscreen-text");
                const btnIcon = btn.querySelector("i");

                isFullscreen = false;
                wrapper.classList.remove("fullscreen-mode");
                document.body.classList.remove("player-fullscreen");
                btnText.textContent = "Fullscreen";
                btnIcon.className = "fas fa-expand";

                // Unlock orientation
                if (screen.orientation && screen.orientation.unlock) {
                    screen.orientation.unlock();
                }

                // Reset CSS transforms for small screens
                if (window.innerWidth < 768) {
                    document.body.style.transform = "";
                    document.body.style.transformOrigin = "";
                    document.body.style.width = "";
                    document.body.style.height = "";
                    document.body.style.overflow = "";
                }

                // Exit native fullscreen
                if (document.exitFullscreen) {
                    document.exitFullscreen().catch((err) => {});
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                }
            }

            // Listen for fullscreen change (e.g., user pressing Escape)
            document.addEventListener("fullscreenchange", function () {
                if (!document.fullscreenElement && isFullscreen) {
                    exitFullscreenMode();
                }
            });

            document.addEventListener("webkitfullscreenchange", function () {
                if (!document.webkitFullscreenElement && isFullscreen) {
                    exitFullscreenMode();
                }
            });

            // Exit fullscreen on back button / escape
            document.addEventListener("keydown", function (e) {
                if (e.key === "Escape" && isFullscreen) {
                    exitFullscreenMode();
                }
            });

            // ========== QUOTA TRACKING ==========
            // YouTube API Quota: 10,000 units per day per API key
            // Costs: Search = 100 units, Videos list = 1 unit, Playlists list = 1 unit, PlaylistItems = 1 unit
            const QUOTA_PER_KEY = 10000;
            const QUOTA_COSTS = {
                search: 100,
                videos: 1,
                playlists: 1,
                playlistItems: 1,
            };

            // Quota tracking per API key
            let quotaData = {
                date: new Date().toDateString(),
                keys: {}, // Format: { 'apiKeyPrefix': { used: 0, operations: [] } }
            };

            function loadQuota() {
                const savedQuota = getCookie("yt_quota_data");
                const today = new Date().toDateString();

                if (savedQuota) {
                    try {
                        const parsed = JSON.parse(savedQuota);
                        // Reset if it's a new day
                        if (parsed.date !== today) {
                            quotaData = { date: today, keys: {} };
                            saveQuotaData();
                        } else {
                            quotaData = parsed;
                        }
                    } catch (e) {
                        quotaData = { date: today, keys: {} };
                        saveQuotaData();
                    }
                } else {
                    quotaData = { date: today, keys: {} };
                    saveQuotaData();
                }
            }

            function saveQuotaData() {
                setCookie("yt_quota_data", JSON.stringify(quotaData));
            }

            function getApiKeyIdentifier(key) {
                // Create a short identifier from the API key (first 8 chars + last 4)
                if (!key || key.length < 12) return "unknown";
                return (
                    key.substring(0, 8) + "..." + key.substring(key.length - 4)
                );
            }

            function getCurrentKeyIdentifier() {
                const key = getCurrentApiKey();
                return key ? getApiKeyIdentifier(key) : null;
            }

            function addQuotaUsage(operation, count = 1) {
                const keyId = getCurrentKeyIdentifier();
                if (!keyId) return;

                const units = (QUOTA_COSTS[operation] || 1) * count;

                // Initialize key tracking if not exists
                if (!quotaData.keys[keyId]) {
                    quotaData.keys[keyId] = {
                        used: 0,
                        operations: {},
                    };
                }

                // Add to total
                quotaData.keys[keyId].used += units;

                // Track by operation type
                if (!quotaData.keys[keyId].operations[operation]) {
                    quotaData.keys[keyId].operations[operation] = {
                        count: 0,
                        units: 0,
                    };
                }
                quotaData.keys[keyId].operations[operation].count += count;
                quotaData.keys[keyId].operations[operation].units += units;

                saveQuotaData();
                updateQuotaDisplay();
            }

            function getTotalQuotaUsed() {
                let total = 0;
                Object.values(quotaData.keys).forEach((keyData) => {
                    total += keyData.used;
                });
                return total;
            }

            function getKeyQuotaUsage(keyId) {
                return quotaData.keys[keyId] || { used: 0, operations: {} };
            }

            function updateQuotaDisplay() {
                const section = document.getElementById("quota-section");
                const bar = document.getElementById("quota-bar");
                const text = document.getElementById("quota-text");
                const percent = document.getElementById("quota-percent");

                if (!section || apiKeys.length === 0) {
                    if (section) section.classList.add("hidden");
                    return;
                }

                section.classList.remove("hidden");

                // Calculate totals
                const totalUsed = getTotalQuotaUsed();
                const totalAvailable = apiKeys.length * QUOTA_PER_KEY;
                const percentUsed = Math.min(
                    (totalUsed / totalAvailable) * 100,
                    100,
                );

                // Update main display
                bar.style.width = percentUsed + "%";
                text.textContent = `${totalUsed.toLocaleString()} / ${totalAvailable.toLocaleString()} units (${apiKeys.length} key${apiKeys.length > 1 ? "s" : ""})`;
                percent.textContent = `${percentUsed.toFixed(1)}% used today`;

                // Change bar color based on usage
                bar.classList.remove(
                    "bg-green-500",
                    "bg-yellow-500",
                    "bg-orange-500",
                    "bg-red-500",
                );
                if (percentUsed < 50) {
                    bar.classList.add("bg-green-500");
                } else if (percentUsed < 75) {
                    bar.classList.add("bg-yellow-500");
                } else if (percentUsed < 90) {
                    bar.classList.add("bg-orange-500");
                } else {
                    bar.classList.add("bg-red-500");
                }

                // Update per-key details
                updateQuotaDetails();
            }

            function updateQuotaDetails() {
                let detailsHtml =
                    '<div class="mt-3 pt-3 border-t border-[var(--border-color)]">';
                detailsHtml +=
                    '<p class="text-[10px] font-semibold text-[var(--text-muted)] mb-2 uppercase tracking-wide">Per-Key Usage:</p>';

                apiKeys.forEach((key, index) => {
                    const keyId = getApiKeyIdentifier(key);
                    const usage = getKeyQuotaUsage(keyId);
                    const percent = Math.min(
                        (usage.used / QUOTA_PER_KEY) * 100,
                        100,
                    );
                    const isActive = index === currentKeyIndex;

                    // Calculate color based on usage
                    let colorClass = "bg-green-500";
                    if (percent >= 90) colorClass = "bg-red-500";
                    else if (percent >= 75) colorClass = "bg-orange-500";
                    else if (percent >= 50) colorClass = "bg-yellow-500";

                    detailsHtml += `
                    <div class="mb-2 ${isActive ? "opacity-100" : "opacity-70"}">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-[10px] text-[var(--text-main)] font-medium flex items-center gap-1">
                                ${isActive ? '<i class="fas fa-check-circle text-green-500"></i>' : ""}
                                Key ${index + 1}: ${keyId}
                            </span>
                            <span class="text-[10px] text-[var(--text-muted)]">${usage.used.toLocaleString()} / ${QUOTA_PER_KEY.toLocaleString()}</span>
                        </div>
                        <div class="w-full h-1.5 bg-[var(--bg-main)] rounded-full overflow-hidden">
                            <div class="h-full ${colorClass} transition-all duration-300" style="width: ${percent}%"></div>
                        </div>
                    </div>
                `;
                });

                // Show operation breakdown for current key
                const currentKeyId = getCurrentKeyIdentifier();
                if (currentKeyId && quotaData.keys[currentKeyId]) {
                    const ops = quotaData.keys[currentKeyId].operations;
                    if (Object.keys(ops).length > 0) {
                        detailsHtml +=
                            '<p class="text-[10px] font-semibold text-[var(--text-muted)] mt-3 mb-1 uppercase tracking-wide">Current Key Operations:</p>';
                        Object.entries(ops).forEach(([op, data]) => {
                            const opName =
                                op.charAt(0).toUpperCase() +
                                op.slice(1).replace(/([A-Z])/g, " $1");
                            detailsHtml += `
                            <div class="flex justify-between items-center text-[10px] py-0.5">
                                <span class="text-[var(--text-muted)]">${opName}</span>
                                <span class="text-[var(--text-main)]">${data.count} calls (${data.units} units)</span>
                            </div>
                        `;
                        });
                    }
                }

                detailsHtml += "</div>";

                // Insert or update details section
                const detailsId = "quota-details";
                let detailsEl = document.getElementById(detailsId);
                const quotaSection = document.getElementById("quota-section");
                if (!detailsEl && quotaSection) {
                    detailsEl = document.createElement("div");
                    detailsEl.id = detailsId;
                    quotaSection.appendChild(detailsEl);
                }
                if (detailsEl) {
                    detailsEl.innerHTML = detailsHtml;
                }
            }

            function resetQuota() {
                if (
                    confirm(
                        "Reset the quota counter for all API keys? This only resets the local display, not YouTube's actual quota.",
                    )
                ) {
                    quotaData = { date: new Date().toDateString(), keys: {} };
                    saveQuotaData();
                    updateQuotaDisplay();
                    showMessage("Quota counters reset for all keys", "success");
                }
            }

            // Helper function to wrap API calls with quota tracking
            function trackApiCall(operation, count = 1) {
                addQuotaUsage(operation, count);
            }

            // ========== LIVE STREAMS FUNCTIONALITY ==========
            let liveStreamsLoaded = false;
            let currentLiveCategory = "all";
            let liveNextPageToken = "";
            let currentLiveQuery = "";

            const liveCategories = {
                all: {
                    query: "",
                    title: "Trending Live Streams",
                    icon: "fa-fire",
                },
                gaming: {
                    query: "gaming live",
                    title: "Gaming Live Streams",
                    icon: "fa-gamepad",
                },
                music: {
                    query: "music live",
                    title: "Music Live Streams",
                    icon: "fa-music",
                },
                news: {
                    query: "news live",
                    title: "News Live Streams",
                    icon: "fa-newspaper",
                },
                sports: {
                    query: "sports live",
                    title: "Sports Live Streams",
                    icon: "fa-futbol",
                },
                technology: {
                    query: "technology live",
                    title: "Tech Live Streams",
                    icon: "fa-microchip",
                },
                entertainment: {
                    query: "entertainment live",
                    title: "Entertainment Live Streams",
                    icon: "fa-tv",
                },
            };

            function setLiveCategory(category) {
                currentLiveCategory = category;

                // Update button styling
                document
                    .querySelectorAll(".live-category-btn")
                    .forEach((btn) => {
                        const isActive = btn.dataset.category === category;
                        btn.classList.toggle("active", isActive);
                        btn.classList.toggle("bg-red-600", isActive);
                        btn.classList.toggle("text-white", isActive);
                        btn.classList.toggle("bg-[var(--bg-card)]", !isActive);
                        btn.classList.toggle(
                            "text-[var(--text-main)]",
                            !isActive,
                        );
                    });

                // Update section title
                const categoryInfo = liveCategories[category];
                document.getElementById("live-section-title").textContent =
                    categoryInfo.title;

                // Load streams for this category
                loadLiveCategory(category);
            }

            async function loadLiveCategory(category, pageToken = "") {
                const apiKey = getCurrentApiKey();

                if (!apiKey) {
                    showLiveError(
                        "Please add at least one API Key in the Player Settings first.",
                    );
                    return;
                }

                const categoryInfo = liveCategories[category];
                const container = document.getElementById("live-results");
                const loadMoreBtn = document.getElementById("live-load-more");

                if (!pageToken) {
                    container.innerHTML =
                        '<div class="col-span-full text-center py-20"><i class="fas fa-circle-notch fa-spin text-4xl text-red-600"></i><p class="mt-4 text-[var(--text-muted)]">Discovering live streams...</p></div>';
                    loadMoreBtn.classList.add("hidden");
                } else {
                    document.getElementById("btn-live-load-more").innerHTML =
                        '<i class="fas fa-circle-notch fa-spin"></i> Loading...';
                }

                try {
                    // Build search query for live streams
                    let searchQuery = categoryInfo.query || "";
                    if (category === "all") {
                        searchQuery = "live streaming";
                    }

                    const response = await fetch(
                        `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&eventType=live&q=${encodeURIComponent(searchQuery)}&maxResults=12&order=viewCount&key=${apiKey}${pageToken ? "&pageToken=" + pageToken : ""}`,
                    );

                    const data = await response.json();

                    if (data.error) {
                        if (
                            data.error.code === 403 &&
                            data.error.message.includes("quota")
                        ) {
                            if (rotateToNextApiKey()) {
                                loadLiveCategory(category, pageToken);
                                return;
                            }
                        }
                        throw new Error(data.error.message);
                    }

                    // Track search API usage (100 units)
                    trackApiCall("search", 1);

                    liveNextPageToken = data.nextPageToken || "";

                    if (!pageToken) {
                        container.innerHTML = "";
                        if (data.items.length === 0) {
                            container.innerHTML =
                                '<div class="col-span-full text-center py-20 text-[var(--text-muted)]"><i class="fas fa-satellite-dish text-4xl mb-4"></i><p>No live streams found for this category</p><p class="text-sm mt-2">Try selecting a different category</p></div>';
                            return;
                        }
                    }

                    // Get video IDs for stats
                    const videoIds = data.items
                        .map((item) => item.id.videoId)
                        .join(",");

                    // Fetch video details (duration, views, concurrent viewers if available)
                    const detailsResponse = await fetch(
                        `https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics,liveStreamingDetails&id=${videoIds}&key=${apiKey}`,
                    );

                    const detailsData = await detailsResponse.json();

                    // Track videos API usage (1 unit)
                    trackApiCall("videos", 1);

                    // Create map of video details
                    const videoDetailsMap = {};
                    if (detailsData.items) {
                        detailsData.items.forEach((item) => {
                            videoDetailsMap[item.id] = item;
                        });
                    }

                    // Render live stream cards
                    data.items.forEach((item) => {
                        const details = videoDetailsMap[item.id.videoId];
                        if (!details) return;

                        const card = createLiveStreamCard(item, details);
                        container.appendChild(card);
                    });

                    // Update count
                    const currentCount =
                        container.querySelectorAll(".live-stream-card").length;
                    document.getElementById("live-count").textContent =
                        `${currentCount} streams found`;

                    if (liveNextPageToken) {
                        loadMoreBtn.classList.remove("hidden");
                        document.getElementById(
                            "btn-live-load-more",
                        ).innerHTML = "Load More Streams";
                    } else {
                        loadMoreBtn.classList.add("hidden");
                    }
                } catch (error) {
                    showLiveError("Error: " + stripHtml(error.message));
                }
            }

            function createLiveStreamCard(item, details) {
                const el = document.createElement("div");
                el.className =
                    "live-stream-card glass rounded-xl overflow-hidden shadow-sm border border-[var(--border-color)] flex flex-col card-hover group";

                const thumbnail =
                    details.snippet.thumbnails.medium?.url ||
                    details.snippet.thumbnails.default?.url;
                const title = details.snippet.title;
                const channel = details.snippet.channelTitle;
                const concurrentViewers =
                    details.liveStreamingDetails?.concurrentViewers;

                el.innerHTML = `
                <div class="relative aspect-video bg-slate-800 overflow-hidden cursor-pointer" onclick="playLiveStream('${item.id.videoId}', '${escapeHtml(title)}', '${escapeHtml(channel)}')">
                    <img src="${thumbnail}" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 320 180%22><rect fill=%22%23334155%22 width=%22100%%22 height=%22100%%22/><text fill=%22%2394a3b8%22 x=%2250%%22 y=%2250%%22 text-anchor=%22middle%22>Live Stream">
                    <div class="absolute inset</text></svg>'-0 bg-gradient-to-t from-black/80 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                    <div class="absolute top-2 left-2 flex items-center gap-2">
                        <span class="px-2 py-1 rounded bg-red-600 text-white text-xs font-bold flex items-center gap-1 animate-pulse">
                            <span class="w-1.5 h-1.5 bg-white rounded-full"></span>
                            LIVE
                        </span>
                    </div>
                    ${concurrentViewers ? `
                    <div class="absolute bottom-2 right-2 px-2 py-1 rounded bg-black/70 text-white text-xs font-medium">
                        <i class="fas fa-user mr-1"></i>${formatViews(concurrentViewers)} watching
                    </div>
                    ` : ''}
                    <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                        <div class="w-16 h-16 rounded-full bg-red-600/90 flex items-center justify-center shadow-lg transform scale-75 group-hover:scale-100 transition-transform">
                            <i class="fas fa-play text-white text-2xl ml-1"></i>
                        </div>
                    </div>
                </div>
                <div class="p-4 flex flex-col flex-1">
                    <h3 class="font-bold text-[var(--text-main)] line-clamp-2 mb-2 text-sm md:text-base leading-snug">${escapeHtml(title)}</h3>
                    <div class="mt-auto flex items-center justify-between">
                        <p class="text-xs text-[var(--text-muted)] flex items-center gap-1 truncate flex-1">
                            <i class="fas fa-user-circle"></i>
                            <span class="truncate">${escapeHtml(channel)}</span>
                        </p>
                        <div class="relative ml-2">
                            <button onclick="event.stopPropagation(); addToPlaylistFromLive('${item.id.videoId}', '${escapeHtml(title)}', '${escapeHtml(channel)}', this)" class="btn-add w-7 h-7 rounded-full transition flex items-center justify-center shadow-sm add-to-playlist-btn" title="Add to Playlist">
                                <i class="fas fa-plus text-xs"></i>
                                <span class="added-text absolute inset-0 flex items-center justify-center bg-green-600 text-white rounded-full opacity-0 scale-0 transition-all duration-300">
                                    <i class="fas fa-check text-xs"></i>
                                </span>
                            </button>
                        </div>
                    </div>
                </div>
            `;

                return el;
            }

            function addToPlaylistFromLive(
                videoId,
                title,
                channel,
                buttonElement,
            ) {
                // Create a single-video "playlist" and add it to history
                const liveVideo = {
                    videoId: videoId,
                    title: title || "Live Stream",
                    thumbnail: `https://img.youtube.com/vi/${videoId}/mqdefault.jpg`,
                    channel: channel || "Unknown Channel",
                    publishedAt: new Date().toISOString(),
                    isLive: true, // Mark as live stream
                };

                // Add to current playlist if we're on the main page
                if (currentPlaylist.length > 0) {
                    // Check if current playlist is "My Live"
                    if (currentPlaylist[0].title === "My Live") {
                        // Add to existing "My Live" playlist
                        currentPlaylist.push(liveVideo);
                        renderVideoList();
                        showMessage(
                            "Live stream added to My Live playlist",
                            "success",
                        );

                        // Update UI
                        document.getElementById("video-count").textContent =
                            `${currentPlaylist.length} videos`;
                        document.getElementById(
                            "video-count-mobile",
                        ).textContent = `${currentPlaylist.length} videos`;
                    } else {
                        // If we already have a playlist, add this video to it
                        currentPlaylist.push(liveVideo);
                        renderVideoList();
                        showMessage(
                            "Live stream added to current playlist",
                            "success",
                        );

                        // Update video count
                        document.getElementById("video-count").textContent =
                            `${currentPlaylist.length} videos`;
                        document.getElementById(
                            "video-count-mobile",
                        ).textContent = `${currentPlaylist.length} videos`;
                    }
                } else {
                    // If no current playlist, create a new "My Live" playlist with this video
                    currentPlaylist = [liveVideo];
                    renderVideoList();

                    // Update UI
                    document.getElementById("playlist-title").textContent =
                        "My Live";
                    document.getElementById(
                        "playlist-title-mobile",
                    ).textContent = "My Live";
                    document.getElementById("video-count").textContent =
                        "1 video";
                    document.getElementById("video-count-mobile").textContent =
                        "1 video";

                    showMessage(
                        "Live stream added to My Live playlist",
                        "success",
                    );
                }

                // Don't add live videos to playlist history - only to My Live playlist
                // addToHistory(videoId, title, `https://www.youtube.com/watch?v=${videoId}`, 1, liveVideo.thumbnail, channel);

                // Trigger the animation on the button
                if (buttonElement) {
                    triggerAddAnimation(buttonElement);
                }

                // Update the live videos panel
                updateLiveVideosPanel();
            }

            function triggerAddAnimation(button) {
                const addIcon = button.querySelector(".fa-plus");
                const addedText = button.querySelector(".added-text");

                // Change the button to show "Added" with checkmark
                if (addIcon) {
                    addIcon.classList.remove("fa-plus");
                    addIcon.classList.add("fa-check");
                }

                // Show the added text with animation
                if (addedText) {
                    addedText.classList.remove("opacity-0", "scale-0");
                    addedText.classList.add("opacity-100", "scale-100");
                }

                // Change button color to green
                button.classList.remove("btn-add");
                button.classList.add("bg-green-600");

                // After 1.5 seconds, revert back to original state
                setTimeout(() => {
                    if (addIcon) {
                        addIcon.classList.remove("fa-check");
                        addIcon.classList.add("fa-plus");
                    }

                    if (addedText) {
                        addedText.classList.remove("opacity-100", "scale-100");
                        addedText.classList.add("opacity-0", "scale-0");
                    }

                    button.classList.remove("bg-green-600");
                    button.classList.add("btn-add");
                }, 1500);
            }

            function playLiveStream(videoId, title, channel) {
                console.log("Playing live stream:", videoId, title, channel);

                // Navigate to main page
                showPage("main");

                // Create or add to the "My Live" playlist
                if (
                    !currentPlaylist ||
                    currentPlaylist.length === 0 ||
                    currentPlaylist[0].title !== "My Live"
                ) {
                    // Create a new "My Live" playlist with this video
                    currentPlaylist = [
                        {
                            videoId: videoId,
                            title: title || "Live Stream",
                            thumbnail: `https://img.youtube.com/vi/${videoId}/mqdefault.jpg`,
                            channel: channel || "Unknown Channel",
                            publishedAt: new Date().toISOString(),
                            isLive: true, // Mark as live stream
                        },
                    ];

                    // Update UI for My Live playlist
                    document.getElementById("playlist-title").textContent =
                        "My Live";
                    document.getElementById(
                        "playlist-title-mobile",
                    ).textContent = "My Live";
                    document.getElementById("video-count").textContent =
                        "1 video";
                    document.getElementById("video-count-mobile").textContent =
                        "1 video";
                } else {
                    // Add to existing "My Live" playlist
                    const newVideo = {
                        videoId: videoId,
                        title: title || "Live Stream",
                        thumbnail: `https://img.youtube.com/vi/${videoId}/mqdefault.jpg`,
                        channel: channel || "Unknown Channel",
                        publishedAt: new Date().toISOString(),
                        isLive: true, // Mark as live stream
                    };

                    currentPlaylist.push(newVideo);

                    // Update UI
                    document.getElementById("video-count").textContent =
                        `${currentPlaylist.length} videos`;
                    document.getElementById("video-count-mobile").textContent =
                        `${currentPlaylist.length} videos`;
                }

                renderVideoList();
                updateLiveVideosPanel(); // Update the live videos panel

                // Force reset player before playing live stream
                if (player && typeof player.destroy === "function") {
                    try {
                        player.destroy();
                        player = null;
                    } catch (e) {
                        console.warn("Error destroying player:", e);
                    }
                }
                player = null;

                // Small delay to ensure clean state
                setTimeout(() => {
                    playVideo(currentPlaylist.length - 1); // Play the newly added video

                    // Show live chat toggle immediately for live streams
                    showLiveChatToggle();

                    showMessage("Playing live stream", "success");

                    // Ensure the collapsible button is properly visible after loading video
                    setTimeout(() => {
                        ensureCollapsibleButtonVisible();
                    }, 200);
                }, 150);
            }

            function searchLiveStreams() {
                const query = document
                    .getElementById("live-search-input")
                    .value.trim();
                if (!query) return;

                currentLiveQuery = query;
                liveNextPageToken = "";

                // Update section title
                document.getElementById("live-section-title").textContent =
                    `Search: "${query}"`;

                // Reset category buttons
                document
                    .querySelectorAll(".live-category-btn")
                    .forEach((btn) => {
                        btn.classList.remove(
                            "active",
                            "bg-red-600",
                            "text-white",
                        );
                        btn.classList.add(
                            "bg-[var(--bg-card)]",
                            "text-[var(--text-main)]",
                        );
                    });

                loadLiveSearch(query);
            }

            async function loadLiveSearch(query, pageToken = "") {
                const apiKey = getCurrentApiKey();

                if (!apiKey) {
                    showLiveError(
                        "Please add at least one API Key in the Player Settings first.",
                    );
                    return;
                }

                const container = document.getElementById("live-results");
                const loadMoreBtn = document.getElementById("live-load-more");

                if (!pageToken) {
                    container.innerHTML =
                        '<div class="col-span-full text-center py-20"><i class="fas fa-circle-notch fa-spin text-4xl text-red-600"></i><p class="mt-4 text-[var(--text-muted)]">Searching live streams...</p></div>';
                    loadMoreBtn.classList.add("hidden");
                }

                try {
                    const response = await fetch(
                        `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&eventType=live&q=${encodeURIComponent(query)}&maxResults=12&order=relevance&key=${apiKey}${pageToken ? "&pageToken=" + pageToken : ""}`,
                    );

                    const data = await response.json();

                    if (data.error) {
                        if (
                            data.error.code === 403 &&
                            data.error.message.includes("quota")
                        ) {
                            if (rotateToNextApiKey()) {
                                loadLiveSearch(query, pageToken);
                                return;
                            }
                        }
                        throw new Error(data.error.message);
                    }

                    // Track search API usage (100 units)
                    trackApiCall("search", 1);

                    liveNextPageToken = data.nextPageToken || "";

                    if (!pageToken) {
                        container.innerHTML = "";
                        if (data.items.length === 0) {
                            container.innerHTML =
                                '<div class="col-span-full text-center py-20 text-[var(--text-muted)]"><i class="fas fa-search text-4xl mb-4"></i><p>No live streams found for "' +
                                escapeHtml(query) +
                                '"</p><p class="text-sm mt-2">Try a different search term</p></div>';
                            return;
                        }
                    }

                    // Get video details
                    const videoIds = data.items
                        .map((item) => item.id.videoId)
                        .join(",");
                    const detailsResponse = await fetch(
                        `https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics,liveStreamingDetails&id=${videoIds}&key=${apiKey}`,
                    );

                    const detailsData = await detailsResponse.json();

                    // Track videos API usage (1 unit)
                    trackApiCall("videos", 1);
                    const videoDetailsMap = {};
                    if (detailsData.items) {
                        detailsData.items.forEach((item) => {
                            videoDetailsMap[item.id] = item;
                        });
                    }

                    // Render cards
                    data.items.forEach((item) => {
                        const details = videoDetailsMap[item.id.videoId];
                        if (!details) return;

                        const card = createLiveStreamCard(item, details);
                        container.appendChild(card);
                    });

                    // Update count
                    const currentCount =
                        container.querySelectorAll(".live-stream-card").length;
                    document.getElementById("live-count").textContent =
                        `${currentCount} streams found`;

                    if (liveNextPageToken) {
                        loadMoreBtn.classList.remove("hidden");
                        document.getElementById(
                            "btn-live-load-more",
                        ).innerHTML = "Load More Streams";
                    } else {
                        loadMoreBtn.classList.add("hidden");
                    }
                } catch (error) {
                    showLiveError("Error: " + stripHtml(error.message));
                }
            }

            function loadMoreLiveStreams() {
                if (liveNextPageToken) {
                    if (currentLiveQuery) {
                        loadLiveSearch(currentLiveQuery, liveNextPageToken);
                    } else {
                        loadLiveCategory(
                            currentLiveCategory,
                            liveNextPageToken,
                        );
                    }
                }
            }

            function showLiveError(message) {
                const container = document.getElementById("live-results");
                container.innerHTML = `<div class="col-span-full text-center text-red-500 py-10"><i class="fas fa-exclamation-triangle text-3xl mb-3"></i><p>${escapeHtml(message)}</p></div>`;
                document
                    .getElementById("live-load-more")
                    .classList.add("hidden");
            }

            // ========== LIVE CHAT FUNCTIONALITY ==========
            let isLiveChatOpen = false;
            let currentLiveChatVideoId = null;

            function toggleLiveChat() {
                const container = document.getElementById(
                    "live-chat-container-main",
                );
                const chevron = document.getElementById(
                    "live-chat-chevron-main",
                );
                const toggleText = document.getElementById(
                    "live-chat-toggle-text",
                );
                const chatSection =
                    document.getElementById("live-chat-section");

                isLiveChatOpen = !isLiveChatOpen;
                console.log(
                    "Toggling live chat:",
                    isLiveChatOpen ? "opening" : "closing",
                );

                if (isLiveChatOpen) {
                    container.style.maxHeight = "500px";
                    container.style.opacity = "1";
                    chevron.style.transform = "rotate(180deg)";
                    if (toggleText) toggleText.textContent = "Close Live Chat";
                    chatSection?.classList.add("chat-open");
                    chatSection?.classList.remove("chat-closed");
                    console.log("Chat container opened");

                    // Load chat if we have a video ID and it's different from current
                    const currentVideo = currentPlaylist[currentVideoIndex];
                    console.log("Current video for chat:", currentVideo);
                    if (
                        currentVideo &&
                        currentVideo.videoId !== currentLiveChatVideoId
                    ) {
                        console.log(
                            "Loading chat for video:",
                            currentVideo.videoId,
                        );
                        loadLiveChat(currentVideo.videoId);
                    } else if (!currentVideo) {
                        console.warn("No current video available for chat");
                    }
                } else {
                    container.style.maxHeight = "0";
                    container.style.opacity = "0";
                    chevron.style.transform = "rotate(0deg)";
                    if (toggleText) toggleText.textContent = "Open Live Chat";
                    chatSection?.classList.add("chat-closed");
                    chatSection?.classList.remove("chat-open");
                    console.log("Chat container closed");
                }
            }

            function loadLiveChat(videoId) {
                if (!videoId) {
                    console.warn("No video ID provided to loadLiveChat");
                    return;
                }

                console.log("Loading live chat for video:", videoId);
                currentLiveChatVideoId = videoId;

                // Load into main chat container
                const chatContainer = document.getElementById(
                    "live-chat-iframe-container-main",
                );
                if (chatContainer) {
                    // YouTube Live Chat embed URL
                    // Note: domain must be registered with YouTube for this to work properly
                    const chatUrl = `https://www.youtube.com/live_chat?v=${videoId}&embed_domain=${window.location.hostname}&dark_theme=1`;
                    console.log("Chat URL:", chatUrl);

                    chatContainer.innerHTML = `
                    <iframe
                        src="${chatUrl}"
                        frameborder="0"
                        allowfullscreen
                        style="width: 100%; height: 100%; border: none;"
                    ></iframe>
                `;
                    console.log("Chat iframe loaded");
                }
            }

            function clearLiveChat() {
                currentLiveChatVideoId = null;

                // Clear chat container
                const chatContainer = document.getElementById(
                    "live-chat-iframe-container-main",
                );
                if (chatContainer) {
                    chatContainer.innerHTML = "";
                }

                // Close the chat if it's open
                if (isLiveChatOpen) {
                    toggleLiveChat();
                }
            }

            function showLiveChatToggle() {
                // Show main chat section below video player
                const chatSection =
                    document.getElementById("live-chat-section");
                if (chatSection) {
                    chatSection.classList.remove("hidden");
                    console.log("Live chat section shown below video player");
                }
            }

            function hideLiveChatToggle() {
                // Hide main chat section
                const chatSection =
                    document.getElementById("live-chat-section");
                if (chatSection) {
                    chatSection.classList.add("hidden");
                    console.log("Live chat section hidden");
                }

                clearLiveChat();
            }

            // Check if current video is a live stream
            async function checkAndShowLiveChat() {
                const currentVideo = currentPlaylist[currentVideoIndex];
                if (!currentVideo || !currentVideo.videoId) {
                    hideLiveChatToggle();
                    return;
                }

                const apiKey = getCurrentApiKey();
                if (!apiKey) {
                    hideLiveChatToggle();
                    return;
                }

                // If video is already marked as live (from Live page), show chat immediately
                if (currentVideo.isLive) {
                    console.log("Video marked as live, showing chat toggle");
                    showLiveChatToggle();
                    return;
                }

                try {
                    console.log(
                        "Checking live status for video:",
                        currentVideo.videoId,
                    );
                    const response = await fetch(
                        `https://www.googleapis.com/youtube/v3/videos?part=snippet,liveStreamingDetails&id=${currentVideo.videoId}&key=${apiKey}`,
                    );
                    const data = await response.json();

                    // Track videos API usage (1 unit)
                    trackApiCall("videos", 1);

                    if (data.items && data.items.length > 0) {
                        const video = data.items[0];
                        const isLive =
                            video.snippet.liveBroadcastContent === "live";
                        const hasChat =
                            video.liveStreamingDetails &&
                            video.liveStreamingDetails.activeLiveChatId;

                        console.log("Live status check:", {
                            isLive,
                            hasChat,
                            broadcastContent:
                                video.snippet.liveBroadcastContent,
                        });

                        if (isLive && hasChat) {
                            showLiveChatToggle();
                        } else {
                            hideLiveChatToggle();
                        }
                    } else {
                        console.log("No video data found");
                        hideLiveChatToggle();
                    }
                } catch (error) {
                    console.warn("Could not check live status:", error);
                    hideLiveChatToggle();
                }
            }

            // Manual function to force show chat (for testing or if auto-detection fails)
            function forceShowChat() {
                const currentVideo = currentPlaylist[currentVideoIndex];
                if (currentVideo && currentVideo.videoId) {
                    showLiveChatToggle();
                    // Also try to load the chat immediately
                    if (!isLiveChatOpen) {
                        toggleLiveChat();
                    }
                    showMessage("Chat opened manually", "success");
                } else {
                    showMessage("No video currently playing", "error");
                }
            }

            // Alternative detection using player state
            function checkPlayerForLiveStream() {
                if (player && typeof player.getVideoData === "function") {
                    try {
                        const videoData = player.getVideoData();
                        console.log("Player video data:", videoData);
                        // YouTube player doesn't directly expose live status, but we can check title
                        if (videoData && videoData.title) {
                            // Check if this is the same video we think we're playing
                            const currentVideo =
                                currentPlaylist[currentVideoIndex];
                            if (currentVideo && currentVideo.isLive) {
                                showLiveChatToggle();
                            }
                        }
                    } catch (e) {
                        console.warn("Could not get player video data:", e);
                    }
                }
            }

            // ========== FLOATING CHAT FUNCTIONALITY ==========
            let isChatFloating = false;

            function toggleChatFloat() {
                const chatSection = document.getElementById("live-chat-section");
                const floatBtn = document.getElementById("chat-float-btn-header");
                const btnIcon = floatBtn ? floatBtn.querySelector("i") : null;
                const floatingChat = document.getElementById("live-chat-floating");

                isChatFloating = !isChatFloating;

                if (isChatFloating) {
                    // Show floating chat panel
                    floatingChat.classList.remove("hidden");
                    
                    if (floatBtn) {
                        floatBtn.classList.add("floating-active");
                        if (btnIcon) btnIcon.className = "fas fa-compress-alt";
                        floatBtn.title = "Dock chat below video";
                    }
                    document.body.classList.add("chat-floating");

                    // Load chat when floating
                    const currentVideo = currentPlaylist[currentVideoIndex];
                    if (currentVideo) {
                        loadLiveChatToFloating(currentVideo.videoId);
                    }
                } else {
                    // Hide floating chat panel
                    floatingChat.classList.add("hidden");
                    
                    if (floatBtn) {
                        floatBtn.classList.remove("floating-active");
                        if (btnIcon) btnIcon.className = "fas fa-external-link-alt";
                        floatBtn.title = "Float chat to right side";
                    }
                    document.body.classList.remove("chat-floating");

                    showMessage("Chat docked below video", "info");
                }
            }

            function loadLiveChatToFloating(videoId) {
                if (!videoId) return;
                
                const chatContainer = document.getElementById("live-chat-iframe-floating");
                if (chatContainer) {
                    const chatUrl = `https://www.youtube.com/live_chat?v=${videoId}&embed_domain=${window.location.hostname}&dark_theme=1`;
                    chatContainer.innerHTML = `<iframe src="${chatUrl}" frameborder="0" allowfullscreen style="width: 100%; height: 100%; border: none;"></iframe>`;
                }
            }

            // Scrollbar visibility on scroll
            let scrollTimeout;
            const scrollContainer = document.getElementById(
                "video-chat-scroll-container",
            );

            if (scrollContainer) {
                scrollContainer.addEventListener("scroll", () => {
                    scrollContainer.classList.add("scrolling");

                    clearTimeout(scrollTimeout);
                    scrollTimeout = setTimeout(() => {
                        scrollContainer.classList.remove("scrolling");
                    }, 1000);
                });
            }
        </script>

        <div
            id="chatbot-modal"
            class="fixed bottom-36 md:bottom-24 right-6 z-60 w-96 max-w-[calc(100vw-2rem)] h-[450px] max-h-[calc(100vh-10rem)] md:h-[500px] md:max-h-[calc(100vh-8rem)] rounded-2xl shadow-2xl hidden flex flex-col overflow-hidden"
            style="
                background: var(--bg-card);
                border: 1px solid var(--border-color);
            "
        >
            <div
                class="flex-shrink-0 p-4 flex items-center justify-between"
                style="background: var(--accent-color)"
            >
                <h3 class="font-semibold flex items-center gap-2 text-white">
                    <i class="fas fa-robot"></i> AI Assistant
                </h3>
                <button
                    onclick="toggleChatbot()"
                    class="p-1 rounded transition hover:opacity-80"
                    style="background: rgba(255, 255, 255, 0.2)"
                >
                    <i class="fas fa-times text-white"></i>
                </button>
            </div>
            <div
                id="chatbot-messages"
                class="flex-1 overflow-y-auto scrollbar-thin p-4 space-y-3 min-h-0"
                style="background: var(--bg-main)"
            ></div>
            <div
                class="flex-shrink-0 p-3 border-t"
                style="
                    border-color: var(--border-color);
                    background: var(--bg-card);
                "
            >
                <div class="flex gap-2 items-center">
                    <button
                        onclick="clearChatbotChat()"
                        class="p-2 rounded-full hover:bg-[var(--bg-hover)] transition"
                        style="color: var(--text-muted)"
                        title="Clear Chat"
                    >
                        <i class="fas fa-trash-alt"></i>
                    </button>
                    <input
                        type="text"
                        id="chatbot-input"
                        placeholder="Type a message..."
                        class="flex-1 px-4 py-2 rounded-full focus:outline-none"
                        style="
                            background: var(--bg-main);
                            border: 1px solid var(--border-color);
                            color: var(--text-main);
                        "
                    />
                    <button
                        onclick="sendChatbotMessage()"
                        class="px-4 py-2 rounded-full transition text-white"
                        style="background: var(--accent-color)"
                    >
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>

        <style>
            /* Chat page send button */
            #chat-page-send-btn {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            /* Chat message content styling */
            .chat-message-content {
                word-wrap: break-word;
            }
            .chat-message-content strong {
                font-weight: 600;
                color: var(--text-main);
            }
            .chat-message-content em {
                font-style: italic;
            }
            .chat-formatted-list {
                margin: 8px 0;
                padding-left: 20px;
                list-style: decimal;
            }
            .chat-list-item {
                margin: 4px 0;
                line-height: 1.5;
            }

            #chatbot-modal {
                animation: slideUp 0.3s ease;
            }
            @keyframes slideUp {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            .chatbot-message {
                max-width: 85%;
                padding: 10px 14px;
                border-radius: 16px;
                line-height: 1.5;
                white-space: pre-line;
                word-wrap: break-word;
            }
            .chatbot-user {
                background: var(--accent-color);
                color: white;
                align-self: flex-end;
                border-bottom-right-radius: 4px;
                margin-left: auto;
            }
            .chatbot-assistant {
                background: var(--bg-hover);
                color: var(--text-main);
                align-self: flex-start;
                border-bottom-left-radius: 4px;
            }
            .chatbot-typing {
                display: flex;
                gap: 4px;
                padding: 10px 14px;
                background: var(--bg-hover);
                border-radius: 16px;
                align-self: flex-start;
            }
            .chatbot-typing span {
                width: 8px;
                height: 8px;
                background: var(--text-muted);
                border-radius: 50%;
                animation: typing 1s infinite;
            }
            .chatbot-typing span:nth-child(2) {
                animation-delay: 0.2s;
            }
            .chatbot-typing span:nth-child(3) {
                animation-delay: 0.4s;
            }
            @keyframes typing {
                0%,
                100% {
                    opacity: 0.4;
                    transform: translateY(0);
                }
                50% {
                    opacity: 1;
                    transform: translateY(-4px);
                }
            }

            .typewriter-cursor {
                border-right: 2px solid var(--accent-color);
                animation: blink-cursor 0.8s step-end infinite;
            }
            @keyframes blink-cursor {
                50% {
                    border-color: transparent;
                }
            }

            #chatbot-modal {
                background: var(--bg-card);
                border: 1px solid var(--border-color);
            }
            #chatbot-modal > div:first-child {
                background: var(--accent-color) !important;
            }
            #chatbot-modal > div:first-child button:hover {
                background: var(--accent-hover) !important;
            }
            #chatbot-modal #chatbot-messages {
                background: var(--bg-main);
                min-height: 0;
                overflow-y: auto;
                flex-shrink: 1;
            }
            .chatbot-message {
                max-width: 85%;
                padding: 10px 14px;
                border-radius: 16px;
                line-height: 1.5;
                word-break: break-word;
                overflow-wrap: anywhere;
            }
            #chatbot-modal input {
                background: var(--bg-main);
                border: 1px solid var(--border-color);
                color: var(--text-main);
            }
            #chatbot-modal input:focus {
                border-color: var(--accent-color);
                outline: none;
            }
            #chatbot-modal > div:last-child {
                border-color: var(--border-color) !important;
                background: var(--bg-card) !important;
            }
            #chatbot-modal > div:last-child button:last-child {
                background: var(--accent-color) !important;
            }
            #chatbot-modal > div:last-child button:last-child:hover {
                background: var(--accent-hover) !important;
            }
            #chatbot-floating-btn {
                background: var(--accent-color) !important;
            }
            #chatbot-floating-btn:hover {
                background: var(--accent-hover) !important;
            }
        </style>

        <script>
            let chatbotMessages = JSON.parse(
                localStorage.getItem("chatbotMessages") || "[]",
            );

            // Clean up any stored messages with <br> tags
            let hasBrTags = chatbotMessages.some(
                (m) => m.content && m.content.includes("<br>"),
            );
            if (hasBrTags) {
                chatbotMessages = chatbotMessages.map((m) => {
                    if (m.content) {
                        m.content = m.content.replace(/<br\s*\/?>/gi, "\n");
                    }
                    return m;
                });
                localStorage.setItem(
                    "chatbotMessages",
                    JSON.stringify(chatbotMessages),
                );
            }

            let chatbotSettings = {};

            function loadChatbotSettings() {
                const cookieVal = getCookie("chatbotSettings");
                if (cookieVal) {
                    try {
                        chatbotSettings = JSON.parse(cookieVal);
                    } catch (e) {
                        chatbotSettings = {};
                    }
                } else {
                    const localSettings =
                        localStorage.getItem("chatbotSettings");
                    if (localSettings) {
                        try {
                            chatbotSettings = JSON.parse(localSettings);
                            setCookie("chatbotSettings", localSettings);
                        } catch (e) {
                            chatbotSettings = {};
                        }
                    }
                }
            }

            loadChatbotSettings();

            function toggleChatbot() {
                const modal = document.getElementById("chatbot-modal");
                modal.classList.toggle("hidden");
                if (!modal.classList.contains("hidden"))
                    renderChatbotMessages();
            }

            // Chat Page Functions
            let chatPageMessages = [];

            function autoResizeChatInput(textarea) {
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
            }

            function clearChat() {
                chatPageMessages = [];
                document.getElementById('chat-page-messages').innerHTML = `
                    <div class="flex items-start gap-3">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0" style="background: var(--accent-color)">
                            <i class="fas fa-robot text-white text-sm"></i>
                        </div>
                        <div class="rounded-2xl p-4 max-w-[80%]" style="background: var(--bg-card); border: 1px solid var(--border-color)">
                            <p style="color: var(--text-main); line-height: 1.6">
                                Chat cleared. How can I help you today?
                            </p>
                        </div>
                    </div>
                `;
            }

            function stripHtmlTags(text) {
                // Remove all HTML tags
                let clean = text.replace(/<[^>]*>/g, '');
                // Remove markdown asterisks for bold/italic
                clean = clean.replace(/\*\*/g, '').replace(/\*/g, '');
                // Clean up extra whitespace
                clean = clean.replace(/\n{3,}/g, '\n\n');
                return clean.trim();
            }

            function appendChatMessage(role, content) {
                const container = document.getElementById('chat-page-messages');
                const align = role === 'user' ? 'justify-end' : 'justify-start';
                
                const div = document.createElement('div');
                div.className = `flex items-start gap-3 ${align}`;
                
                // Strip HTML tags from content for clean display
                const cleanContent = stripHtmlTags(content);
                
                div.innerHTML = role === 'assistant' ? `
                    <div class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0" style="background: var(--accent-color)">
                        <i class="fas fa-robot text-white text-sm"></i>
                    </div>
                    <div class="rounded-2xl p-4 max-w-[85%]" style="background: var(--bg-card); border: 1px solid var(--border-color)">
                        <div class="chat-message-content" style="color: var(--text-main); line-height: 1.7; font-size: 14px; white-space: pre-wrap;"></div>
                    </div>
                ` : `
                    <div class="rounded-2xl p-4 max-w-[85%]" style="background: var(--accent-color); border: 1px solid transparent">
                        <p style="color: white; line-height: 1.6; white-space: pre-wrap;">${cleanContent}</p>
                    </div>
                `;
                container.appendChild(div);
                container.scrollTop = container.scrollHeight;

                // Typewriter effect for assistant messages
                if (role === 'assistant') {
                    const typingElement = div.querySelector('.chat-message-content');
                    typeWriter(typingElement, cleanContent, 0);
                }
            }

            function typeWriter(element, text, index) {
                if (index < text.length) {
                    element.textContent += text.charAt(index);
                    const container = document.getElementById('chat-page-messages');
                    container.scrollTop = container.scrollHeight;
                    setTimeout(() => typeWriter(element, text, index + 1), 12);
                }
            }

            async function sendChatMessage() {
                const input = document.getElementById('chat-page-input');
                const message = input.value.trim();
                if (!message) return;

                // Ollama doesn't require API key
                const provider = chatbotSettings.provider || "openai";
                
                // Check based on provider
                if (provider === "ollama") {
                    if (!chatbotSettings.apiUrl) {
                        appendChatMessage('assistant', 'Please configure your Ollama URL in Settings first. Go to Settings > Chatbot API to add your API URL.');
                        return;
                    }
                } else {
                    if (!chatbotSettings.apiKey || !chatbotSettings.apiUrl) {
                        appendChatMessage('assistant', 'Please configure your API key in Settings first. Go to Settings > Chatbot API to add your API key.');
                        return;
                    }
                }

                input.value = '';
                autoResizeChatInput(input);
                appendChatMessage('user', message);
                chatPageMessages.push({ role: 'user', content: message });
                
                // Show loading
                const container = document.getElementById('chat-page-messages');
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'flex items-start gap-3';
                loadingDiv.id = 'chat-page-loading';
                loadingDiv.innerHTML = `
                    <div class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0" style="background: var(--accent-color)">
                        <i class="fas fa-robot text-white text-sm"></i>
                    </div>
                    <div class="rounded-2xl p-4" style="background: var(--bg-card); border: 1px solid var(--border-color)">
                        <div class="flex items-center gap-2" style="color: var(--text-muted)">
                            <i class="fas fa-circle-notch fa-spin"></i>
                            <span>Thinking...</span>
                        </div>
                    </div>
                `;
                container.appendChild(loadingDiv);
                container.scrollTop = container.scrollHeight;

                try {
                    const provider = chatbotSettings.provider || "openai";
                    let response, url, body, headers;

                    if (provider === "ollama") {
                        // Ollama local API format
                        url = `${chatbotSettings.apiUrl}/api/chat`;
                        const model = chatbotSettings.model || "llama3";
                        const ollamaMessages = chatPageMessages.map((m) => ({
                            role: m.role === "user" ? "user" : "assistant",
                            content: m.content,
                        }));
                        headers = { "Content-Type": "application/json" };
                        body = JSON.stringify({
                            model: model,
                            messages: ollamaMessages,
                            stream: false,
                        });
                    } else if (provider === "ollama-cloud") {
                        // Ollama Cloud API format (like OpenAI)
                        url = `${chatbotSettings.apiUrl}/chat/completions`;
                        headers = {
                            "Content-Type": "application/json",
                            Authorization: `Bearer ${chatbotSettings.apiKey}`,
                        };
                        body = JSON.stringify({
                            model: chatbotSettings.model || "llama-3.3-70b-instruct",
                            messages: chatPageMessages.map((m) => ({
                                role: m.role === "user" ? "user" : "assistant",
                                content: m.content,
                            })),
                            temperature: 0.7,
                        });
                    } else if (provider === "gemini") {
                        const model = chatbotSettings.model || "gemini-1.5-flash";
                        url = `${chatbotSettings.apiUrl}/models/${model}:generateContent?key=${chatbotSettings.apiKey}`;
                        headers = { "Content-Type": "application/json" };
                        body = JSON.stringify({
                            contents: [{ parts: [{ text: message }] }],
                        });
                    } else {
                        url = `${chatbotSettings.apiUrl}/chat/completions`;
                        headers = {
                            "Content-Type": "application/json",
                            Authorization: `Bearer ${chatbotSettings.apiKey}`,
                        };
                        body = JSON.stringify({
                            model: chatbotSettings.model || "gpt-3.5-turbo",
                            messages: chatPageMessages.map((m) => ({
                                role: m.role === "user" ? "user" : "assistant",
                                content: m.content,
                            })),
                            temperature: 0.7,
                        });
                    }

                    response = await fetch(url, {
                        method: "POST",
                        headers,
                        body,
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        let errorMsg = errorData.error?.message || `HTTP ${response.status}`;
                        throw new Error(errorMsg);
                    }

                    const data = await response.json();
                    let reply;
                    if (provider === "ollama") {
                        reply = data.message?.content;
                    } else if (provider === "ollama-cloud") {
                        reply = data.choices?.[0]?.message?.content;
                    } else if (provider === "gemini") {
                        reply = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    } else {
                        reply = data.choices?.[0]?.message?.content;
                    }

                    document.getElementById('chat-page-loading')?.remove();
                    if (reply) {
                        appendChatMessage('assistant', reply);
                        chatPageMessages.push({ role: 'assistant', content: reply });
                    } else {
                        appendChatMessage('assistant', 'No response from API');
                    }
                } catch (error) {
                    document.getElementById('chat-page-loading')?.remove();
                    appendChatMessage('assistant', 'Sorry, I encountered an error: ' + error.message);
                }
            }

            function toggleChatbotApiSection() {
                const section = document.getElementById("chatbot-api-section");
                const chevron = document.getElementById("chatbot-api-chevron");
                const isOpen = !section.classList.contains("hidden");
                section.classList.toggle("hidden");
                chevron.classList.toggle("rotate-180");
                setCookie("yt_chatbot_api_section_open", isOpen ? "0" : "1");
            }

            function updateChatbotEndpointHint() {
                const provider =
                    document.getElementById("chatbot-provider").value;
                const urls = {
                    openai: "https://api.openai.com/v1",
                    anthropic: "https://api.anthropic.com/v1",
                    deepseek: "https://api.deepseek.com/v1",
                    gemini: "https://generativelanguage.googleapis.com/v1beta",
                    ollama: "http://localhost:11434",
                    "ollama-cloud": "https://api.ollama.com/v1",
                    openrouter: "https://openrouter.ai/api/v1",
                    custom: "",
                };
                
                // Show/hide URL and API key fields based on provider
                const urlField = document.getElementById("chatbot-url-field");
                const keyField = document.getElementById("chatbot-key-field");
                
                if (provider === "ollama") {
                    // Ollama local - no URL or API key needed
                    urlField.classList.add("hidden");
                    keyField.classList.add("hidden");
                } else {
                    // All other providers need URL and API key
                    urlField.classList.remove("hidden");
                    keyField.classList.remove("hidden");
                    document.getElementById("chatbot-api-url").value =
                        urls[provider] || "";
                }
                
                updateChatbotModels();
            }

            const chatbotModels = {
                openai: [
                    { value: "gpt-5.2", label: "GPT-5.2 (Complex reasoning)" },
                    { value: "gpt-5-mini", label: "GPT-5 Mini (Everyday chat)" },
                    { value: "gpt-5-nano", label: "GPT-5 Nano (Lightweight)" },
                    { value: "gpt-4.1", label: "GPT-4.1 (General-purpose)" },
                    { value: "gpt-oss-20b", label: "GPT-OSS 20B (Open source)" },
                    { value: "gpt-oss-120b", label: "GPT-OSS 120B (Advanced)" },
                    { value: "gpt-4o", label: "GPT-4o" },
                    { value: "gpt-4o-mini", label: "GPT-4o Mini" },
                    { value: "gpt-4-turbo", label: "GPT-4 Turbo" },
                    { value: "gpt-4", label: "GPT-4" },
                    { value: "gpt-3.5-turbo", label: "GPT-3.5 Turbo" },
                ],
                anthropic: [
                    {
                        value: "claude-sonnet-4-20250514",
                        label: "Claude Sonnet 4",
                    },
                    {
                        value: "claude-haiku-3-20250507",
                        label: "Claude Haiku 3",
                    },
                    { value: "claude-opus-4-20250514", label: "Claude Opus 4" },
                    {
                        value: "claude-3-7-sonnet-20250519",
                        label: "Claude 3.7 Sonnet",
                    },
                    {
                        value: "claude-3-5-sonnet-20241022",
                        label: "Claude 3.5 Sonnet",
                    },
                ],
                deepseek: [
                    { value: "deepseek-chat", label: "DeepSeek Chat" },
                    { value: "deepseek-reasoner", label: "DeepSeek Reasoner" },
                ],
                gemini: [
                    { value: "gemini-3.5-pro", label: "Gemini 3.5 Pro" },
                    { value: "gemini-3.0-pro", label: "Gemini 3.0 Pro" },
                    { value: "gemini-2.5-pro", label: "Gemini 2.5 Pro" },
                    { value: "gemini-2.5-flash", label: "Gemini 2.5 Flash" },
                    {
                        value: "gemini-2.0-flash-exp",
                        label: "Gemini 2.0 Flash (Exp)",
                    },
                    { value: "gemini-1.5-pro", label: "Gemini 1.5 Pro" },
                    { value: "gemini-1.5-flash", label: "Gemini 1.5 Flash" },
                ],
                ollama: [
                    { value: "llama3.3:70b", label: "Llama 3.3 70B" },
                    { value: "llama3.2:90b", label: "Llama 3.2 90B" },
                    { value: "llama3.2:11b", label: "Llama 3.2 11B" },
                    { value: "llama3.2:11b-vision", label: "Llama 3.2 Vision 11B" },
                    { value: "llama3.1:70b", label: "Llama 3.1 70B" },
                    { value: "llama3.1:405b", label: "Llama 3.1 405B" },
                    { value: "mistral-small:3.1", label: "Mistral Small 3.1" },
                    { value: "phi4", label: "Phi-4" },
                    { value: "phi3.5:14b", label: "Phi-3.5 14B" },
                    { value: "qwen2.5:72b", label: "Qwen 2.5 72B" },
                    { value: "qwen2.5:32b", label: "Qwen 2.5 32B" },
                    { value: "qwen2.5-coder:32b", label: "Qwen 2.5 Coder 32B" },
                    { value: "gemma2:27b", label: "Gemma 2 27B" },
                    { value: "gemma2:9b", label: "Gemma 2 9B" },
                    { value: "deepseek-coder-v2:236b", label: "DeepSeek Coder V2" },
                    { value: "deepseek-v2:236b", label: "DeepSeek V2" },
                    { value: "codellama:70b", label: "CodeLlama 70B" },
                    { value: "mixtral:8x22b", label: "Mixtral 8x22B" },
                    { value: "qwen2:72b", label: "Qwen 2 72B" },
                    { value: "granite3:8b", label: "Granite 3 8B" },
                    { value: "command-r:35b", label: "Command R 35B" },
                    { value: "aya:35b", label: "Aya 35B" },
                ],
                "ollama-cloud": [
                    { value: "llama-3.3-70b-instruct", label: "Llama 3.3 70B" },
                    { value: "llama-3.2-90b-instruct", label: "Llama 3.2 90B" },
                    { value: "llama-3.2-11b-vision-instruct", label: "Llama 3.2 Vision" },
                    { value: "llama-3.1-70b-instruct", label: "Llama 3.1 70B" },
                    { value: "mistral-small-3.1-24b-instruct", label: "Mistral Small 3.1" },
                    { value: "phi-4", label: "Phi-4" },
                    { value: "phi-3.5-mini-instruct", label: "Phi-3.5 Mini" },
                    { value: "qwen2.5-72b-instruct", label: "Qwen 2.5 72B" },
                    { value: "qwen2.5-32b-instruct", label: "Qwen 2.5 32B" },
                    { value: "qwen2.5-coder-32b-instruct", label: "Qwen 2.5 Coder" },
                    { value: "gemma-2-27b-instruct", label: "Gemma 2 27B" },
                    { value: "gemma-2-9b-instruct", label: "Gemma 2 9B" },
                    { value: "deepseek-coder-v2", label: "DeepSeek Coder V2" },
                    { value: "deepseek-chat-v2", label: "DeepSeek Chat V2" },
                    { value: "codellama-70b-instruct", label: "CodeLlama 70B" },
                    { value: "mixtral-8x22b-instruct", label: "Mixtral 8x22B" },
                    { value: "qwen2-72b-instruct", label: "Qwen 2 72B" },
                    { value: "granite-3-8b-instruct", label: "Granite 3 8B" },
                    { value: "command-r-35b-instruct", label: "Command R 35B" },
                    { value: "aya-35b-instruct", label: "Aya 35B" },
                ],
                openrouter: [
                    { value: "openrouter/auto", label: "Auto (Best)" },
                    { value: "meta-llama/llama-3.3-70b-instruct", label: "Llama 3.3 70B" },
                    { value: "meta-llama/llama-3.1-70b-instruct", label: "Llama 3.1 70B" },
                    { value: "qwen/qwen-2.5-72b-instruct", label: "Qwen 2.5 72B" },
                    { value: "mistralai/mistral-small-3.1-24b-instruct", label: "Mistral Small 3.1" },
                    { value: "deepseek/deepseek-chat", label: "DeepSeek Chat" },
                    { value: "google/gemma-2-27b-instruct", label: "Gemma 2 27B" },
                ],
                custom: [],
            };

            function updateChatbotModels() {
                const provider =
                    document.getElementById("chatbot-provider").value;
                const dropdown = document.getElementById(
                    "chatbot-model-dropdown",
                );
                const label = document.getElementById("chatbot-model-label");
                const models = chatbotModels[provider] || [];

                dropdown.innerHTML = models
                    .map(
                        (m) =>
                            `<div class="px-2 py-1 text-[10px] hover:bg-[var(--bg-hover)] cursor-pointer" onclick="selectChatbotModel('${m.value}', '${m.label}')">${m.label}</div>`,
                    )
                    .join("");

                if (models.length > 0) {
                    const savedModel = chatbotSettings.model;
                    const savedLabel =
                        models.find((m) => m.value === savedModel)?.label ||
                        models[0].label;
                    const savedValue = savedModel || models[0].value;
                    label.textContent = savedLabel;
                    document.getElementById("chatbot-model").value = savedValue;
                } else {
                    label.textContent = "Custom Model";
                    document.getElementById("chatbot-model").value = "";
                }
            }

            function toggleChatbotModelDropdown() {
                const dropdown = document.getElementById(
                    "chatbot-model-dropdown",
                );
                const chevron = document.getElementById(
                    "chatbot-model-chevron",
                );
                dropdown.classList.toggle("hidden");
                chevron.classList.toggle("rotate-180");
            }

            function selectChatbotModel(value, label) {
                document.getElementById("chatbot-model").value = value;
                document.getElementById("chatbot-model-label").textContent =
                    label;
                document
                    .getElementById("chatbot-model-dropdown")
                    .classList.add("hidden");
                document
                    .getElementById("chatbot-model-chevron")
                    .classList.remove("rotate-180");
            }

            function closeChatbotModelDropdown() {
                document
                    .getElementById("chatbot-model-dropdown")
                    .classList.add("hidden");
                document
                    .getElementById("chatbot-model-chevron")
                    .classList.remove("rotate-180");
            }

            function saveChatbotSettings() {
                const provider = document.getElementById("chatbot-provider").value;
                chatbotSettings = {
                    provider: provider,
                    apiUrl: document.getElementById("chatbot-api-url").value,
                    apiKey: document.getElementById("chatbot-api-key").value,
                    model: document.getElementById("chatbot-model").value,
                };
                localStorage.setItem(
                    "chatbotSettings",
                    JSON.stringify(chatbotSettings),
                );
                setCookie("chatbotSettings", JSON.stringify(chatbotSettings));
                const status = document.getElementById("chatbot-api-status");
                // Ollama is active if URL is set (no API key required)
                if (provider === "ollama" && chatbotSettings.apiUrl) {
                    status.textContent = "Active";
                    status.className =
                        "text-[8px] px-1.5 py-0.5 rounded-full bg-green-100 text-green-700";
                } else if (chatbotSettings.apiKey && chatbotSettings.apiUrl) {
                    status.textContent = "Active";
                    status.className =
                        "text-[8px] px-1.5 py-0.5 rounded-full bg-green-100 text-green-700";
                } else {
                    status.textContent = "Not Set";
                    status.className =
                        "text-[8px] px-1.5 py-0.5 rounded-full bg-gray-200 text-gray-600";
                }
                loadChatbotSettingsToInputs();
            }

            async function validateAndSaveChatbotAPI() {
                const provider =
                    document.getElementById("chatbot-provider").value;
                let apiUrl = document
                    .getElementById("chatbot-api-url")
                    .value.trim();
                const apiKey = document
                    .getElementById("chatbot-api-key")
                    .value.trim();
                const model = document.getElementById("chatbot-model").value;
                const errorDiv = document.getElementById("chatbot-error");
                const successDiv = document.getElementById("chatbot-success");

                errorDiv.classList.add("hidden");
                successDiv.classList.add("hidden");

                if (!apiUrl) {
                    if (provider === "ollama") {
                        showChatbotError("Please enter Ollama URL (e.g., http://localhost:11434)");
                    } else {
                        showChatbotError("Please enter API Base URL");
                    }
                    return;
                }
                // Ollama doesn't require API key
                if (!apiKey && provider !== "ollama") {
                    showChatbotError("Please enter API Key");
                    return;
                }
                if (!model) {
                    showChatbotError("Please select a Model");
                    return;
                }

                try {
                    let testUrl, headers, body;

                    if (provider === "ollama") {
                        // Ollama doesn't require API key
                        testUrl = `${apiUrl}/api/chat`;
                        headers = { "Content-Type": "application/json" };
                        body = JSON.stringify({
                            model: model,
                            messages: [{ role: "user", content: "Hi" }],
                            stream: false,
                        });
                    } else if (provider === "gemini") {
                        testUrl = `${apiUrl}/models/${model}:generateContent?key=${apiKey}`;
                        headers = { "Content-Type": "application/json" };
                        body = JSON.stringify({
                            contents: [{ parts: [{ text: "Hi" }] }],
                        });
                    } else if (provider === "anthropic") {
                        testUrl = `${apiUrl}/messages`;
                        headers = {
                            "Content-Type": "application/json",
                            "x-api-key": apiKey,
                            "anthropic-version": "2023-06-01",
                        };
                        body = JSON.stringify({
                            model,
                            max_tokens: 10,
                            messages: [{ role: "user", content: "Hi" }],
                        });
                    } else {
                        testUrl = `${apiUrl}/chat/completions`;
                        headers = {
                            "Content-Type": "application/json",
                            Authorization: `Bearer ${apiKey}`,
                        };
                        body = JSON.stringify({
                            model,
                            messages: [{ role: "user", content: "Hi" }],
                        });
                    }

                    const response = await fetch(testUrl, {
                        method: "POST",
                        headers,
                        body,
                    });

                    if (response.ok) {
                        // Save settings first
                        saveChatbotSettings();

                        // Then show success
                        successDiv.textContent =
                            "API validated and saved successfully!";
                        successDiv.classList.remove("hidden");
                        setTimeout(
                            () => successDiv.classList.add("hidden"),
                            3000,
                        );
                    } else {
                        const errorData = await response
                            .json()
                            .catch(() => ({}));
                        let errorMsg =
                            errorData.error?.message ||
                            errorData.message ||
                            `HTTP ${response.status}`;

                        if (
                            errorMsg.includes("api_key") ||
                            errorMsg.includes("API key") ||
                            errorMsg.includes("authentication") ||
                            errorMsg.includes("invalid")
                        ) {
                            errorMsg = "Invalid API key";
                        } else if (
                            errorMsg.includes("not found") ||
                            errorMsg.includes("NOT_FOUND")
                        ) {
                            errorMsg = "Model not found. Check model name.";
                        } else if (
                            errorMsg.includes("quota") ||
                            errorMsg.includes("QUOTA") ||
                            errorMsg.includes("rate limit")
                        ) {
                            errorMsg = "Quota exceeded";
                        }
                        showChatbotError(errorMsg);
                    }
                } catch (error) {
                    showChatbotError("Connection error: " + error.message);
                }
            }

            function loadChatbotSettingsToInputs() {
                const provider = chatbotSettings.provider || "openai";
                document.getElementById("chatbot-provider").value = provider;
                
                // Show/hide URL and API key fields based on provider
                const urlField = document.getElementById("chatbot-url-field");
                const keyField = document.getElementById("chatbot-key-field");
                
                if (provider === "ollama") {
                    // Ollama local - no URL or API key needed
                    urlField.classList.add("hidden");
                    keyField.classList.add("hidden");
                } else {
                    // All other providers need URL and API key
                    urlField.classList.remove("hidden");
                    keyField.classList.remove("hidden");
                    
                    const urls = {
                        openai: "https://api.openai.com/v1",
                        anthropic: "https://api.anthropic.com/v1",
                        deepseek: "https://api.deepseek.com/v1",
                        gemini: "https://generativelanguage.googleapis.com/v1beta",
                        ollama: "http://localhost:11434",
                        "ollama-cloud": "https://api.ollama.com/v1",
                        openrouter: "https://openrouter.ai/api/v1",
                        custom: "",
                    };
                    if (!chatbotSettings.apiUrl) {
                        document.getElementById("chatbot-api-url").value =
                            urls[provider] || "";
                    } else {
                        document.getElementById("chatbot-api-url").value =
                            chatbotSettings.apiUrl || "";
                    }
                    document.getElementById("chatbot-api-key").value =
                        chatbotSettings.apiKey || "";
                }
                
                updateChatbotModels();
            }

            function renderChatbotMessages() {
                const container = document.getElementById("chatbot-messages");
                container.innerHTML = chatbotMessages
                    .map((m) => {
                        const cleanContent = stripMarkdown(m.content);
                        return `<div class="chatbot-message ${m.role === "user" ? "chatbot-user" : "chatbot-assistant"}">${cleanContent}</div>`;
                    })
                    .join("");
                container.scrollTop = container.scrollHeight;
            }

            function stripMarkdown(text) {
                if (!text) return "";

                // Convert markdown to plain text (strip HTML tags)
                let cleaned = text
                    // Code blocks -> plain text
                    .replace(/```[\s\S]*?```/g, (match) =>
                        match.replace(/```|`/g, ""),
                    )
                    // Inline code -> plain text
                    .replace(/`([^`]+)`/g, "$1")
                    // Bold **text** -> plain text
                    .replace(/\*\*([^*]+)\*\*/g, "$1")
                    // Bold __text__ -> plain text
                    .replace(/__([^_]+)__/g, "$1")
                    // Italic *text* -> plain text
                    .replace(/\*([^*]+)\*/g, "$1")
                    // Italic _text_ -> plain text
                    .replace(/_([^_]+)_/g, "$1")
                    // Strikethrough ~~text~~ -> plain text
                    .replace(/~~([^~]+)~~/g, "$1")
                    // Links [text](url) -> text
                    .replace(/\[([^\]]+)\]\([^)]+\)/g, "$1")
                    // Unordered lists -> dash
                    .replace(/^\s*[-*+]\s/gm, "- ")
                    // Ordered lists -> number.
                    .replace(/^\s*\d+\.\s/gm, (match) => match)
                    // Horizontal rule
                    .replace(/^[\s]*[-*_]{3,}[\s]*$/gm, "")
                    // Headers -> plain text
                    .replace(/^### (.+)$/gm, "$1")
                    .replace(/^## (.+)$/gm, "$1")
                    .replace(/^# (.+)$/gm, "$1")
                    // Blockquotes ->
                    .replace(/^>\s+/gm, "")
                    // Strip any remaining HTML tags
                    .replace(/<[^>]+>/g, "")
                    // Clean up multiple newlines
                    .replace(/\n{3,}/g, "\n\n")
                    .trim();

                // Don't use <br> - CSS white-space: pre-line handles newlines
                return escapeHtml(cleaned);
            }

            function addChatbotMessage(role, content, useTypewriter = false) {
                chatbotMessages.push({ role, content });
                localStorage.setItem(
                    "chatbotMessages",
                    JSON.stringify(chatbotMessages),
                );

                const container = document.getElementById("chatbot-messages");
                const messageDiv = document.createElement("div");
                messageDiv.className = `chatbot-message ${role === "user" ? "chatbot-user" : "chatbot-assistant"}`;

                if (useTypewriter && role === "assistant") {
                    messageDiv.innerHTML =
                        '<span class="typewriter-cursor"></span>';
                    container.appendChild(messageDiv);
                    container.scrollTop = container.scrollHeight;

                    const cursor =
                        messageDiv.querySelector(".typewriter-cursor");
                    let index = 0;
                    const text = stripMarkdown(content);

                    function typeChar() {
                        if (index < text.length) {
                            cursor.textContent = text.substring(0, index + 1);
                            index++;
                            container.scrollTop = container.scrollHeight;
                            setTimeout(typeChar, 15 + Math.random() * 20);
                        } else {
                            cursor.replaceWith(document.createTextNode(text));
                        }
                    }

                    typeChar();
                } else {
                    messageDiv.innerHTML = stripMarkdown(content);
                    container.appendChild(messageDiv);
                    container.scrollTop = container.scrollHeight;
                }
            }

            function showChatbotTyping() {
                const container = document.getElementById("chatbot-messages");
                container.innerHTML +=
                    '<div class="chatbot-typing" id="chatbot-typing"><span></span><span></span><span></span></div>';
                container.scrollTop = container.scrollHeight;
            }

            function hideChatbotTyping() {
                const typing = document.getElementById("chatbot-typing");
                if (typing) typing.remove();
            }

            function clearChatbotChat() {
                chatbotMessages = [];
                localStorage.setItem(
                    "chatbotMessages",
                    JSON.stringify(chatbotMessages),
                );
                renderChatbotMessages();
            }

            async function sendChatbotMessage() {
                const input = document.getElementById("chatbot-input");
                const message = input.value.trim();
                if (!message) return;
                
                const provider = chatbotSettings.provider || "openai";
                
                // Check based on provider
                if (provider === "ollama") {
                    // Ollama local - URL required
                    if (!chatbotSettings.apiUrl) {
                        addChatbotMessage(
                            "assistant",
                            "Please configure your Ollama URL in Settings first.",
                            false,
                        );
                        return;
                    }
                } else if (provider !== "ollama-cloud") {
                    // All other providers (except ollama-cloud) need API key and URL
                    if (!chatbotSettings.apiKey || !chatbotSettings.apiUrl) {
                        addChatbotMessage(
                            "assistant",
                            "Please configure your API key in Settings first.",
                            false,
                        );
                        return;
                    }
                }
                
                input.value = "";
                addChatbotMessage("user", message);
                showChatbotTyping();

                const errorDiv = document.getElementById("chatbot-error");
                errorDiv.classList.add("hidden");

                try {
                    let response, url, body, headers;
                    const chatProvider = chatbotSettings.provider || "openai";

                    if (chatProvider === "ollama") {
                        // Ollama local API format
                        url = `${chatbotSettings.apiUrl}/api/chat`;
                        const model = chatbotSettings.model || "llama3";
                        const ollamaMessages = chatbotMessages.map((m) => ({
                            role: m.role === "user" ? "user" : "assistant",
                            content: m.content,
                        }));
                        headers = { "Content-Type": "application/json" };
                        body = JSON.stringify({
                            model: model,
                            messages: ollamaMessages,
                            stream: false,
                        });
                    } else if (chatProvider === "ollama-cloud") {
                        // Ollama Cloud API format (like OpenAI)
                        url = `${chatbotSettings.apiUrl}/chat/completions`;
                        headers = {
                            "Content-Type": "application/json",
                            Authorization: `Bearer ${chatbotSettings.apiKey}`,
                        };
                        body = JSON.stringify({
                            model: chatbotSettings.model || "llama-3.3-70b-instruct",
                            messages: chatbotMessages.map((m) => ({
                                role: m.role === "user" ? "user" : "assistant",
                                content: m.content,
                            })),
                            temperature: 0.7,
                        });
                    } else if (chatProvider === "gemini") {
                        const model =
                            chatbotSettings.model || "gemini-1.5-flash";
                        url = `${chatbotSettings.apiUrl}/models/${model}:generateContent?key=${chatbotSettings.apiKey}`;
                        headers = { "Content-Type": "application/json" };
                        body = JSON.stringify({
                            contents: [{ parts: [{ text: message }] }],
                        });
                    } else {
                        url = `${chatbotSettings.apiUrl}/chat/completions`;
                        headers = {
                            "Content-Type": "application/json",
                            Authorization: `Bearer ${chatbotSettings.apiKey}`,
                        };
                        body = JSON.stringify({
                            model: chatbotSettings.model || "gpt-3.5-turbo",
                            messages: chatbotMessages.map((m) => ({
                                role: m.role === "user" ? "user" : "assistant",
                                content: m.content,
                            })),
                            temperature: 0.7,
                        });
                    }

                    response = await fetch(url, {
                        method: "POST",
                        headers,
                        body,
                    });

                    if (!response.ok) {
                        const errorData = await response
                            .json()
                            .catch(() => ({}));
                        let errorMsg =
                            errorData.error?.message ||
                            `HTTP ${response.status}`;

                        if (
                            errorMsg.includes("not found") ||
                            errorMsg.includes("NOT_FOUND") ||
                            errorMsg.includes("not supported")
                        ) {
                            errorMsg =
                                "Model not found. Check model name in Settings.";
                            showChatbotError(errorMsg);
                        } else if (
                            errorMsg.includes("api_key") ||
                            errorMsg.includes("API key") ||
                            errorMsg.includes("authentication")
                        ) {
                            errorMsg =
                                "Invalid API key. Check your API key in Settings.";
                            showChatbotError(errorMsg);
                        } else if (
                            errorMsg.includes("quota") ||
                            errorMsg.includes("QUOTA") ||
                            errorMsg.includes("rate limit")
                        ) {
                            errorMsg = "API quota/rate limit exceeded.";
                            showChatbotError(errorMsg);
                        } else if (
                            errorMsg.includes("permission") ||
                            errorMsg.includes("PERMISSION_DENIED")
                        ) {
                            errorMsg =
                                "Permission denied. Check API key permissions.";
                            showChatbotError(errorMsg);
                        }
                        throw new Error(errorMsg);
                    }

                    const data = await response.json();

                    let reply;
                    if (chatProvider === "ollama") {
                        reply = data.message?.content;
                    } else if (chatProvider === "ollama-cloud") {
                        reply = data.choices?.[0]?.message?.content;
                    } else if (chatProvider === "gemini") {
                        reply = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    } else {
                        reply = data.choices?.[0]?.message?.content;
                    }

                    if (reply) {
                        hideChatbotTyping();
                        addChatbotMessage("assistant", reply, true);
                    } else throw new Error("No response from API");
                } catch (error) {
                    hideChatbotTyping();
                    addChatbotMessage("assistant", "Error: " + error.message);
                }
            }

            function showChatbotError(message) {
                const errorDiv = document.getElementById("chatbot-error");
                const successDiv = document.getElementById("chatbot-success");
                errorDiv.textContent = message;
                errorDiv.classList.remove("hidden");
                successDiv.classList.add("hidden");
            }

            document
                .getElementById("chatbot-input")
                .addEventListener("keypress", (e) => {
                    if (e.key === "Enter") sendChatbotMessage();
                });
            document
                .getElementById("chatbot-provider")
                .addEventListener("change", updateChatbotEndpointHint);

            document.addEventListener("click", function (e) {
                const dropdown = document.getElementById(
                    "chatbot-model-dropdown",
                );
                const btn = document.getElementById("chatbot-model-btn");
                if (
                    dropdown &&
                    btn &&
                    !dropdown.contains(e.target) &&
                    !btn.contains(e.target)
                ) {
                    dropdown.classList.add("hidden");
                    document
                        .getElementById("chatbot-model-chevron")
                        .classList.remove("rotate-180");
                }
            });

            // Initialize chatbot settings status
            loadChatbotSettingsToInputs();
            const status = document.getElementById("chatbot-api-status");
            if (chatbotSettings.apiKey && chatbotSettings.apiUrl) {
                status.textContent = "Active";
                status.className =
                    "text-[8px] px-1.5 py-0.5 rounded-full bg-green-100 text-green-700";
            }
            updateChatbotModels();
        </script>
    </body>
</html>
